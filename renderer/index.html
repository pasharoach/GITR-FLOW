<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ГИТР FLOW</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --success-color: #059669;
            --success-hover: #047857;
            --danger-color: #dc2626;
            --warning-color: #d97706;
            --text-danger: #ef4444;
            
            --bg-primary: #1e1e1e; /* Dark gray background like Cursor */
            --bg-secondary: #252526; /* Dark sidebar gray */
            --bg-tertiary: #2d2d30; /* Dark panel gray */
            --bg-sidebar: #252526; /* Dark sidebar gray */
            --bg-card: #1e1e1e; /* Dark main area gray */
            
            --text-primary: #cccccc; /* Light gray text for dark background */
            --text-secondary: #969696; /* Medium gray text */
            --text-muted: #6a6a6a; /* Dark gray text */
            --text-white: #ffffff;
            
            --border-color: #3c3c3c; /* Dark border color */
            --border-hover: #4a4a4a;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.4);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4), 0 4px 6px -4px rgb(0 0 0 / 0.4);
            
            --radius-sm: 0.25rem;
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
            
            --transition: all 0.15s ease-out;
        }
        
        body {
            font-family: 'SF Pro Display', 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.4;
            overflow: hidden;
            font-weight: 400;
            letter-spacing: -0.015em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Скрываем стандартные кнопки управления окном macOS */
        .titlebar {
            display: none !important;
        }

        /* Скрываем любые стандартные элементы управления окном */
        [data-tauri-drag-region] {
            display: none !important;
        }

        /* Скрываем стандартные кнопки управления окном */
        .window-controls,
        .titlebar-button,
        .titlebar-button-container,
        .titlebar-buttons {
            display: none !important;
        }

        /* Кнопки управления окном */
        .window-controls {
            position: fixed;
            top: 8px;
            left: 8px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            z-index: 1000;
            -webkit-app-region: no-drag;
        }

        .window-control {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            -webkit-app-region: no-drag;
        }

        .window-control-close {
            background: #ff5f57;
        }

        .window-control-close:hover {
            background: #ff4444;
        }

        .window-control-minimize {
            background: #febc2e;
        }

        .window-control-minimize:hover {
            background: #f0b020;
        }

        .window-control-maximize {
            background: #28c940;
        }

        .window-control-maximize:hover {
            background: #24b33a;
        }

        .window-control svg {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .window-control:hover svg {
            opacity: 1;
        }

        /* Кнопка закрытия в правом верхнем углу (только для Windows) */
        .app-close-btn {
            position: fixed;
            top: 8px;
            right: 8px;
            width: 18px;
            height: 18px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: normal;
            z-index: 1001;
            transition: var(--transition);
            -webkit-app-region: no-drag;
            pointer-events: auto;
        }

        .app-close-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--border-hover);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        /* Скрываем кнопку на macOS */
        .mac .app-close-btn {
            display: none;
        }

        /* Стили для горячих клавиш в настройках */
        .hotkey-hint {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: normal;
            margin-left: 8px;
        }

        .windows .hotkey-hint {
            content: "Ctrl + ";
        }

        /* Обновляем текст горячих клавиш для Windows */
        .windows .hotkey-hint {
            content: "Ctrl + ";
        }

        /* Серая полоска сверху */
        .top-divider {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border-color);
            z-index: 999;
        }

        /* Draggable область сверху */
        .top-drag-area {
            position: fixed;
            top: 1px;
            left: 0;
            right: 0;
            height: 40px;
            background: transparent;
            z-index: 998;
            -webkit-app-region: drag;
        }
        
        .app {
            display: flex;
            height: calc(100vh - 32px);
            margin-top: 32px;
            background: var(--bg-secondary);
        }


        
        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
            -webkit-app-region: no-drag;
        }
        
        .sidebar-header {
            padding: 12px 24px;
            background: var(--bg-sidebar);
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            -webkit-app-region: no-drag;
        }
        
        .app-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            letter-spacing: -0.02em;
            cursor: pointer;
            transition: var(--transition);
            height: 100%;
            width: 100%;
            padding-left: 24px;
        }
        
        .app-name {
            display: flex;
            align-items: center;
            gap: 12px;
            text-align: center;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .app-icon-gradient {
            width: 24px;
            height: 24px;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #06b6d4, #3b82f6);
            background-size: 300% 300%;
            animation: gradientShift 15s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            clip-path: polygon(0 0, 0 100%, 100% 50%);
            flex-shrink: 0;
        }
        
        .app-text {
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #06b6d4, #3b82f6);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 15s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }
        
        @keyframes gradientShift {
            0% { 
                background-position: 0% 50%; 
                filter: brightness(0.8) saturate(0.9);
            }
            25% { 
                background-position: 50% 50%; 
                filter: brightness(0.9) saturate(1);
            }
            50% { 
                background-position: 100% 50%; 
                filter: brightness(0.8) saturate(0.9);
            }
            75% { 
                background-position: 50% 50%; 
                filter: brightness(0.7) saturate(0.8);
            }
            100% { 
                background-position: 0% 50%; 
                filter: brightness(0.8) saturate(0.9);
            }
        }
        
        .app-version {
            font-size: 10px;
            font-weight: 500;
            color: var(--success-color);
            background: rgba(34, 197, 94, 0.1);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(34, 197, 94, 0.2);
            text-align: center;
        }

        .app-title:hover {
            opacity: 0.8;
        }
        
        .app-icon {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .app-logo-css {
            width: 100%;
            height: 100%;
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .app-logo-css:hover {
            background: var(--bg-card);
        }
        
        .app-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 500;
            margin: 0;
            padding: 0 24px 8px;
        }
        

        
        .search-input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 13px;
            transition: var(--transition);
        }
        
        .search-input::placeholder {
            color: var(--text-muted);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--bg-tertiary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        

        
        .sidebar-settings-btn {
            position: absolute;
            top: 24px;
            right: 16px;
            z-index: 10;
            -webkit-app-region: no-drag;
        }
        
        .btn-icon-small {
            width: 32px;
            height: 32px;
            border-radius: 0;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: color 0.15s ease;
            flex-shrink: 0;
            -webkit-app-region: no-drag;
            pointer-events: auto;
            opacity: 0.8;
        }
        
        .btn-icon-small:hover {
            background: transparent;
            color: var(--text-primary);
            opacity: 1;
        }
        
        .sidebar-section {
            margin-bottom: 32px;
        }
        
        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0 24px 8px;
            margin-bottom: 4px;
        }
        
        .category-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 24px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            color: var(--text-secondary);
        }
        
        .category-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .category-item.active {
            background: rgba(59, 130, 246, 0.15);
            color: var(--text-primary);
        }
        
        .category-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--primary-color);
        }
        
        .category-name {
            font-weight: 500;
            font-size: 14px;
        }
        
        .category-count {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }
        
        .add-category {
            color: var(--primary-color);
            font-size: 14px;
            font-weight: 500;
            padding: 12px 24px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .add-category:hover {
            background: var(--bg-tertiary);
            color: var(--primary-hover);
        }
        
        .add-category::before {
            content: '+';
            font-size: 18px;
            font-weight: 600;
        }
        
        .action-buttons {
            padding: 0 24px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Moodle Section in Sidebar */
        .moodle-section {
            border-top: 1px solid var(--border-color);
            padding-top: 16px;
        }

        .moodle-course-info {
            margin-bottom: 16px;
        }

        .moodle-course-select {
            margin-bottom: 12px;
            padding: 0 24px;
        }

        .moodle-course-select label {
            display: block;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .moodle-course-select select {
            width: 100%;
            padding: 6px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 12px;
            -webkit-app-region: no-drag;
        }

        .moodle-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            padding: 0 24px;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 11px;
            min-height: 28px;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .moodle-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            font-size: 11px;
            margin: 0 24px;
        }

        .moodle-assignments-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .moodle-assignment-select {
            margin-bottom: 12px;
            padding: 0 24px;
        }

        .moodle-assignment-select label {
            display: block;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .moodle-assignment-select select {
            width: 100%;
            padding: 6px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 12px;
            -webkit-app-region: no-drag;
        }

        .moodle-assignment-actions {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            padding: 0 24px;
        }

        .assignment-info {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 12px;
            font-size: 11px;
            margin: 0 24px;
        }

        .assignment-info .info-item {
            margin-bottom: 4px;
        }

        .assignment-info .info-item:last-child {
            margin-bottom: 0;
        }

        .assignment-info strong {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .assignment-actions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .assignment-actions .download-all-btn {
            width: 100%;
            padding: 8px 12px;
            font-size: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            -webkit-app-region: no-drag;
        }

        .assignment-actions .download-all-btn:hover {
            background: var(--border-hover);
            border-color: var(--primary-color);
        }
        
        .assignment-dates {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 8px;
            font-size: 11px;
            margin: 8px 24px;
        }
        
        .assignment-dates .info-item {
            margin-bottom: 4px;
        }
        
        .assignment-dates .info-item:last-child {
            margin-bottom: 0;
        }
        
        .assignment-dates strong {
            color: var(--text-secondary);
            font-weight: 500;
        }
        

        

        
        .btn {
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            text-decoration: none;
            min-height: 36px;
            white-space: nowrap;
            box-sizing: border-box;
            -webkit-app-region: no-drag;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: var(--text-white);
            border: 1px solid var(--primary-color);
        }
        
        .btn-primary:hover {
            background: var(--primary-hover);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--border-hover);
            border-color: var(--border-hover);
        }
        
        .btn-success {
            background: var(--success-color);
            color: var(--text-white);
            border: 1px solid var(--success-color);
        }
        
        .btn-success:hover {
            background: var(--success-hover);
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: var(--text-white);
            border: 1px solid var(--danger-color);
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: var(--warning-color);
            color: var(--text-white);
            border: 1px solid var(--warning-color);
        }

        .btn-warning:hover {
            background: #b45309;
        }
        
        .notes-list {
            padding: 0 24px;
        }
        
        .note-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            user-select: none;
        }

        .note-item .swipe-action {
            position: absolute;
            top: 0;
            right: -80px;
            width: 80px;
            height: 100%;
            background: var(--danger-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            transition: var(--transition);
            cursor: pointer;
        }

        .note-item.swiped .swipe-action {
            right: 0;
        }
        .note-item .note-content {
            transition: var(--transition);
        }

        .note-item.swiped .note-content {
            transform: translateX(-80px);
        }
        
        .note-item:hover {
            background: var(--border-hover);
            border-color: var(--border-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .note-item.active {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .note-title {
            font-weight: 500;
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        .note-preview {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .note-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-muted);
        }
        


        /* Main Content */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            position: relative;
            -webkit-app-region: no-drag;
        }
        
        .editor-header {
            background: var(--bg-card);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: var(--shadow-sm);
            height: 80px;
            -webkit-app-region: no-drag;
        }
        
        .title-input {
            flex: 1;
            font-size: 24px;
            font-weight: 600;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            padding: 0;
            min-width: 0;
            letter-spacing: -0.01em;
            -webkit-app-region: no-drag;
        }
        
        .title-input::placeholder {
            color: var(--text-muted);
        }
        
        .editor-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            -webkit-app-region: no-drag;
        }

        .editor-sidebar-toggle {
            margin-left: auto;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 16px;
            -webkit-app-region: no-drag;
            pointer-events: auto;
        }

        .btn-icon:hover {
            background: var(--border-hover);
            border-color: var(--border-hover);
        }
        
        .category-select {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            min-width: 120px;
        }
        
        .category-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .btn-icon:hover {
            background: var(--bg-secondary);
            border-color: var(--border-hover);
            color: var(--text-primary);
        }
        
        .content-area {
            flex: 1;
            padding: 12px 24px;
            display: flex;
            flex-direction: column;
            min-height: 0;
            background: var(--bg-primary);
        }
        
        .content-textarea {
            flex: 1;
            background: transparent;
            color: var(--text-primary);
            border: none;
            outline: none;
            font-family: 'SF Mono', 'Monaco', 'Menlo', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: none;
            padding: 0;
            min-height: 400px;
            letter-spacing: 0.02em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .content-textarea::placeholder {
            color: var(--text-muted);
            font-style: italic;
        }
        
        .content-actions {
            margin-top: 16px;
            display: flex;
            gap: 12px;
        }

        /* Settings Sidebar */
        .settings-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg-sidebar);
            border-left: 1px solid var(--border-color);
            z-index: 1000;
            transition: var(--transition);
            overflow-y: auto;
        }

        .settings-sidebar.open {
            right: 0;
        }

        .settings-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .settings-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
        }

        .settings-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section h4 {
            margin: 0 0 16px 0;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
        }

        .setting-group select,
        .setting-group input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 13px;
            transition: var(--transition);
            -webkit-app-region: no-drag;
            pointer-events: auto;
        }

        .setting-group select:focus,
        .setting-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Выравнивание кнопок в настройках */
        .setting-group .btn {
            margin-top: 8px;
            width: 100%;
            -webkit-app-region: no-drag;
            pointer-events: auto;
        }

        .setting-group .btn + .btn {
            margin-top: 8px;
        }
        
        .token-help {
            margin-top: 6px;
        }
        
        .token-help small {
            color: var(--text-muted);
            font-size: 11px;
            line-height: 1.4;
        }
        
        .token-help a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .token-help a:hover {
            text-decoration: underline;
        }

        /* Группа кнопок */
        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .button-group .btn {
            flex: 1;
            min-width: 0;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: var(--transition);
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Copyright */
        .settings-copyright {
            margin-top: 32px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            line-height: 1.6;
        }

        .settings-copyright span {
            color: var(--text-muted);
            font-size: 12px;
            opacity: 0.7;
            font-weight: 400;
            display: inline-block;
            margin: 0 8px;
        }
        
        .settings-copyright .app-version {
            font-size: 10px;
            font-weight: 500;
            color: var(--success-color);
            background: rgba(34, 197, 94, 0.1);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        /* Moodle Status */
        .moodle-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-indicator.connected {
            background: var(--success-color);
        }

        .status-indicator.error {
            background: var(--danger-color);
        }

        .status-indicator.loading {
            background: var(--warning-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Assignment Info */
        .assignment-info {
            margin-top: 16px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .info-item {
            margin-bottom: 8px;
            font-size: 13px;
        }

        .info-item:last-child {
            margin-bottom: 0;
        }

        .info-item strong {
            color: var(--text-primary);
        }

        .info-item span {
            color: var(--text-secondary);
        }

        /* Submissions Modal */
        .submissions-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .submissions-list,
        .students-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .submission-item,
        .student-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
        }

        .submission-header,
        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .student-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .student-status {
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 500;
        }

        .student-status.submitted {
            background: var(--success-color);
            color: white;
        }

        .student-status.not-submitted {
            background: var(--text-muted);
            color: white;
        }

        .submission-status {
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 500;
        }

        .submission-status.graded {
            background: var(--success-color);
            color: white;
        }

        .submission-status.notgraded {
            background: var(--warning-color);
            color: white;
        }

        .submission-content,
        .student-content {
            margin-bottom: 16px;
        }

        .submission-text {
            background: var(--bg-card);
            padding: 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            white-space: pre-wrap;
            color: var(--text-primary);
        }

        .no-submission {
            background: var(--bg-card);
            padding: 12px;
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
        }

        .submission-files {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .file-item {
            background: var(--bg-card);
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .file-item a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .file-item a:hover {
            text-decoration: underline;
        }

        .file-size {
            color: var(--text-muted);
            font-size: 11px;
        }

        .submission-grading,
        .student-grading {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .grade-input {
            width: 80px;
            padding: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
        }

        .grade-input:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        /* ===== СТИЛИ ДЛЯ МОДАЛЬНОГО ОКНА ШАБЛОНОВ ===== */
        
        .templates-modal,
        .hotkeys-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .templates-content,
        .hotkeys-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .templates-header,
        .hotkeys-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .templates-header h3,
        .hotkeys-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 18px;
        }

        .templates-body,
        .hotkeys-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .templates-description {
            margin-bottom: 16px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary-color);
        }

        .templates-description p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .templates-description strong {
            color: var(--text-primary);
        }

        .templates-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .template-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .template-header label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 13px;
        }

        .template-hotkey {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 500;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .template-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .template-hotkey-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-width: 70px;
            height: 36px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-weight: 600;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            text-align: center;
            flex-shrink: 0;
        }
        
        .cmd-symbol {
            font-size: 22px;
        }
        
        .cmd-number {
            font-size: 13px;
        }
        
        .template-input {
            flex: 1;
            height: 36px;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            transition: var(--transition);
        }
        .template-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--bg-card);
        }

        .template-input::placeholder {
            color: var(--text-muted);
        }

        .templates-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        /* Стили для модального окна горячих клавиш */
        .hotkeys-section {
            margin-bottom: 24px;
        }
        
        .hotkeys-section h4 {
            margin: 0 0 12px 0;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        
        .hotkey-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
            padding: 8px 0;
        }
        
        .hotkey-key {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            min-width: 60px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .hotkey-description {
            color: var(--text-primary);
            font-size: 13px;
            flex: 1;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .close-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Интерфейс студентов */
        .students-interface {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: var(--bg-card);
        }

        .main-course-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: var(--bg-primary);
            height: 80px;
        }
        
        .main-course-header h1 {
            margin: 0;
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 700;
        }
        
        .course-actions {
            display: flex;
            gap: 12px;
        }
        
        .assignment-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        

        
        .students-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--bg-secondary);
            height: 80px;
            margin-top: 0;
            max-height: 80px;
            overflow: hidden;
        }
        
        .assignment-info-header {
            padding: 8px 24px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
        }
        
        .assignment-info-header h3 {
            margin: 0;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .students-title h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
        }

        .students-count {
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 4px;
            display: block;
        }

        .students-actions {
            display: flex;
            gap: 12px;
        }

        .students-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .students-sidebar {
            width: 300px;
            border-right: 1px solid var(--border-color);
            background: var(--bg-secondary);
            overflow-y: auto;
            margin-top: 1px; /* Отступ от глобальной линии */
        }

        .students-search {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }
        
        .students-search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            transition: var(--transition);
        }
        
        .students-search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .students-filters {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .filter-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: nowrap;
        }

        .filter-btn {
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            flex: 1;
        }

        .filter-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary-color);
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .student-list-item {
            padding: 8px 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .student-list-item:hover {
            background: var(--bg-tertiary);
        }

        .student-list-item.active {
            background: var(--primary-color);
            color: white;
        }

        .student-list-item.active .student-list-name {
            color: white;
        }

        .student-list-item.active .status-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .student-list-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .student-list-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 0;
        }

        .student-list-group {
            background: var(--info-color);
            color: white;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 500;
            font-style: normal;
            display: inline-block;
            margin-right: 8px;
        }

        .student-list-status {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .status-badge {
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 500;
        }

        .status-badge.submitted {
            background: var(--success-color);
            color: white;
        }

        .status-badge.not-submitted {
            background: var(--text-muted);
            color: white;
        }

        .grade-badge {
            background: var(--primary-color);
            color: white;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 500;
        }
        
        .grade-badge.not-graded {
            background: var(--danger-color);
            color: white;
        }
        
        .files-badge {
            background: var(--info-color);
            color: white;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 500;
        }

        .student-detail {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
        }

        .student-detail-header {
            padding: 20px 24px;
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: none;
        }

        .student-detail-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }
        
        .course-title-header {
            padding: 12px 24px;
            background: var(--bg-secondary);
            height: 60px;
            display: flex;
            align-items: center;
        }
        
        .course-title-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
        }

        .student-detail-status {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .student-detail-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .no-student-selected {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
        }

        .no-student-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .no-student-text {
            font-size: 16px;
            text-align: center;
        }

        .submission-section {
        }

        .submission-section h4 {
            margin: 0 0 16px 0;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
        }

        .submission-text-content {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            white-space: pre-wrap;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .submission-files-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .file-preview-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
        }



        .file-icon {
            font-size: 16px;
        }

        .file-name {
            flex: 1;
            color: var(--text-primary);
            font-weight: 500;
        }

        .file-size {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .file-preview-content {
            padding: 16px;
        }

        .file-preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .file-preview-image:hover {
            transform: scale(1.02);
        }

        .file-preview-video,
        .file-preview-audio {
            width: 100%;
            border-radius: var(--radius-sm);
        }

        .file-preview-pdf {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: var(--radius-sm);
        }

        .file-preview-download {
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        
        /* Стили для миниатюр файлов в списке */
        .file-preview-video-container,
        .file-preview-audio-container,
        .file-preview-pdf-container,
        .file-preview-download {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            margin: 4px;
        }
        
        .file-preview-video-container:hover,
        .file-preview-audio-container:hover,
        .file-preview-pdf-container:hover,
        .file-preview-download:hover {
            transform: scale(1.05);
            background: var(--bg-hover);
        }
        
        .file-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        .file-preview-play-button {
            font-size: 24px;
            color: white;
        }
        
        .file-preview-pdf-icon,
        .file-preview-file-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .file-preview-pdf-name,
        .file-preview-file-name {
            font-size: 10px;
            text-align: center;
            word-break: break-word;
            line-height: 1.2;
        }
        
        /* Стили для большого предпросмотра файлов */
        .file-preview-large {
            width: 100%;
        }
        
        .file-preview-large-image {
            width: 100%;
            max-height: 60vh;
            object-fit: contain;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }
        
        .file-preview-large-video {
            width: 100%;
            max-height: 60vh;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            background: #000;
            object-fit: contain;
            /* Улучшенная буферизация */
            will-change: auto;
            /* Приоритет загрузки */
            loading: eager;
        }

        .file-preview-modal-video {
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            background: #000;
            object-fit: contain;
            /* Улучшенная буферизация */
            will-change: auto;
            /* Приоритет загрузки */
            loading: eager;
        }

        .download-link {
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            font-size: 12px;
        }

        .download-link:hover {
            color: var(--text-primary);
            text-decoration: underline;
        }

        .image-gallery {
            position: relative;
            width: 100%;
            max-height: 60vh;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            background: #000;
            overflow: hidden;
        }

        .image-gallery-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-gallery-image {
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
            transition: opacity 0.3s ease;
        }



        .image-gallery-fullscreen {
            width: 100%;
            height: 70vh;
            position: relative;
            background: #000;
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .image-gallery-fullscreen .image-gallery-container {
            width: 100%;
            height: 100%;
        }

        .image-gallery-fullscreen .image-gallery-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-gallery-modal .file-preview-modal-content {
            max-width: 90vw;
            max-height: 90vh;
        }

        .image-gallery-modal .file-preview-modal-body {
            padding: 0;
        }

        .download-progress-section {
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }

        .download-progress-item {
            margin-bottom: 12px;
            padding: 8px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
        }

        .download-progress-filename {
            font-size: 12px;
            color: var(--text-primary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .download-progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .download-progress-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .download-progress-status {
            font-size: 10px;
            color: var(--text-secondary);
        }


        
        .file-preview-large-audio {
            width: 100%;
            height: 60px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }
        
        .file-preview-large-pdf {
            width: 100%;
            height: 70vh;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            background: white;
        }
        
        .file-preview-large-video {
            width: 100%;
            max-height: 60vh;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            background: #000;
        }
        
        .file-preview-large-unknown {
            width: 100%;
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
        }
        
        .file-preview-large-download {
            width: 100%;
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            text-align: center;
        }
        
        .file-preview-file-icon {
            font-size: 48px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .file-preview-file-name {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 16px;
            text-align: center;
            word-break: break-word;
            max-width: 100%;
            padding: 0 16px;
        }
        
        .file-info {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }
        
        .file-info h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .file-details {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: space-between;
            align-items: center;
        }

        .file-details-info {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .file-details span {
            font-size: 12px;
            color: var(--text-muted);
            background: var(--bg-primary);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
        }
        
        .grading-section {
            margin-top: 24px;
        }
        
        .grading-section h4 {
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .grading-form {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            flex-wrap: wrap;
            max-width: 100%;
            box-sizing: border-box;
            margin-top: 16px;
        }
        
        .grading-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            flex-shrink: 0;
        }
        
        .grading-input-group.grade-group {
            flex-shrink: 0;
        }
        
        .grading-input-group.comment-group {
            flex: 1;
            min-width: 200px;
        }
        
        .grading-button-group {
            margin-left: auto;
            flex-shrink: 0;
        }
        

        
        .grading-input-group label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
        }
        
        .grade-input {
            width: 80px;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            text-align: center;
        }
        
        .comment-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            height: 40px;
            transition: var(--transition);
            flex: 1;
        }
        
        .comment-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .no-submission-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-muted);
        }

        .no-submission-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .no-submission-text {
            font-size: 16px;
            text-align: center;
        }

        .student-detail-grading {
            padding: 20px 24px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .grading-header h4 {
            margin: 0 0 12px 0;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
        }

        .grading-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .grading-controls .grade-input {
            width: 120px;
        }

        /* Модальное окно для предпросмотра файлов */
        .file-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .file-preview-modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            max-width: 95vw;
            max-height: 95vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .file-preview-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }
        
        .file-preview-modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .file-preview-student-info {
            font-size: 14px;
            color: var(--text-muted);
            margin-left: 16px;
        }
        
        .file-preview-modal-body {
            flex: 1;
            padding: 24px;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .file-preview-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }
        
        .file-preview-grading-form {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .grading-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .grading-input-group label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .file-preview-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .file-preview-modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }

        .file-preview-modal-body {
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .file-preview-modal-image {
            max-width: 100%;
            max-height: 70vh;
            border-radius: var(--radius-sm);
        }

        .file-preview-pdf-container {
            width: 100%;
            height: 60vh;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .file-preview-pdf {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .file-preview-word-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 2px dashed var(--border-color);
        }

        .file-preview-file-icon {
            font-size: 64px;
            margin-bottom: 16px;
            color: var(--text-secondary);
        }

        .file-preview-file-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 24px;
            word-break: break-word;
        }

        .file-preview-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .file-preview-hint {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 8px;
            font-style: italic;
        }

        .file-preview-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-preview-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--error-color);
            font-size: 14px;
            text-align: center;
        }

        .word-preview-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            text-align: center;
            padding: 20px;
        }

        .file-preview-simple {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            text-align: center;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 2px dashed var(--border-color);
        }

        .pdf-page-info {
            margin-top: 8px;
            text-align: center;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            margin-left: 8px;
        }

        .word-preview-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            max-height: 70vh;
            overflow-y: auto;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .word-preview-content h1,
        .word-preview-content h2,
        .word-preview-content h3,
        .word-preview-content h4,
        .word-preview-content h5,
        .word-preview-content h6 {
            margin-top: 24px;
            margin-bottom: 16px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .word-preview-content p {
            margin-bottom: 16px;
        }

        .word-preview-content ul,
        .word-preview-content ol {
            margin-bottom: 16px;
            padding-left: 24px;
        }

        .word-preview-content li {
            margin-bottom: 8px;
        }

        .word-preview-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }

        .word-preview-content table,
        .word-preview-content th,
        .word-preview-content td {
            border: 1px solid var(--border-color);
        }

        .word-preview-content th,
        .word-preview-content td {
            padding: 8px 12px;
            text-align: left;
        }

        .word-preview-content th {
            background: var(--bg-secondary);
            font-weight: 600;
        }
        
        .status-bar {
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            padding: 8px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .status-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .status-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            transition: var(--transition);
        }
        
        .status-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .char-count {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .save-status {
            color: var(--success-color);
            font-weight: 500;
        }
        
        .welcome {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }
        
        .welcome-content {
            max-width: 500px;
        }
        
        .welcome-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 32px;
            color: white;
        }
        
        .welcome h2 {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }
        
        .welcome p {
            color: var(--text-secondary);
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 32px;
        }
        
        .welcome-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 32px;
        }
        
        .welcome-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 32px;
        }
        
        .feature-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 20px;
            text-align: left;
        }
        
        .feature-icon {
            width: 40px;
            height: 40px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            color: var(--primary-color);
            font-size: 18px;
        }
        
        .feature-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }
        
        .feature-desc {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        /* Markdown Guide */
        .markdown-guide {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-top: 8px;
            font-size: 12px;
        }
        
        .markdown-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .markdown-examples {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .markdown-example {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 8px;
            font-family: 'SF Mono', 'Monaco', 'Menlo', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .note-item {
            animation: slideIn 0.3s ease-out;
        }
        
        .welcome {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
            }
            
            .editor-header {
                padding: 16px 20px;
                flex-wrap: wrap;
                gap: 12px;
            }
            
            .title-input {
                font-size: 24px;
                order: -1;
                width: 100%;
            }
            
            .content-area {
                padding: 20px;
            }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 14px;
            z-index: 10000;
            box-shadow: var(--shadow-md);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
        }

        .notification-success {
            border-left: 4px solid var(--success-color);
        }

        .notification-error {
            border-left: 4px solid var(--danger-color);
        }

        .notification-warning {
            border-left: 4px solid var(--warning-color);
        }

        .notification-info {
            border-left: 4px solid var(--primary-color);
        }



        /* Стили для заголовка файлов */
        .submission-files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .submission-files-header h4 {
            margin: 0;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
        }

        .download-all-files-btn {
            padding: 6px 12px;
            font-size: 13px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            -webkit-app-region: no-drag;
        }

        .download-all-files-btn:hover {
            background: var(--border-hover);
            border-color: var(--primary-color);
        }

        /* Стили для прогресс-бара скачивания */
        .download-progress-container {
            position: fixed;
            top: 24px;
            right: 24px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            min-width: 400px;
            z-index: 3000;
            box-shadow: var(--shadow-lg);
        }

        @media (max-width: 640px) {
            .download-progress-container {
                top: 50%;
                left: 50%;
                right: auto;
                transform: translate(-50%, -50%);
                width: calc(100% - 32px);
                min-width: 0;
            }
        }

        .download-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-right: 40px; /* пространство для кнопки ✕ */
        }

        .download-progress-header h4 {
            margin: 0;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 500;
        }

        .download-progress-text {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .download-progress-cancel {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 16px;
            line-height: 1;
            -webkit-app-region: no-drag;
        }
        .download-progress-cancel:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .download-progress-cancel:active {
            transform: scale(0.95);
        }

        .download-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            overflow: hidden;
            margin-bottom: 16px;
        }

        .download-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-hover));
            border-radius: var(--radius-sm);
            transition: width 0.3s ease;
        }

        .download-progress-details {
            text-align: center;
        }

        .current-file {
            color: var(--text-secondary);
            font-size: 13px;
            font-style: italic;
        }

        /* Стили для массового скачивания */
        .mass-download-item {
            position: relative;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            margin-bottom: 16px;
        }

        .mass-download-item .download-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .mass-download-item .download-progress-header h4 {
            margin: 0;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
        }

        .mass-download-item .download-progress-text {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .mass-download-item .download-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            overflow: hidden;
            margin-bottom: 12px;
        }

        .mass-download-item .download-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-hover));
            border-radius: var(--radius-sm);
            transition: width 0.3s ease;
        }

        .mass-download-item .download-progress-details {
            text-align: center;
        }

        .mass-download-item .current-file {
            color: var(--text-secondary);
            font-size: 12px;
            font-style: italic;
        }

        /* Модальное окно подтверждения отмены */
        .cancel-confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cancel-confirmation-content {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            max-width: 400px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .cancel-confirmation-title {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 500;
            margin: 0 0 16px 0;
        }

        .cancel-confirmation-text {
            color: var(--text-secondary);
            font-size: 14px;
            margin: 0 0 24px 0;
            line-height: 1.5;
        }

        .cancel-confirmation-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .cancel-confirmation-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .cancel-confirmation-btn:hover {
            background: var(--border-hover);
            border-color: var(--primary-color);
        }

        .cancel-confirmation-btn.cancel {
            background: var(--danger-color);
            border-color: var(--danger-color);
            color: white;
        }

        .cancel-confirmation-btn.cancel:hover {
            background: var(--danger-hover);
            border-color: var(--danger-hover);
        }


    </style>
</head>
<body>

    


    <!-- Серая полоска сверху -->
    <div class="top-divider"></div>
    
    <!-- Draggable область сверху -->
    <div class="top-drag-area"></div>

    <!-- Кнопки управления окном -->
    <div class="window-controls">
        <button class="window-control window-control-close" id="window-close" title="Закрыть">
            <svg width="12" height="12" viewBox="0 0 12 12">
                <path d="M1 1l10 10M1 11L11 1" stroke="currentColor" stroke-width="1.5" fill="none"/>
            </svg>
        </button>
        <button class="window-control window-control-minimize" id="window-minimize" title="Свернуть">
            <svg width="12" height="12" viewBox="0 0 12 12">
                <path d="M1 6h10" stroke="currentColor" stroke-width="1.5" fill="none"/>
            </svg>
        </button>
        <button class="window-control window-control-maximize" id="window-maximize" title="Развернуть">
            <svg width="12" height="12" viewBox="0 0 12 12">
                <path d="M1 1h10v10H1z" stroke="currentColor" stroke-width="1.5" fill="none"/>
            </svg>
        </button>
    </div>

    <!-- Кнопка закрытия в правом верхнем углу (только для Windows) -->
    <button class="app-close-btn" id="app-close-btn" title="Закрыть приложение">✕</button>

    <div class="app">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="app-title" ondblclick="editAppTitle()">
                    <div class="app-name">
                        <div class="app-icon-gradient"></div>
                        <span class="app-text">ГИТР FLOW</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-content">
                <!-- Moodle Integration Section -->
                <div class="sidebar-section moodle-section">
                    <div class="section-title">Выбор курса</div>
                    
                    <div class="moodle-course-info">
                        <div class="moodle-course-select">
                            <label>Курс</label>
                            <select id="moodle-course">
                                <option value="">Выберите курс...</option>
                            </select>
                        </div>
                        
                        <div class="moodle-actions">
                                                <button class="btn btn-primary btn-sm" id="test-moodle-btn">🔗 Подключить</button>
                    <button class="btn btn-secondary btn-sm" id="load-assignments-btn">📝 Обновить</button>
                        </div>
                        
                        <div class="moodle-status" id="moodle-status">
                            <div class="status-indicator" id="moodle-status-indicator"></div>
                            <span id="moodle-status-text">Не подключено</span>
                        </div>
                    </div>
                    
                    <div class="moodle-assignments-section">
                        <div class="moodle-assignment-select">
                            <label>Задание</label>
                            <select id="moodle-assignment">
                                <option value="">Выберите задание...</option>
                            </select>
                        </div>
                        

                    </div>
                    
                    <div class="assignment-info" id="assignment-info" style="display: none;">
                        <div class="info-item">
                            <strong>Название:</strong> <span id="assignment-name"></span>
                        </div>
                        <div class="info-item">
                            <strong>Студентов:</strong> <span id="assignment-students"></span>
                        </div>
                        <div class="info-item">
                            <strong>Сдано:</strong> <span id="assignment-submitted"></span>
                        </div>
                        <div class="info-item">
                            <strong>Проверено:</strong> <span id="assignment-graded"></span>
                        </div>
                        <div class="assignment-actions">
                            <button class="btn btn-secondary download-all-btn" onclick="downloadAllSubmissions()" title="Скачать все ответы студентов">
                                Скачать все ответы
                            </button>
                        </div>
                    </div>
                
                    <div class="assignment-dates" id="assignment-dates" style="display: none;">
                        <div class="info-item">
                            <strong>Разрешить с:</strong> <span id="assignment-allow-from">—</span>
                    </div>
                        <div class="info-item">
                            <strong>Срок сдачи:</strong> <span id="assignment-due-date">—</span>
                    </div>
                        <div class="info-item">
                            <strong>Запретить после:</strong> <span id="assignment-cutoff-date">—</span>
                    </div>
                </div>
                

                

        </div>
        
        <!-- Прогресс-бар скачивания -->
        <div class="download-progress-section" id="download-progress-section" style="display: none;">
            <div class="section-title">Скачивание файлов</div>
            <div class="download-progress-container" id="download-progress-container">
                <!-- Прогресс-бары будут добавляться динамически -->
            </div>
        </div>
        

                
                <!-- Кнопка настроек в правом углу сайдбара -->
                <div class="sidebar-settings-btn">
                    <button class="btn-icon-small" id="sidebar-toggle-btn" title="Настройки">
                        ⚙️
                    </button>
            </div>
            
                </div>
            </div>
        
        <!-- Main Content -->
        <div class="main-area">

            <!-- Settings Sidebar -->
            <div class="settings-sidebar" id="settings-sidebar">
                <div class="settings-header">
                    <h3>Настройки</h3>
                    <button class="btn-icon" id="settings-close-btn">✕</button>
                </div>
                
                <div class="settings-content">
                    <div class="settings-section">
                        <h4>Настройки приложения</h4>
                        
                        <div class="setting-group">
                            <label>Тема</label>
                            <select id="theme-select">
                                <option value="cursor" selected>Серая</option>
                                <option value="light">Светлая</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>Интеграция с Moodle</h4>
                        
                        <div class="setting-group">
                            <label>URL Moodle</label>
                            <input type="url" id="moodle-url" placeholder="https://sdo.gitr.ru/">
                        </div>
                        
                        <div class="setting-group">
                            <label>Токен доступа</label>
                            <input type="password" id="moodle-token" placeholder="Введите ваш токен">
                            <div class="token-help">
                                <small>💡 Токен можно получить на странице <a href="https://sdo.gitr.ru/user/managetoken.php" target="_blank">https://sdo.gitr.ru/user/managetoken.php</a></small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>Шаблоны комментариев</h4>
                        <div class="setting-group">
                            <label>Комментарий 1 <span class="hotkey-hint">⌘ + 1</span></label>
                            <input type="text" id="template-1" placeholder="Введите шаблон комментария 1">
                        </div>
                        <div class="setting-group">
                            <label>Комментарий 2 <span class="hotkey-hint">⌘ + 2</span></label>
                            <input type="text" id="template-2" placeholder="Введите шаблон комментария 2">
                        </div>
                        <div class="setting-group">
                            <label>Комментарий 3 <span class="hotkey-hint">⌘ + 3</span></label>
                            <input type="text" id="template-3" placeholder="Введите шаблон комментария 3">
                        </div>
                        <div class="setting-group">
                            <label>Комментарий 4 <span class="hotkey-hint">⌘ + 4</span></label>
                            <input type="text" id="template-4" placeholder="Введите шаблон комментария 4">
                        </div>
                        <div class="setting-group">
                            <label>Комментарий 5 <span class="hotkey-hint">⌘ + 5</span></label>
                            <input type="text" id="template-5" placeholder="Введите шаблон комментария 5">
                        </div>
                        <div class="setting-group">
                            <label>Комментарий 6 <span class="hotkey-hint">⌘ + 6</span></label>
                            <input type="text" id="template-6" placeholder="Введите шаблон комментария 6">
                        </div>
                    </div>
                    
                    <div class="settings-copyright">
                        <span class="app-version">ver. 6.0</span>
                        <span>12:21 Studio @ 2025</span>
                    </div>
                </div>
            </div>
            

            
            <div class="markdown-guide" id="markdown-guide" style="display: none;">
                <div class="markdown-title">
                    📝 Поддерживается Markdown:
                </div>
                <div class="markdown-examples">
                    <div class="markdown-example"># Заголовок 1</div>
                    <div class="markdown-example">## Заголовок 2</div>
                    <div class="markdown-example">**Жирный текст**</div>
                    <div class="markdown-example">*Курсив*</div>
                    <div class="markdown-example">- Список</div>
                    <div class="markdown-example">1. Нумерованный список</div>
                </div>
            </div>
        </div>
        

    </div>

    <!-- Модальное окно настроек -->
    <div id="settings-modal" class="settings-modal">
        <div class="settings-content">
            <div class="settings-header">
                <h2 class="settings-title">Настройки</h2>
                <button class="close-btn" onclick="closeSettings()">&times;</button>
            </div>
            
            <div class="settings-section">
                <h3>Общие</h3>
                <div class="form-group">
                    <label class="form-label">Папка для сохранения</label>
                    <input type="text" class="form-input" id="folder-input" placeholder="Выберите папку для сохранения">
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" class="checkbox" id="auto-save" checked>
                        <label class="form-label">Автосохранение</label>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>Интерфейс</h3>
                <div class="form-group">
                    <label class="form-label">Тема</label>
                    <select class="form-select" id="theme-select">
                        <option value="dark">Темная</option>
                        <option value="light">Светлая</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>Экспорт и бэкап</h3>
                <div class="form-group">
                    
                </div>
                <div class="form-group">
                    <button class="btn-secondary" onclick="backupData()">Создать бэкап</button>
                </div>
            </div>
            
            <div class="settings-actions">
                <button class="btn-secondary" onclick="closeSettings()">Отмена</button>
                <button class="btn-primary" onclick="saveSettings()">Сохранить</button>
            </div>
        </div>
    </div>



    <!-- Модальное окно Moodle -->
    <div id="moodle-modal" class="moodle-modal">
        <div class="moodle-content">
            <div class="moodle-header">
                <h2 class="moodle-title">Подключение к Moodle</h2>
                <button class="close-btn" onclick="closeMoodle()">&times;</button>
            </div>
            
            <div id="moodle-status" class="moodle-status disconnected">
                Не подключено к Moodle
            </div>
            
            <div class="moodle-section">
                <h3>Подключение</h3>
                <div class="form-group">
                    <label class="form-label">Адрес сервера Moodle</label>
                    <input type="url" class="form-input" id="moodle-url" placeholder="https://sdo.gitr.ru/">
                </div>
                <div class="form-group">
                    <label class="form-label">Логин</label>
                    <input type="text" class="form-input" id="moodle-username" placeholder="Ваш логин">
                </div>
                <div class="form-group">
                    <label class="form-label">Пароль</label>
                    <input type="password" class="form-input" id="moodle-password" placeholder="Ваш пароль">
                </div>
                <button class="btn-primary" onclick="connectMoodle()">Подключиться</button>
            </div>
            
            <div class="moodle-section" id="courses-section" style="display: none;">
                <h3>Курсы</h3>
                <div class="courses-list" id="courses-list">
                    <!-- Курсы будут загружены здесь -->
                </div>
                <button class="btn-secondary" onclick="importSelectedCourse()" style="margin-top: 12px;">Импортировать выбранный курс</button>
            </div>
            
            <div class="moodle-actions">
                <button class="btn-secondary" onclick="closeMoodle()">Закрыть</button>
            </div>
        </div>
    </div>
    <script>

        // Глобальные переменные
        let settings = {
            folder: '',
            autoSave: true,
            theme: 'cursor'
        };
        let moodleConfig = {
            url: 'https://sdo.gitr.ru/',
            token: '',
            connected: false
        };
        
        // Глобальная переменная для хранения отфильтрованных студентов
        let filteredStudents = [];
        




        function editAppTitle() {
            const appTitleElement = document.querySelector('.app-title');
            const currentTitle = appTitleElement.textContent.replace(/[^\w\s]/g, '').trim();
            const newTitle = prompt('Переименовать приложение:', currentTitle);
            
            if (newTitle && newTitle.trim()) {
                appTitleElement.innerHTML = `<div class="app-icon"><div class="app-logo-css" onclick="changeAppEmoji()">${settings.appEmoji || '🎓'}</div></div>${newTitle}`;
                document.title = `${newTitle}`;
                
                // Сохраняем в настройки
                settings.appTitle = newTitle;
                saveData();
            }
        }

        async function changeAppEmoji() {
            try {
                // Пытаемся получить содержимое буфера обмена
                let clipboardContent = '';
                try {
                    clipboardContent = await navigator.clipboard.readText();
                } catch (e) {
                    console.log('Не удалось прочитать буфер обмена:', e);
                }
                
                // Показываем диалог с предложением вставить из буфера обмена
                let message = 'Введите эмоджи или символ:';
                if (clipboardContent && clipboardContent.trim()) {
                    message += `\n\nБуфер обмена содержит: "${clipboardContent}"\nНажмите "Вставить из буфера" чтобы использовать его.`;
                }
                
                const userInput = prompt(message, settings.appEmoji || '🎓');
                
                if (userInput && userInput.trim()) {
                    // Если пользователь ввел "вставить" или "paste", используем буфер обмена
                    if (userInput.toLowerCase().includes('вставить') || userInput.toLowerCase().includes('paste')) {
                        if (clipboardContent && clipboardContent.trim()) {
                            settings.appEmoji = clipboardContent.trim();
                            showNotification(`Эмоджи изменен на: ${clipboardContent.trim()}`, 'success');
                        } else {
                            showNotification('Буфер обмена пуст', 'warning');
                            return;
                        }
                    } else {
                        // Используем введенный пользователем текст
                        settings.appEmoji = userInput.trim();
                        showNotification(`Эмоджи изменен на: ${userInput.trim()}`, 'success');
                    }
                    
                    // Обновляем отображение
                    const logoElement = document.querySelector('.app-logo-css');
                    if (logoElement) {
                        logoElement.textContent = settings.appEmoji;
                    }
                    saveData();
                }
            } catch (error) {
                console.error('Ошибка при изменении эмоджи:', error);
            }
        }

        async function pasteEmojiFromClipboard() {
            try {
                // Предотвращаем всплытие события
                event.stopPropagation();
                
                // Пытаемся получить содержимое буфера обмена
                const clipboardContent = await navigator.clipboard.readText();
                
                if (clipboardContent && clipboardContent.trim()) {
                    settings.appEmoji = clipboardContent.trim();
                    
                    // Обновляем отображение
                    const logoElement = document.querySelector('.app-logo-css');
                    if (logoElement) {
                        logoElement.textContent = settings.appEmoji;
                    }
                    
                    saveData();
                    showNotification(`Эмоджи изменен на: ${clipboardContent.trim()}`, 'success');
                } else {
                    showNotification('Буфер обмена пуст', 'warning');
                }
            } catch (error) {
                console.error('Ошибка при вставке из буфера обмена:', error);
                showNotification('Ошибка при чтении буфера обмена', 'error');
            }
        }

        function openSettings() {
            console.log('Открытие настроек...');
            alert('Настройки будут добавлены в следующей версии!');
        }

        function connectMoodle() {
            console.log('Подключение к Moodle...');
            alert('Интеграция с Moodle будет добавлена в следующей версии!');
        }

        function toggleMarkdownHelp() {
            const markdownGuide = document.getElementById('markdown-guide');
            const isVisible = markdownGuide.style.display !== 'none';
            
            if (isVisible) {
                markdownGuide.style.display = 'none';
            } else {
                markdownGuide.style.display = 'block';
            }
        }

            

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM загружен, приложение инициализируется...');
            
            // Обновляем статус
            const testStatus = document.getElementById('test-status');
            if (testStatus) {
                testStatus.textContent = 'DOM загружен, инициализация...';
            }
            
            loadData();
            setupEventListeners();
            
            console.log('✅ Инициализация завершена');
            
            // Обновляем статус после инициализации
            if (testStatus) {
                testStatus.textContent = 'Инициализация завершена!';
            }
        });

        // Загрузка данных
        function loadData() {
            // Определяем платформу и настраиваем интерфейс
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            if (isMac) {
                document.body.classList.add('mac');
            } else {
                document.body.classList.add('windows');
                // Обновляем текст горячих клавиш для Windows
                const hotkeyHints = document.querySelectorAll('.hotkey-hint');
                hotkeyHints.forEach(hint => {
                    hint.textContent = hint.textContent.replace('⌘ +', 'Ctrl +');
                });
            }
            
            const savedSettings = localStorage.getItem('notebook-settings');
            const savedMoodle = localStorage.getItem('notebook-moodle');

            if (savedSettings) {
                settings = { ...settings, ...JSON.parse(savedSettings) };
            }

            if (savedMoodle) {
                moodleConfig = { ...moodleConfig, ...JSON.parse(savedMoodle) };
            }

            // Загружаем сохраненное название приложения
            if (settings.appTitle) {
                const appTitleElement = document.querySelector('.app-title');
                appTitleElement.innerHTML = `<div class="app-icon"><div class="app-logo-css" onclick="changeAppEmoji()">${settings.appEmoji || '🎓'}</div></div>${settings.appTitle}`;
                document.title = `${settings.appTitle}`;
            }


            if (settings.theme) {
                document.getElementById('theme-select').value = settings.theme;
                applyTheme(settings.theme);
            } else {
                // Применяем серую тему по умолчанию
                settings.theme = 'cursor';
                document.getElementById('theme-select').value = 'cursor';
                applyTheme('cursor');
            }
            if (settings.autoSaveInterval) {
                document.getElementById('auto-save-interval').value = settings.autoSaveInterval;
            }

            // Загружаем настройки Moodle
            if (moodleConfig.url) {
                document.getElementById('moodle-url').value = moodleConfig.url;
            }
            if (moodleConfig.token) {
                document.getElementById('moodle-token').value = moodleConfig.token;
            }
            if (moodleConfig.course) {
                document.getElementById('moodle-course').value = moodleConfig.course;
            }
            
            // Загружаем шаблоны комментариев в настройки
            const savedTemplates = localStorage.getItem('comment-templates');
            if (savedTemplates) {
                try {
                    const templates = JSON.parse(savedTemplates);
                    // Обновляем глобальный массив commentTemplates
                    commentTemplates = [];
                    for (let i = 1; i <= 6; i++) {
                        const templateValue = templates[`template${i}`] || commentTemplates[i - 1] || '';
                        commentTemplates.push(templateValue);
                        
                        // Заполняем поля в настройках
                        const templateInput = document.getElementById(`template-${i}`);
                        if (templateInput) {
                            templateInput.value = templateValue;
                        }
                    }
                    console.log('📝 Загружены шаблоны комментариев:', commentTemplates);
                } catch (e) {
                    console.error('Ошибка загрузки шаблонов:', e);
                }
            }
            
            // Обновляем статус Moodle
            if (moodleConfig.connected) {
                updateMoodleStatus('connected', `Подключено к ${moodleConfig.siteInfo?.sitename || 'Moodle'}`);
                
                // Автоматически подключаемся к Moodle при старте, если есть URL и токен
                if (moodleConfig.url && moodleConfig.token) {
                    setTimeout(() => {
                        console.log('Автоматическое подключение к Moodle при старте...');
                        testMoodleConnection();
                    }, 1000); // Небольшая задержка для загрузки интерфейса
                }
            } else {
                updateMoodleStatus('disconnected', 'Не подключено');
            }

            console.log('✅ Приложение инициализировано');
        }



        function setupEventListeners() {
            console.log('Настройка обработчиков событий...');
            
            // Обработчик кнопки настроек
            // Обработчики настроены через делегирование событий
            console.log('✅ Обработчики событий настроены через делегирование');
            
            // Добавляем обработчики для автоматического сохранения шаблонов
            for (let i = 1; i <= 6; i++) {
                const templateInput = document.getElementById(`template-${i}`);
                if (templateInput) {
                    templateInput.addEventListener('input', saveTemplatesFromSettings);
                }
            }
            

            
            // Обработчики кнопок Moodle
            const testMoodleBtn = document.getElementById('test-moodle-btn');
            if (testMoodleBtn) {
                testMoodleBtn.addEventListener('click', testMoodleConnection);
                console.log('✅ Обработчик кнопки проверки Moodle добавлен');
            }
            
            const loadAssignmentsBtn = document.getElementById('load-assignments-btn');
            if (loadAssignmentsBtn) {
                loadAssignmentsBtn.addEventListener('click', loadMoodleAssignments);
                console.log('✅ Обработчик кнопки загрузки заданий добавлен');
            }
            
            // Обработчики настроек

            

            
            const themeSelect = document.getElementById('theme-select');
            if (themeSelect) {
                themeSelect.addEventListener('change', changeTheme);
            }
            
            // Обработчики Moodle полей
            const moodleUrl = document.getElementById('moodle-url');
            if (moodleUrl) {
                moodleUrl.addEventListener('change', saveMoodleConfig);
            }
            
            const moodleToken = document.getElementById('moodle-token');
            if (moodleToken) {
                moodleToken.addEventListener('change', saveMoodleConfig);
            }
            
            const moodleCourse = document.getElementById('moodle-course');
            if (moodleCourse) {
                moodleCourse.addEventListener('change', function() {
                    saveMoodleConfig();
                    loadMoodleAssignments();
                });
            }
            
            const moodleAssignment = document.getElementById('moodle-assignment');
            if (moodleAssignment) {
                moodleAssignment.addEventListener('change', onAssignmentSelect);
            }
            
            console.log('Все обработчики событий настроены');
        }




        
        // Очистить список студентов
        function clearStudentsList() {
            console.log('🧹 Очищаем список студентов...');
            
            // Удаляем интерфейс студентов из mainArea
            const mainArea = document.querySelector('.main-area');
            if (mainArea) {
                // Удаляем все элементы, связанные со студентами
                const studentsInterface = mainArea.querySelector('.students-interface');
                if (studentsInterface) {
                    studentsInterface.remove();
                    console.log('✅ Интерфейс студентов удален');
                }
                
                // Удаляем все элементы с классами, содержащими "student"
                const studentElements = mainArea.querySelectorAll('.student-item, .student-card, .student-info, .student-files, .student-grades, .student-list, .student-details');
                studentElements.forEach(element => {
                    element.remove();
                    console.log('✅ Удален элемент студента:', element.className);
                });
                
                // Удаляем элементы с ID, содержащими "student"
                const studentIdElements = mainArea.querySelectorAll('[id*="student"]');
                studentIdElements.forEach(element => {
                    element.remove();
                    console.log('✅ Удален элемент с ID студента:', element.id);
                });
                
                // Удаляем все элементы с классами, содержащими "assignment"
                const assignmentElements = mainArea.querySelectorAll('.assignment-info, .assignment-details, .assignment-files');
                assignmentElements.forEach(element => {
                    element.remove();
                    console.log('✅ Удален элемент задания:', element.className);
                });
                
                // Очищаем весь контент в content-area
                const contentArea = mainArea.querySelector('.content-area');
                if (contentArea) {
                    // Сохраняем только moodle-content, остальное удаляем
                    const moodleContent = contentArea.querySelector('#moodle-content');
                    contentArea.innerHTML = '';
                    if (moodleContent) {
                        moodleContent.innerHTML = '';
                        moodleContent.style.display = 'none';
                        contentArea.appendChild(moodleContent);
                    }
                    console.log('✅ Контент area полностью очищен');
                }
                
                // Очищаем контент moodle-content
                const moodleContent = document.getElementById('moodle-content');
                if (moodleContent) {
                    moodleContent.innerHTML = '';
                    moodleContent.style.display = 'none';
                    console.log('✅ Контент Moodle очищен');
                }
            }
            
            // Очищаем глобальные переменные студентов
            if (moodleConfig.currentAssignment) {
                moodleConfig.currentAssignment.students = [];
                moodleConfig.currentAssignment.submissions = [];
                moodleConfig.currentAssignment.grades = [];
                moodleConfig.currentAssignment.files = [];
                console.log('✅ Все данные текущего задания очищены');
            }
            
            // Очищаем все глобальные переменные
            if (window.currentStudents) {
                window.currentStudents = [];
            }
            if (window.currentSubmissions) {
                window.currentSubmissions = [];
            }
            if (window.currentGrades) {
                window.currentGrades = [];
            }
            if (window.currentFiles) {
                window.currentFiles = [];
            }
            
            console.log('✅ Список студентов полностью очищен');
        }
        

        














        // Сохранение данных
        function saveData() {
            localStorage.setItem('notebook-settings', JSON.stringify(settings));
            localStorage.setItem('notebook-moodle', JSON.stringify(moodleConfig));
        }

        // Сохранение шаблонов комментариев из настроек
        function saveTemplatesFromSettings() {
            const templates = {};
            for (let i = 1; i <= 6; i++) {
                const templateInput = document.getElementById(`template-${i}`);
                if (templateInput) {
                    templates[`template${i}`] = templateInput.value;
                }
            }
            localStorage.setItem('comment-templates', JSON.stringify(templates));
            
            // Обновляем глобальный массив commentTemplates
            commentTemplates = [];
            for (let i = 1; i <= 6; i++) {
                commentTemplates.push(templates[`template${i}`] || '');
            }
            
            console.log('💾 Шаблоны комментариев сохранены из настроек:', templates);
            console.log('💾 Обновлен глобальный массив commentTemplates:', commentTemplates);
        }





        // Функции для настроек (определяем в начале)
        function toggleSettingsSidebar() {
            console.log('🔧 toggleSettingsSidebar вызвана');
            const sidebar = document.getElementById('settings-sidebar');
            console.log('🔧 sidebar элемент:', sidebar);
            if (sidebar) {
            sidebar.classList.toggle('open');
                console.log('🔧 sidebar классы после toggle:', sidebar.className);
            } else {
                console.error('❌ Элемент settings-sidebar не найден');
            }
        }

        function changeFontSize() {
            const fontSize = document.getElementById('font-size-select').value;
            
            // Сохраняем в настройки
            settings.fontSize = fontSize;
            saveData();
        }

        function changeFontFamily() {
            const fontFamily = document.getElementById('font-family-select').value;
            
            // Сохраняем в настройки
            settings.fontFamily = fontFamily;
            saveData();
        }

        function changeLineHeight() {
            const lineHeight = document.getElementById('line-height-select').value;
            
            // Сохраняем в настройки
            settings.lineHeight = lineHeight;
            saveData();
        }

        function toggleAutoSave() {
            const autoSave = document.getElementById('auto-save-toggle').checked;
            settings.autoSave = autoSave;
            saveData();
        }

        function changeAutoSaveInterval() {
            const interval = document.getElementById('auto-save-interval').value;
            settings.autoSaveInterval = parseInt(interval);
            saveData();
        }

        function changeTheme() {
            const theme = document.getElementById('theme-select').value;
            settings.theme = theme;
            applyTheme(theme);
            saveData();
        }

        function applyTheme(theme) {
            const root = document.documentElement;
            
            if (theme === 'dark') {
                root.style.setProperty('--bg-primary', '#000000');
                root.style.setProperty('--bg-secondary', '#0a0a0a');
                root.style.setProperty('--bg-tertiary', '#1a1a1a');
                root.style.setProperty('--bg-sidebar', '#000000');
                root.style.setProperty('--bg-card', '#0a0a0a');
                root.style.setProperty('--text-primary', '#ffffff');
                root.style.setProperty('--text-secondary', '#a3a3a3');
                root.style.setProperty('--text-muted', '#737373');
                root.style.setProperty('--border-color', '#262626');
                root.style.setProperty('--border-hover', '#404040');
            } else if (theme === 'light') {
                root.style.setProperty('--bg-primary', '#ffffff');
                root.style.setProperty('--bg-secondary', '#f8f9fa');
                root.style.setProperty('--bg-tertiary', '#e9ecef');
                root.style.setProperty('--bg-sidebar', '#f8f9fa');
                root.style.setProperty('--bg-card', '#ffffff');
                root.style.setProperty('--text-primary', '#212529');
                root.style.setProperty('--text-secondary', '#6c757d');
                root.style.setProperty('--text-muted', '#adb5bd');
                root.style.setProperty('--border-color', '#dee2e6');
                root.style.setProperty('--border-hover', '#ced4da');
            } else { // cursor theme (dark gray)
                root.style.setProperty('--bg-primary', '#1e1e1e');
                root.style.setProperty('--bg-secondary', '#252526');
                root.style.setProperty('--bg-tertiary', '#2d2d30');
                root.style.setProperty('--bg-sidebar', '#252526');
                root.style.setProperty('--bg-card', '#1e1e1e');
                root.style.setProperty('--text-primary', '#cccccc');
                root.style.setProperty('--text-secondary', '#969696');
                root.style.setProperty('--text-muted', '#6a6a6a');
                root.style.setProperty('--border-color', '#3c3c3c');
                root.style.setProperty('--border-hover', '#4a4a4a');
            }
        }



        // Moodle Integration Functions
        function saveMoodleConfig() {
            const url = document.getElementById('moodle-url').value;
            const token = document.getElementById('moodle-token').value;
            const course = document.getElementById('moodle-course').value;
            
            moodleConfig = {
                url: url,
                token: token,
                course: course,
                connected: false
            };
            
            saveData();
            updateMoodleStatus('disconnected', 'Настройки сохранены');
        }

        async function testMoodleConnection() {
            const url = document.getElementById('moodle-url').value;
            const token = document.getElementById('moodle-token').value;
            
            if (!url || !token) {
                updateMoodleStatus('error', 'Введите URL и токен');
                return;
            }
            
            updateMoodleStatus('loading', 'Проверка подключения...');
            
            try {
                // Проверяем подключение к Moodle API
                const response = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=core_webservice_get_site_info&moodlewsrestformat=json`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.errorcode) {
                        throw new Error(data.message || 'Ошибка подключения к Moodle');
                    }
                    
                    console.log('Успешное подключение к Moodle:', data);
                    
                    // Получаем список курсов
                    await loadMoodleCourses();
                    
                    moodleConfig.connected = true;
                    moodleConfig.siteInfo = data;
                    saveData();
                    
                    updateMoodleStatus('connected', `Подключено к ${data.sitename || 'Moodle'}`);
                } else {
                    throw new Error('Не удалось подключиться к Moodle');
                }
            } catch (error) {
                console.error('Moodle connection error:', error);
                updateMoodleStatus('error', `Ошибка: ${error.message}`);
                moodleConfig.connected = false;
                saveData();
            }
        }



        async function testLoadStudents() {
            const url = document.getElementById('moodle-url').value;
            const token = document.getElementById('moodle-token').value;
            const courseId = document.getElementById('moodle-course').value;
            const assignmentId = document.getElementById('moodle-assignment').value;
            
            if (!courseId || !assignmentId) {
                alert('Сначала выберите курс и задание');
                return;
            }
            
            console.log('Тестирование загрузки студентов...');
            updateMoodleStatus('loading', 'Тест загрузки студентов...');
            
            try {
                await loadAssignmentSubmissions();
                updateMoodleStatus('connected', 'Тест студентов завершен');
            } catch (error) {
                console.error('Ошибка тестирования студентов:', error);
                updateMoodleStatus('error', `Ошибка: ${error.message}`);
            }
        }

        /**
         * Тестирует получение всех данных курса
         */
        async function testGetAllCourseData() {
            console.log('🧪 Тестирование получения всех данных курса...');
            
            try {
                const url = document.getElementById('moodle-url').value;
                const token = document.getElementById('moodle-token').value;
                const courseId = document.getElementById('moodle-course').value;
                
                if (!url || !token || !courseId) {
                    alert('❌ Заполните URL, токен и выберите курс');
                    return;
                }
                
                updateMoodleStatus('loading', 'Получение всех данных курса...');
                
                // Получаем все задания курса
                await loadMoodleAssignments(); // Загружаем задания в select
                const assignmentSelect = document.getElementById('moodle-assignment');
                const assignmentIds = [];
                
                // Собираем ID всех заданий из select
                for (let i = 0; i < assignmentSelect.options.length; i++) {
                    const option = assignmentSelect.options[i];
                    if (option.value && option.value !== '') {
                        assignmentIds.push(parseInt(option.value));
                    }
                }
                
                // Получаем всех пользователей курса
                const users = await loadMoodleUsers(courseId, url, token);
                
                console.log(`📋 Найдено ${assignmentIds.length} заданий и ${users.length} пользователей`);
                
                // Получаем все данные
                const courseData = await getAllCourseData(assignmentIds, users, url, token);
                
                console.log('📊 Полученные данные курса:', courseData);
                
                // Экспортируем в JSON
                const filename = `course-${courseId}-data-${new Date().toISOString().split('T')[0]}.json`;
                exportDataToJSON(courseData, filename);
                
                updateMoodleStatus('connected', `Данные получены: ${courseData.flatData.length} записей`);
                alert(`✅ Данные курса получены и экспортированы!\n📊 Записей: ${courseData.flatData.length}\n👥 Студентов: ${courseData.groupedByUser.length}`);
                
            } catch (error) {
                console.error('❌ Ошибка при тестировании:', error);
                updateMoodleStatus('error', `Ошибка: ${error.message}`);
                alert(`❌ Ошибка: ${error.message}`);
            }
        }

        /**
         * Тестирует все пары assignmentId + userId для отладки
         */
        async function testAllSubmissionStatuses() {
            console.log('🧪 Тестирование всех пар assignmentId + userId...');
            
            try {
                const url = document.getElementById('moodle-url').value;
                const token = document.getElementById('moodle-token').value;
                const assignmentId = document.getElementById('moodle-assignment').value;
                const courseId = document.getElementById('moodle-course').value;
                
                if (!url || !token || !assignmentId || !courseId) {
                    alert('❌ Заполните URL, токен, выберите курс и задание');
                    return;
                }
                
                console.log('📋 Параметры тестирования:', {
                    url: url,
                    assignmentId: assignmentId,
                    courseId: courseId,
                    hasToken: !!token
                });
                
                // Получаем список пользователей
                const usersResponse = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=core_enrol_get_enrolled_users&courseid=${courseId}&moodlewsrestformat=json`);
                
                if (!usersResponse.ok) {
                    alert('❌ Не удалось получить список пользователей');
                    return;
                }
                
                const users = await usersResponse.json();
                console.log(`👥 Получено ${users.length} пользователей для тестирования`);
                
                // Тестируем первые 5 пользователей (чтобы не перегружать API)
                const testUsers = users.slice(0, 5);
                const results = [];
                
                for (const user of testUsers) {
                    console.log(`\n🔍 Тестируем пользователя: ${user.fullname} (ID: ${user.id})`);
                    
                    const status = await getSubmissionStatus(assignmentId, user.id, url, token);
                    
                    const result = {
                        user: user.fullname,
                        userId: user.id,
                        assignmentId: assignmentId,
                        success: !!status,
                        error: status ? null : 'API вернул ошибку'
                    };
                    
                    results.push(result);
                    console.log(`📊 Результат для ${user.fullname}:`, result);
                    
                    // Небольшая пауза между запросами
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // Показываем сводку
                const successCount = results.filter(r => r.success).length;
                const errorCount = results.filter(r => !r.success).length;
                
                console.log('\n📊 Сводка тестирования:', {
                    total: results.length,
                    success: successCount,
                    errors: errorCount,
                    results: results
                });
                
                alert(`📊 Тестирование завершено!\n\n✅ Успешно: ${successCount}\n❌ Ошибок: ${errorCount}\n\nДетали в консоли.`);
                
            } catch (error) {
                console.error('❌ Ошибка при тестировании:', error);
                alert(`❌ Ошибка: ${error.message}`);
            }
        }
        /**
         * Тестирует получение статуса сдачи
         */
        async function testSubmissionStatus() {
            console.log('🧪 Тестирование getSubmissionStatus...');
            
            try {
                const url = document.getElementById('moodle-url').value;
                const token = document.getElementById('moodle-token').value;
                const assignmentId = document.getElementById('moodle-assignment').value;
                
                if (!url || !token || !assignmentId) {
                    alert('❌ Заполните URL, токен и выберите задание');
                    return;
                }
                
                // Тестируем с первым пользователем из курса
                const courseId = document.getElementById('moodle-course').value;
                const usersResponse = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=core_enrol_get_enrolled_users&courseid=${courseId}&moodlewsrestformat=json`);
                
                if (usersResponse.ok) {
                    const users = await usersResponse.json();
                    if (users.length > 0) {
                        const testUser = users[0];
                        console.log(`🧪 Тестируем с пользователем: ${testUser.fullname} (ID: ${testUser.id})`);
                        
                        const status = await getSubmissionStatus(assignmentId, testUser.id, url, token);
                        
                        if (status) {
                            alert(`✅ Статус получен для ${testUser.fullname}!\n\nДетали в консоли.`);
                            console.log('📊 Полный статус:', status);
                        } else {
                            alert(`❌ Не удалось получить статус для ${testUser.fullname}`);
                        }
                    } else {
                        alert('❌ Нет пользователей в курсе для тестирования');
                    }
                } else {
                    alert('❌ Не удалось получить список пользователей курса');
                }
                
            } catch (error) {
                console.error('❌ Ошибка при тестировании:', error);
                alert(`❌ Ошибка: ${error.message}`);
            }
        }

        /**
         * Тестирует скачивание файла
         */
        async function testDownloadFile() {
            console.log('🧪 Тестирование скачивания файла...');
            
            try {
                // Создаем тестовый файл
                const testFile = {
                    fileurl: 'https://httpbin.org/json',
                    filename: 'test-file.json'
                };
                
                await MoodleDataModule.downloadFile(testFile.fileurl, testFile.filename);
                alert('✅ Тестовый файл успешно скачан!');
                
            } catch (error) {
                console.error('❌ Ошибка при тестировании скачивания:', error);
                alert(`❌ Ошибка скачивания: ${error.message}`);
            }
        }

        /**
         * Загружает всех пользователей курса
         */
        async function loadMoodleUsers(courseId, url, token) {
            console.log(`👥 Загрузка пользователей курса ${courseId}...`);
            
            try {
                const params = new URLSearchParams({
                    wstoken: token,
                    wsfunction: 'core_enrol_get_enrolled_users',
                    courseid: courseId,
                    moodlewsrestformat: 'json'
                });
                
                const response = await fetch(`${url}/webservice/rest/server.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(`✅ Загружено ${data.length} пользователей курса`);
                return data;
                
            } catch (error) {
                console.error('❌ Ошибка при загрузке пользователей:', error);
                throw error;
            }
        }

        async function refreshAssignments() {
            const courseId = document.getElementById('moodle-course').value;
            if (!courseId) {
                alert('Сначала выберите курс');
                return;
            }
            
            console.log('Обновление списка заданий...');
            updateMoodleStatus('loading', 'Обновление заданий...');
            
            try {
                await loadMoodleAssignments();
                updateMoodleStatus('connected', 'Задания обновлены');
            } catch (error) {
                console.error('Ошибка обновления заданий:', error);
                updateMoodleStatus('error', `Ошибка: ${error.message}`);
            }
        }

        function onAssignmentSelect() {
            console.log('🔄 onAssignmentSelect вызвана');
            
            const assignmentSelect = document.getElementById('moodle-assignment');
            const assignmentId = assignmentSelect.value;
            const noteControls = document.getElementById('note-controls');
            const assignmentControls = document.getElementById('assignment-controls');
            const titleInput = document.getElementById('title-input');
            
            console.log('📋 Выбранное задание:', {
                assignmentId: assignmentId,
                assignmentText: assignmentSelect.options[assignmentSelect.selectedIndex]?.text || 'не выбрано'
            });
            
            console.log('🔍 Проверка элементов интерфейса:', {
                noteControls: !!noteControls,
                assignmentControls: !!assignmentControls,
                titleInput: !!titleInput,
                assignmentSelect: !!assignmentSelect
            });
            
            if (assignmentId) {
                console.log('✅ Задание выбрано, переключаемся на интерфейс заданий');
                
                // Показываем интерфейс задания
                const selectedAssignmentText = assignmentSelect.options[assignmentSelect.selectedIndex].text;
                const courseSelect = document.getElementById('moodle-course');
                const selectedCourseText = courseSelect ? courseSelect.options[courseSelect.selectedIndex]?.text || 'Курс не выбран' : 'Курс не выбран';
                console.log('📝 Название выбранного задания:', selectedAssignmentText);
                console.log('📚 Название выбранного курса:', selectedCourseText);
                
                const assignmentTitleElement = document.getElementById('assignment-title');
                if (assignmentTitleElement) {
                    assignmentTitleElement.textContent = `${selectedAssignmentText} | ${selectedCourseText}`;
                    console.log('✅ Заголовок задания и курса обновлен');
                } else {
                    console.log('❌ Элемент assignment-title не найден');
                }
                
                if (titleInput) {
                titleInput.placeholder = ''; // Убираем дублирование
                titleInput.value = ''; // Очищаем поле
                titleInput.readOnly = true;
                    console.log('✅ Поле заголовка настроено для режима задания');
                }
                
                // Скрываем элементы заметок
                if (noteControls) {
                noteControls.style.display = 'none';
                    console.log('✅ Элементы заметок скрыты');
                } else {
                    console.log('❌ Элемент note-controls не найден');
                }
                

                
                if (assignmentControls) {
                assignmentControls.style.display = 'flex';
                    console.log('✅ Элементы заданий показаны');
                } else {
                    console.log('❌ Элемент assignment-controls не найден');
                }
                
                // Скрываем статус бар
                const statusBar = document.querySelector('.status-bar');
                if (statusBar) {
                    statusBar.style.display = 'none';
                    console.log('✅ Статус бар скрыт');
                } else {
                    console.log('❌ Статус бар не найден');
                }
                
                // Скрываем подсказку "Начните писать вашу заметку..."
                const contentTextarea = document.getElementById('content-textarea');
                if (contentTextarea) {
                    contentTextarea.placeholder = '';
                    contentTextarea.value = '';
                    contentTextarea.readOnly = true;
                    console.log('✅ Текстовое поле настроено для режима задания');
                } else {
                    console.log('❌ Текстовое поле не найдено');
                }
                
                console.log('🚀 Запускаем загрузку студентов...');
                
                // Принудительно очищаем текущий список студентов
                clearStudentsList();
                
                // Полностью очищаем кэш текущего задания
                moodleConfig.currentAssignment = null;
                console.log('✅ Кэш текущего задания полностью очищен');
                
                // Очищаем все глобальные переменные, связанные с предыдущим заданием
                if (window.currentStudents) {
                    window.currentStudents = [];
                }
                if (window.currentSubmissions) {
                    window.currentSubmissions = [];
                }
                if (window.currentGrades) {
                    window.currentGrades = [];
                }
                console.log('✅ Все глобальные переменные очищены');
                
                // Небольшая задержка для полной очистки DOM
                setTimeout(() => {
                    console.log('🔄 Начинаем загрузку данных для нового задания...');
                    // Загружаем студентов для нового задания
                loadAssignmentSubmissions();
                }, 200);
            } else {
                console.log('❌ Задание не выбрано, возвращаемся к заметкам');
                
                // Показываем интерфейс заметок
                if (titleInput) {
                titleInput.placeholder = 'Название заметки...';
                titleInput.value = '';
                titleInput.readOnly = false;
                    console.log('✅ Поле заголовка настроено для режима заметок');
                }
                
                // Показываем элементы заметок
                if (noteControls) {
                noteControls.style.display = 'flex';
                    console.log('✅ Элементы заметок показаны');
                }
                
                if (assignmentControls) {
                assignmentControls.style.display = 'none';
                    console.log('✅ Элементы заданий скрыты');
                }
                
                // Показываем статус бар
                const statusBar = document.querySelector('.status-bar');
                if (statusBar) {
                    statusBar.style.display = 'flex';
                    console.log('✅ Статус бар показан');
                }
                
                // Восстанавливаем подсказку "Начните писать вашу заметку..."
                const contentTextarea = document.getElementById('content-textarea');
                if (contentTextarea) {
                    contentTextarea.placeholder = 'Начните писать вашу заметку...';
                    contentTextarea.value = '';
                    contentTextarea.readOnly = false;
                    console.log('✅ Текстовое поле настроено для режима заметок');
                }
                

            }
        }

        async function loadMoodleCourses() {
            const url = document.getElementById('moodle-url').value;
            const token = document.getElementById('moodle-token').value;
            
            console.log('Загрузка курсов...', { url, token: token ? '***' : 'не указан' });
            
            try {
                // Сначала попробуем получить информацию о текущем пользователе
                const userResponse = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=core_webservice_get_site_info&moodlewsrestformat=json`);
                
                if (!userResponse.ok) {
                    throw new Error(`HTTP ${userResponse.status}: ${userResponse.statusText}`);
                }
                
                const userData = await userResponse.json();
                console.log('Информация о пользователе:', userData);
                
                if (userData.errorcode) {
                    throw new Error(userData.message || 'Ошибка получения информации о пользователе');
                }
                
                // Теперь получаем курсы пользователя
                const coursesResponse = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=core_enrol_get_users_courses&userid=${userData.userid || 1}&moodlewsrestformat=json`);
                
                if (!coursesResponse.ok) {
                    throw new Error(`HTTP ${coursesResponse.status}: ${coursesResponse.statusText}`);
                }
                
                const courses = await coursesResponse.json();
                console.log('Полученные курсы:', courses);
                
                if (Array.isArray(courses)) {
                    const courseSelect = document.getElementById('moodle-course');
                    courseSelect.innerHTML = '<option value="">Выберите курс...</option>';
                    
                    courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.fullname || course.shortname || `Курс ${course.id}`;
                        courseSelect.appendChild(option);
                        console.log('Добавлен курс:', course.fullname, 'ID:', course.id);
                    });
                    
                    // Восстанавливаем выбранный курс
                    if (moodleConfig.course) {
                        courseSelect.value = moodleConfig.course;
                    }
                    
                    console.log(`Загружено ${courses.length} курсов`);
                    
                    if (courses.length === 0) {
                        console.log('Курсы не найдены. Возможно, пользователь не записан ни на один курс.');
                    } else {
                        // Если есть курсы, автоматически выбираем первый и загружаем задания
                        if (!moodleConfig.course) {
                            courseSelect.value = courses[0].id;
                            await loadMoodleAssignments();
                        }
                    }
                } else {
                    console.error('Неожиданный формат ответа курсов:', courses);
                    if (courses.errorcode) {
                        throw new Error(courses.message || 'Ошибка получения курсов');
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки курсов:', error);
                updateMoodleStatus('error', `Ошибка загрузки курсов: ${error.message}`);
            }
        }



        function updateMoodleStatus(status, message) {
            const indicator = document.getElementById('moodle-status-indicator');
            const statusText = document.getElementById('moodle-status-text');
            
            indicator.className = 'status-indicator';
            
            switch (status) {
                case 'connected':
                    indicator.classList.add('connected');
                    break;
                case 'error':
                    indicator.classList.add('error');
                    break;
                case 'loading':
                    indicator.classList.add('loading');
                    break;
                default:
                    // disconnected - использует базовый класс
                    break;
            }
            
            statusText.textContent = message;
        }

        // Альтернативная функция для получения всех курсов
        async function loadAllMoodleCourses() {
            const url = document.getElementById('moodle-url').value;
            const token = document.getElementById('moodle-token').value;
            
            console.log('Загрузка всех курсов...');
            updateMoodleStatus('loading', 'Загрузка всех курсов...');
            
            try {
                // Получаем все курсы (требует права администратора)
                const response = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=core_course_get_courses&moodlewsrestformat=json`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const courses = await response.json();
                console.log('Все курсы:', courses);
                
                if (Array.isArray(courses)) {
                    const courseSelect = document.getElementById('moodle-course');
                    courseSelect.innerHTML = '<option value="">Выберите курс...</option>';
                    
                    courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.fullname || course.shortname || `Курс ${course.id}`;
                        courseSelect.appendChild(option);
                    });
                    
                    updateMoodleStatus('connected', `Загружено ${courses.length} курсов`);
                    console.log(`Загружено ${courses.length} курсов`);
                } else {
                    throw new Error('Неожиданный формат ответа');
                }
            } catch (error) {
                console.error('Ошибка загрузки всех курсов:', error);
                updateMoodleStatus('error', `Ошибка: ${error.message}`);
            }
        }

        // Функции для работы с заданиями Moodle
        async function loadMoodleAssignments() {
            const url = document.getElementById('moodle-url').value;
            const token = document.getElementById('moodle-token').value;
            const courseId = document.getElementById('moodle-course').value;
            
            if (!courseId) {
                // Очищаем список заданий если курс не выбран
                const assignmentSelect = document.getElementById('moodle-assignment');
                assignmentSelect.innerHTML = '<option value="">Выберите задание...</option>';
                return;
            }
            
            console.log('Загрузка заданий для курса:', courseId);
            updateMoodleStatus('loading', 'Загрузка заданий...');
            
            try {
                let assignments = [];
                
                // Сначала попробуем получить задания в правильном порядке через core_course_get_contents
                console.log('Загрузка заданий в правильном порядке через core_course_get_contents...');
                
                try {
                    const response = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=core_course_get_contents&courseid=${courseId}&moodlewsrestformat=json`);
                    
                    if (response.ok) {
                        const courseContent = await response.json();
                        console.log('Содержимое курса:', courseContent);
                        
                        // Собираем все задания в правильном порядке
                        courseContent.forEach(section => {
                            if (section.modules) {
                                section.modules.forEach(mod => {
                                    if (mod.modname === 'assign') {
                                        console.log(`📝 Найдено задание в правильном порядке: ${mod.name}`, {
                                            id: mod.instance, // assignment id в базе данных
                                            cmid: mod.id,     // course module id
                                            name: mod.name,
                                            section: section.name || 'Без раздела'
                                        });
                                        
                                        assignments.push({
                                            id: mod.instance, // Используем instance вместо id для API
                                            cmid: mod.id,     // Сохраняем cmid для отладки
                                            name: mod.name,
                                            description: mod.description || '',
                                            duedate: mod.duedate || null,
                                            allowsubmissionsfromdate: mod.allowsubmissionsfromdate || null,
                                            cutofdate: mod.cutofdate || null,
                                            section: section.name || 'Без раздела',
                                            sectionid: section.id || 0
                                        });
                                    }
                                });
                            }
                        });
                        
                        console.log(`Найдено ${assignments.length} заданий через core_course_get_contents в правильном порядке`);
                    } else {
                        console.log('core_course_get_contents вернул ошибку:', response.status);
                    }
                } catch (error) {
                    console.log('Ошибка core_course_get_contents:', error.message);
                }
                
                // Если не удалось получить через core_course_get_contents, используем mod_assign_get_assignments
                if (assignments.length === 0) {
                    console.log('Пробуем загрузку заданий через mod_assign_get_assignments...');
                    
                    try {
                        const assignmentResponse = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=mod_assign_get_assignments&courseids[0]=${courseId}&moodlewsrestformat=json`);
                        
                        if (assignmentResponse.ok) {
                            const assignmentData = await assignmentResponse.json();
                            console.log('Данные заданий:', assignmentData);
                            
                            if (assignmentData.courses && assignmentData.courses[0] && assignmentData.courses[0].assignments) {
                                assignments = assignmentData.courses[0].assignments.map(assignment => {
                                    console.log(`📝 Найдено задание: ${assignment.name}`, {
                                        id: assignment.id,
                                        name: assignment.name
                                    });
                                    
                                    return {
                                        id: assignment.id,
                                        name: assignment.name,
                                        description: assignment.intro || '',
                                        duedate: assignment.duedate || null,
                                        allowsubmissionsfromdate: assignment.allowsubmissionsfromdate || null,
                                        cutofdate: assignment.cutoffdate || null,
                                        section: 'Задания',
                                        sectionid: 0
                                    };
                                });
                            }
                            
                            console.log(`Найдено ${assignments.length} заданий через mod_assign_get_assignments`);
                        } else {
                            console.log('mod_assign_get_assignments вернул ошибку:', assignmentResponse.status);
                        }
                    } catch (error) {
                        console.log('Ошибка mod_assign_get_assignments:', error.message);
                    }
                }
                
                // Если задания не найдены, оставляем список пустым
                if (assignments.length === 0) {
                    console.log('Задания не найдены в курсе');
                }
                
                console.log('Итоговые найденные задания:', assignments);
                
                // Обновляем селект заданий
                const assignmentSelect = document.getElementById('moodle-assignment');
                assignmentSelect.innerHTML = '<option value="">Выберите задание...</option>';
                
                assignments.forEach(assignment => {
                    const option = document.createElement('option');
                    option.value = assignment.id;
                    // Показываем раздел курса, если он есть
                    const displayName = assignment.section && assignment.section !== 'Без раздела' 
                        ? `${assignment.section}: ${assignment.name}`
                        : assignment.name;
                    option.textContent = displayName;
                    assignmentSelect.appendChild(option);
                });
                
                if (assignments.length > 0) {
                    updateMoodleStatus('connected', `Найдено ${assignments.length} заданий`);
                    
                    // Сохраняем задания в конфигурации
                    moodleConfig.assignments = assignments;
                    saveData();
                    
                    // Не загружаем студентов автоматически - пусть пользователь выберет задание сам
                    console.log('✅ Задания загружены. Выберите задание для загрузки студентов.');
                } else {
                    updateMoodleStatus('warning', 'В этом курсе нет заданий для оценки');
                }
                
            } catch (error) {
                console.error('Ошибка загрузки заданий:', error);
                updateMoodleStatus('error', `Ошибка: ${error.message}`);
            }
        }
        async function loadAssignmentSubmissions() {
            console.log('🚀 loadAssignmentSubmissions вызвана');
            
            // Принудительно очищаем все предыдущие данные
            clearStudentsList();
            
            const assignmentSelect = document.getElementById('moodle-assignment');
            if (!assignmentSelect) {
                console.log('❌ Элемент moodle-assignment не найден');
                return;
            }
            
            const assignmentId = assignmentSelect.value;
            
            console.log('📋 Параметры загрузки:', {
                assignmentId: assignmentId,
                hasAssignmentId: !!assignmentId,
                assignmentSelectExists: !!assignmentSelect,
                selectedIndex: assignmentSelect.selectedIndex,
                optionsCount: assignmentSelect.options.length
            });
            
            if (!assignmentId) {
                console.log('❌ ID задания не найден, прерываем загрузку');
                const assignmentInfo = document.getElementById('assignment-info');
                if (assignmentInfo) {
                    assignmentInfo.style.display = 'none';
                }
                return;
            }
            
            const url = document.getElementById('moodle-url').value;
            const token = document.getElementById('moodle-token').value;
            
            console.log('🔗 Параметры подключения:', {
                url: url,
                hasToken: !!token,
                tokenLength: token ? token.length : 0
            });
            
            console.log('Загрузка ответов для задания:', assignmentId);
            updateMoodleStatus('loading', 'Загрузка ответов...');
            
            // Сохраняем информацию о текущем задании
            const selectedAssignmentText = assignmentSelect.options[assignmentSelect.selectedIndex].text;
            moodleConfig.currentAssignment = {
                id: assignmentId,
                name: selectedAssignmentText
            };
            
            // Сначала проверим, что задание действительно существует
            const courseId = document.getElementById('moodle-course').value;
            try {
                const assignmentCheckResponse = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=mod_assign_get_assignments&courseids[0]=${courseId}&moodlewsrestformat=json`);
                if (assignmentCheckResponse.ok) {
                    const assignmentCheckData = await assignmentCheckResponse.json();
                    console.log('Проверка доступных заданий:', assignmentCheckData);
                    
                    // Проверяем, есть ли ошибка в ответе
                    if (assignmentCheckData.exception || assignmentCheckData.errorcode) {
                        console.log('Ошибка при проверке заданий:', assignmentCheckData);
                        throw new Error(assignmentCheckData.message || 'Ошибка проверки заданий');
                    }
                    
                    if (assignmentCheckData.courses && assignmentCheckData.courses[0] && assignmentCheckData.courses[0].assignments) {
                        const availableAssignments = assignmentCheckData.courses[0].assignments;
                        console.log('Доступные задания в курсе:', availableAssignments.map(a => ({id: a.id, name: a.name})));
                        
                        // Проверяем, есть ли задание с таким ID
                        const foundAssignment = availableAssignments.find(a => a.id == assignmentId);
                        
                        if (!foundAssignment) {
                            console.log(`⚠️ Задание с ID ${assignmentId} не найдено в курсе ${courseId}`);
                            console.log('Доступные задания:', availableAssignments.map(a => ({id: a.id, name: a.name})));
                            
                            // Показываем предупреждение пользователю
                            updateMoodleStatus('warning', `Задание ${assignmentId} не найдено. Возможно, ID неверный.`);
                            
                            // Продолжаем загрузку, но с предупреждением
                            console.log('Продолжаем загрузку с предупреждением...');
                        } else {
                            console.log('✅ Задание найдено:', foundAssignment);
                        }
                    }
                }
            } catch (error) {
                console.log('Ошибка проверки задания:', error);
                console.log('Продолжаем загрузку без проверки существования задания...');
            }
            
            try {
                let assignment = null;
                
                // Создаем базовую информацию о задании
                console.log('Создание базовой информации о задании...');
                
                // Пробуем получить информацию через API
                try {
                    console.log('Получение информации о задании через API...');
                    const assignmentResponse = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=mod_assign_get_assignments&assignmentids[0]=${assignmentId}&moodlewsrestformat=json`);
                    
                    if (assignmentResponse.ok) {
                        const assignmentData = await assignmentResponse.json();
                        console.log('Данные задания:', assignmentData);
                        
                        // Проверяем, является ли ошибка связанной с недействительным токеном
                        if (assignmentData.exception && assignmentData.errorcode === 'invalidtoken') {
                            showNotification('warning', 'Токен Moodle устарел. Пожалуйста, обновите токен в настройках.', 10000);
                        }
                        
                        if (assignmentData.assignments && assignmentData.assignments[0]) {
                            assignment = assignmentData.assignments[0];
                            console.log('Информация о задании получена:', assignment.name);
                        }
                    }
                } catch (error) {
                    console.log('Ошибка получения информации о задании:', error.message);
                }
                
                // Если не удалось получить через API, создаем базовую информацию
                if (!assignment) {
                    assignment = {
                        id: assignmentId,
                        name: `Задание ${assignmentId}`,
                        intro: '',
                        duedate: null,
                        allowsubmissionsfromdate: null,
                        cutoffdate: null
                    };
                }
                
                // Теперь получаем список пользователей курса
                const courseId = document.getElementById('moodle-course').value;
                const usersResponse = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=core_enrol_get_enrolled_users&courseid=${courseId}&moodlewsrestformat=json`);
                
                if (!usersResponse.ok) {
                    throw new Error(`HTTP ${usersResponse.status}: ${usersResponse.statusText}`);
                }
                
                const usersData = await usersResponse.json();
                console.log('Пользователи курса:', usersData);
                

                
                // Получаем участников задания через core_enrol_get_enrolled_users
                console.log('Получение участников задания...');
                
                let submissionsData = null;
                let apiUsed = '';
                
                // Используем только рабочий метод - core_enrol_get_enrolled_users
                try {
                    console.log('Получаем участников через core_enrol_get_enrolled_users...');
                    const usersResponse2 = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=core_enrol_get_enrolled_users&courseid=${courseId}&moodlewsrestformat=json`);
                    
                    if (usersResponse2.ok) {
                        const usersData2 = await usersResponse2.json();
                        // Создаем структуру данных как будто это участники
                        submissionsData = {
                            participants: usersData2.map(user => ({
                                id: user.id,
                                fullname: user.fullname,
                                email: user.email,
                                department: user.department || user.institution || '', // Добавляем группу или институт
                                submitted: false,
                                requiresgrading: false,
                                grade: null
                            }))
                        };
                        apiUsed = 'core_enrol_get_enrolled_users';
                        console.log('Создали данные из пользователей курса:', submissionsData);
                    } else {
                        console.log('core_enrol_get_enrolled_users вернул ошибку:', usersResponse2.status);
                    }
                } catch (error) {
                    console.log('Ошибка core_enrol_get_enrolled_users:', error.message);
                }
                
                // Метод 3: mod_assign_get_user_flags (для получения флагов пользователей)
                if (!submissionsData || submissionsData.participants) {
                    try {
                        console.log('Пробуем mod_assign_get_user_flags...');
                        const userFlagsResponse = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=mod_assign_get_user_flags&assignmentid=${assignmentId}&moodlewsrestformat=json`);
                        
                        if (userFlagsResponse.ok) {
                            const userFlagsData = await userFlagsResponse.json();
                            console.log('Данные user_flags:', userFlagsData);
                            
                            // Если у нас есть участники, дополняем их данными флагов
                            if (submissionsData && submissionsData.participants) {
                                submissionsData.userFlags = userFlagsData;
                            }
                        } else {
                            console.log('mod_assign_get_user_flags вернул ошибку:', userFlagsResponse.status);
                        }
                    } catch (error) {
                        console.log('Ошибка mod_assign_get_user_flags:', error.message);
                    }
                }
                
                // Метод 3: Если предыдущие не сработали, используем core_enrol_get_enrolled_users
                if (!submissionsData || submissionsData.exception) {
                    console.log('Используем core_enrol_get_enrolled_users как fallback...');
                    
                    // Создаем структуру данных, совместимую с нашим кодом
                    submissionsData = {
                        participants: usersData.map(user => ({
                            id: user.id,
                            fullname: user.fullname,
                            email: user.email,
                            department: user.department || '', // Добавляем группу
                            submitted: false, // По умолчанию не сдано
                            requiresgrading: false,
                            grade: null
                        }))
                    };
                    apiUsed = 'core_enrol_get_enrolled_users (fallback)';
                    console.log(`Создан fallback список из ${usersData.length} пользователей`);
                }
                
                // Проверяем, что у нас есть данные участников
                if (!submissionsData || !submissionsData.participants) {
                    console.log('❌ Не удалось получить данные участников ни одним из методов');
                    console.log('Создаем базовый список из пользователей курса...');
                    
                    submissionsData = {
                        participants: usersData.map(user => ({
                            id: user.id,
                            fullname: user.fullname,
                            email: user.email,
                            submitted: false,
                            requiresgrading: false,
                            grade: null
                        }))
                    };
                    apiUsed = 'core_enrol_get_enrolled_users (final fallback)';
                    console.log(`Создан финальный fallback список из ${usersData.length} пользователей`);
                }

                // Получаем оценки и файлы для всех участников
                console.log('Получение оценок и файлов...');
                console.log('📊 Данные для передачи в getGradesAndFiles:', {
                    assignmentId: assignmentId,
                    participantsExists: !!submissionsData.participants,
                    participantsLength: submissionsData.participants ? submissionsData.participants.length : 'undefined',
                    url: moodleConfig.url,
                    tokenExists: !!moodleConfig.token
                });
                
                const gradesAndFiles = await getGradesAndFiles(assignmentId, submissionsData.participants, moodleConfig.url, moodleConfig.token);
                console.log('Полученные оценки и файлы:', gradesAndFiles);
                
                // Если gradesAndFiles пустой, создаем базовые данные
                if (!gradesAndFiles || gradesAndFiles.length === 0) {
                    console.log('⚠️ gradesAndFiles пустой, создаем базовые данные...');
                    const basicGradesAndFiles = submissionsData.participants.map(participant => ({
                        userId: participant.id,
                        fullName: participant.fullname,
                        assignmentId: assignmentId,
                        grade: null,
                        files: []
                    }));
                    console.log('📊 Созданные базовые данные:', basicGradesAndFiles);
                }
                
                // Проверяем, что у нас есть участники
                if (!submissionsData.participants || !Array.isArray(submissionsData.participants)) {
                    console.log('❌ Нет данных участников для обработки');
                    throw new Error('Нет данных участников');
                }
                
                // Объединяем данные участников с оценками и файлами
                const enrichedParticipants = await Promise.all(submissionsData.participants.map(async (participant) => {
                    const gradeData = gradesAndFiles.find(g => g.userId == participant.id);
                    
                    // Получаем детальный статус сдачи для каждого участника
                    console.log(`🔍 Получение статуса сдачи для ${participant.fullname} (ID: ${participant.id})`);
                    console.log(`🔍 assignmentId для вызова:`, assignmentId, typeof assignmentId);
                    console.log(`🔍 participant.id для вызова:`, participant.id, typeof participant.id);
                    console.log(`🔍 moodleConfig.url:`, moodleConfig.url);
                    console.log(`🔍 moodleConfig.token:`, moodleConfig.token ? "Есть" : "Нет");
                    
                    let submissionStatus = null;
                    try {
                        submissionStatus = await getSubmissionStatus(assignmentId, participant.id, moodleConfig.url, moodleConfig.token);
                    } catch (error) {
                        console.log(`⚠️ Ошибка получения статуса для ${participant.fullname}:`, error.message);
                        // Продолжаем работу без детального статуса
                    }
                    
                    // Определяем статус сдачи на основе детальной информации
                    let submitted = participant.submitted || false;
                    let submissionText = '';
                    let submissionFiles = [];
                    
                    // Приоритет: файлы и оценки
                    if (gradeData && (gradeData.files.length > 0 || gradeData.grade !== null)) {
                        submitted = true;
                        console.log(`📊 Статус для ${participant.fullname}: сдано (есть файлы или оценки)`);
                    } else if (submissionStatus && submissionStatus.gradingsummary) {
                        // Используем данные из API статуса
                        submitted = submissionStatus.gradingsummary.submissionsenabled && 
                                   (submissionStatus.gradingsummary.submittedcount > 0 || 
                                    submissionStatus.gradingsummary.needssubmission === false);
                        
                        console.log(`📊 Статус для ${participant.fullname}:`, {
                            submitted: submitted,
                            submissionsenabled: submissionStatus.gradingsummary.submissionsenabled,
                            submittedcount: submissionStatus.gradingsummary.submittedcount,
                            needssubmission: submissionStatus.gradingsummary.needssubmission
                        });
                    } else {
                        console.log(`📊 Статус для ${participant.fullname}: не сдано (нет данных)`);
                    }
                    
                    return {
                        ...participant,
                        submitted: submitted,
                        grade: gradeData ? gradeData.grade : participant.grade,
                        files: gradeData ? gradeData.files : [],
                        hasFiles: gradeData && gradeData.files.length > 0,
                        submission_files: gradeData ? gradeData.files : [], // Для совместимости с интерфейсом
                        submission_status: submissionStatus // Сохраняем детальный статус
                    };
                }));
                
                console.log('Обогащенные данные участников:', enrichedParticipants);
                

                
                if (!submissionsData) {
                    throw new Error('Не удалось получить данные ни одним из методов');
                }
                
                console.log(`Использован API: ${apiUsed}`);
                console.log('Участники задания:', submissionsData);
                
                // Подробная отладка структуры данных
                console.log('Тип данных:', typeof submissionsData);
                console.log('Ключи данных:', Object.keys(submissionsData));
                if (submissionsData.participants) {
                    console.log('Количество участников:', submissionsData.participants.length);
                    if (submissionsData.participants.length > 0) {
                        console.log('Первый участник:', submissionsData.participants[0]);
                        console.log('Ключи первого участника:', Object.keys(submissionsData.participants[0]));
                        
                        // Проверяем все возможные поля
                        const firstParticipant = submissionsData.participants[0];
                        console.log('=== ДЕТАЛЬНЫЙ АНАЛИЗ ПЕРВОГО УЧАСТНИКА ===');
                        console.log('ID:', firstParticipant.id);
                        console.log('Fullname:', firstParticipant.fullname);
                        console.log('Email:', firstParticipant.email);
                        console.log('Submitted:', firstParticipant.submitted);
                        console.log('Submissionstatus:', firstParticipant.submissionstatus);
                        console.log('Status:', firstParticipant.status);
                        console.log('Timemodified:', firstParticipant.timemodified);
                        console.log('Timecreated:', firstParticipant.timecreated);
                        console.log('Grade:', firstParticipant.grade);
                        console.log('Gradingstatus:', firstParticipant.gradingstatus);
                        console.log('Requiresgrading:', firstParticipant.requiresgrading);
                        console.log('Mailed:', firstParticipant.mailed);
                        console.log('Extensionduedate:', firstParticipant.extensionduedate);
                        console.log('Locked:', firstParticipant.locked);
                        console.log('Allsubmissions:', firstParticipant.allsubmissions);
                        console.log('=== КОНЕЦ АНАЛИЗА ===');
                    }
                }
                
                // Подробная отладка первого участника
                if (submissionsData.participants && submissionsData.participants.length > 0) {
                    console.log('Детали первого участника:', submissionsData.participants[0]);
                    console.log('Поля первого участника:', Object.keys(submissionsData.participants[0]));
                    
                    // Проверяем все возможные поля статуса
                    const participant = submissionsData.participants[0];
                    console.log('Проверка полей статуса:');
                    console.log('- submitted:', participant.submitted);
                    console.log('- submissionstatus:', participant.submissionstatus);
                    console.log('- status:', participant.status);
                    console.log('- timemodified:', participant.timemodified);
                    console.log('- timecreated:', participant.timecreated);
                    console.log('- grade:', participant.grade);
                    console.log('- gradingstatus:', participant.gradingstatus);
                    console.log('- requiresgrading:', participant.requiresgrading);
                }
                
                // Создаем список студентов с обогащенными данными
                const students = enrichedParticipants.map(participant => {
                    const user = usersData.find(u => u.id === participant.id);
                    
                    // Используем данные, полученные из API
                    const submitted = participant.submitted || false;
                    const grade = participant.grade || null;
                    const files = participant.files || [];
                    
                    // Определяем, требует ли оценку
                    let requiresgrading = false;
                    if (submitted && !grade) {
                        requiresgrading = true;
                    }
                    
                    // Дополнительная отладка для каждого студента
                    console.log(`Студент ${participant.fullname}:`, {
                        submitted: submitted,
                        requiresgrading: requiresgrading,
                        grade: grade,
                        files: files,
                        filesCount: files.length
                    });
                    
                    const student = {
                        id: participant.id,
                        fullname: participant.fullname || user?.fullname || `Студент ${participant.id}`,
                        email: participant.email || user?.email || '',
                        department: participant.department || user?.department || '', // Добавляем группу
                        submitted: submitted,
                        requiresgrading: requiresgrading,
                        grade: grade,
                        submission_text: participant.submissiontext || '',
                        submission_files: files,
                        hasFiles: files.length > 0
                    };
                    
                    console.log(`Добавлен студент: ${student.fullname} (ID: ${student.id}, Сдано: ${student.submitted}, Оценка: ${student.grade}, Файлов: ${student.submission_files.length}, Требует оценки: ${student.requiresgrading})`);
                    return student;
                });
                
                // Если нет участников, попробуем получить через другой API
                if (students.length === 0) {
                    console.log('Попытка альтернативного способа получения ответов...');
                    
                    try {
                        const altResponse = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=mod_assign_get_submissions&assignmentids[0]=${assignmentId}&moodlewsrestformat=json`);
                        
                        if (altResponse.ok) {
                            const altData = await altResponse.json();
                            console.log('Альтернативные данные:', altData);
                            
                            if (altData.assignments && altData.assignments[0] && altData.assignments[0].submissions) {
                                console.log(`Найдено ${altData.assignments[0].submissions.length} ответов через альтернативный API`);
                                altData.assignments[0].submissions.forEach(submission => {
                                    const user = usersData.find(u => u.id === submission.userid);
                                    
                                    // Улучшенная логика определения статуса сдачи
                                    let submitted = false;
                                    let requiresgrading = false;
                                    
                                    // Проверяем различные поля статуса
                                    if (submission.status) {
                                        submitted = submission.status === 'submitted';
                                    } else if (submission.submissionstatus) {
                                        submitted = submission.submissionstatus === 'submitted';
                                    } else if (submission.timemodified) {
                                        // Если есть время модификации, считаем что сдано
                                        submitted = true;
                                    }
                                    
                                    // Проверяем статус проверки
                                    if (submission.gradingstatus) {
                                        requiresgrading = submission.gradingstatus === 'notgraded';
                                    } else if (submission.requiresgrading !== undefined) {
                                        requiresgrading = submission.requiresgrading;
                                    }
                                    
                                    const student = {
                                        id: submission.userid,
                                        fullname: user?.fullname || `Студент ${submission.userid}`,
                                        email: user?.email || '',
                                        department: user?.department || '', // Добавляем группу
                                        submitted: submitted,
                                        requiresgrading: requiresgrading,
                                        grade: submission.grade || null,
                                        submission_text: extractSubmissionText(submission),
                                        submission_files: extractSubmissionFiles(submission)
                                    };
                                    
                                    students.push(student);
                                    console.log(`Добавлен студент через альтернативный API: ${student.fullname} (Сдано: ${submitted})`);
                                });
                            } else {
                                console.log('Альтернативный API не вернул ответы');
                            }
                        } else {
                            console.log('Альтернативный API вернул ошибку:', altResponse.status);
                        }
                    } catch (error) {
                        console.log('Ошибка альтернативного API:', error.message);
                    }
                }
                
                // Если все еще нет студентов, попробуем создать список из пользователей курса
                if (students.length === 0) {
                    console.log('Создание списка студентов из пользователей курса...');
                    
                    if (Array.isArray(usersData)) {
                        usersData.forEach(user => {
                            // Исключаем преподавателей и администраторов
                            if (user.roles && user.roles.some(role => 
                                role.shortname === 'student' || 
                                role.shortname === 'editingteacher' || 
                                role.shortname === 'teacher'
                            )) {
                                const student = {
                                    id: user.id,
                                    fullname: user.fullname || `Студент ${user.id}`,
                                    email: user.email || '',
                                    submitted: false, // По умолчанию не сдано
                                    requiresgrading: false,
                                    grade: null,
                                    submission_text: '',
                                    submission_files: []
                                };
                                
                                students.push(student);
                                console.log(`Добавлен студент из списка пользователей: ${student.fullname}`);
                            }
                        });
                    }
                }
                
                // Метод 4: Попробуем получить данные через mod_assign_get_user_flags
                if (students.length === 0) {
                    try {
                        console.log('Метод 4: Попытка получения через mod_assign_get_user_flags...');
                        const flagsResponse = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=mod_assign_get_user_flags&assignmentid=${assignmentId}&moodlewsrestformat=json`);
                        
                        if (flagsResponse.ok) {
                            const flagsData = await flagsResponse.json();
                            console.log('Данные флагов пользователей:', flagsData);
                            
                            if (flagsData.userflags && Array.isArray(flagsData.userflags)) {
                                flagsData.userflags.forEach(flag => {
                                    const user = usersData.find(u => u.id === flag.userid);
                                    
                                    const student = {
                                        id: flag.userid,
                                        fullname: user?.fullname || `Студент ${flag.userid}`,
                                        email: user?.email || '',
                                        submitted: flag.mailed || false, // Используем mailed как индикатор сдачи
                                        requiresgrading: !flag.mailed,
                                        grade: null,
                                        submission_text: '',
                                        submission_files: []
                                    };
                                    
                                    students.push(student);
                                    console.log(`Добавлен студент через флаги: ${student.fullname} (Сдано: ${student.submitted})`);
                                });
                            }
                        }
                    } catch (error) {
                        console.log('Метод 4 не сработал:', error.message);
                    }
                }
                
                // Получаем название задания из селекта
                const assignmentSelect = document.getElementById('moodle-assignment');
                const selectedAssignmentText = assignmentSelect.options[assignmentSelect.selectedIndex].text;
                
                // Обновляем информацию о задании
                document.getElementById('assignment-name').textContent = selectedAssignmentText || assignment.name || 'Неизвестное задание';
                document.getElementById('assignment-students').textContent = students.length;
                
                const submittedCount = students.filter(s => s.submitted).length;
                document.getElementById('assignment-submitted').textContent = `${submittedCount}/${students.length}`;
                
                const gradedCount = students.filter(s => s.grade !== null).length;
                document.getElementById('assignment-graded').textContent = `${gradedCount}/${students.length}`;
                
                document.getElementById('assignment-info').style.display = 'block';
                
                console.log(`Итоговый результат: ${students.length} студентов`);
                
                // Сортируем студентов по алфавиту (по фамилии)
                const sortedStudents = students.sort((a, b) => {
                    // Функция для извлечения фамилии (последнее слово)
                    const getSurname = (fullname) => {
                        const parts = fullname.trim().split(' ').filter(part => part.length > 0);
                        return parts.length > 0 ? parts[parts.length - 1].toLowerCase() : '';
                    };
                    
                    // Извлекаем фамилии
                    const surnameA = getSurname(a.fullname);
                    const surnameB = getSurname(b.fullname);
                    
                    // Сначала сравниваем по фамилии
                    const surnameCompare = surnameA.localeCompare(surnameB, 'ru');
                    if (surnameCompare !== 0) {
                        return surnameCompare;
                    }
                    
                    // Если фамилии одинаковые, сравниваем по полному имени
                    const nameA = a.fullname.toLowerCase();
                    const nameB = b.fullname.toLowerCase();
                    return nameA.localeCompare(nameB, 'ru');
                });
                
                console.log('📊 Студенты отсортированы по алфавиту');
                
                // Сохраняем данные в конфигурации
                moodleConfig.currentAssignment = {
                    id: assignmentId,
                    name: assignment.name,
                    students: sortedStudents
                };
                saveData();
                
                updateMoodleStatus('connected', `Загружено ${students.length} студентов`);
                
                // Показываем список студентов
                showStudentsList(students);
                
                // Загружаем настройки задания
                setTimeout(() => {
                    loadAssignmentSettings();
                }, 500);
                
            } catch (error) {
                console.error('Ошибка загрузки ответов:', error);
                updateMoodleStatus('error', `Ошибка: ${error.message}`);
                
                // Показываем сообщение пользователю
                const contentArea = document.querySelector('.content-area');
                if (contentArea) {
                    contentArea.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-danger); text-align: center;">
                            <div>
                                <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
                                <div style="font-size: 18px; margin-bottom: 8px;">Ошибка загрузки данных</div>
                                <div style="font-size: 14px;">${error.message}</div>
                                <div style="font-size: 12px; margin-top: 16px; color: var(--text-muted);">
                                    Возможно, задание не существует или у вас нет прав доступа
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        }

        function extractSubmissionText(submission) {
            if (submission.plugins) {
                const textPlugin = submission.plugins.find(p => p.type === 'onlinetext');
                if (textPlugin && textPlugin.editorfields) {
                    return textPlugin.editorfields[0]?.text || '';
                }
            }
            return '';
        }

        function extractSubmissionFiles(submission) {
            const files = [];
            if (submission.plugins) {
                const filePlugin = submission.plugins.find(p => p.type === 'file');
                if (filePlugin && filePlugin.fileareas) {
                    filePlugin.fileareas.forEach(area => {
                        if (area.files) {
                            area.files.forEach(file => {
                                // Добавляем токен к URL файла
                                let fileUrl = file.fileurl;
                                const token = document.getElementById('moodle-token')?.value;
                                if (token && fileUrl && !fileUrl.includes('token=')) {
                                    const separator = fileUrl.includes('?') ? '&' : '?';
                                    fileUrl += `${separator}token=${token}`;
                                }
                                
                                files.push({
                                    name: file.filename,
                                    url: fileUrl,
                                    filename: file.filename, // Добавляем для совместимости
                                    fileurl: fileUrl, // Добавляем для совместимости
                                    size: file.filesize,
                                    type: file.mimetype
                                });
                            });
                        }
                    });
                }
            }
            console.log('📁 Извлеченные файлы:', files);
            return files;
        }
        function showStudentsList(students) {
            console.log('🎯 showStudentsList вызвана с', students.length, 'студентами');
            
            // Инициализируем отфильтрованных студентов
            filteredStudents = [...students];
            
            // Создаем интерфейс для просмотра студентов
            const mainArea = document.querySelector('.main-area');
            
            // Создаем интерфейс для просмотра студентов
            const studentsInterface = document.createElement('div');
            studentsInterface.className = 'students-interface';
            studentsInterface.id = 'students-interface';
            
            // Получаем название выбранного курса и задания
            const courseSelect = document.getElementById('moodle-course');
            const assignmentSelect = document.getElementById('moodle-assignment');
            const selectedCourseText = courseSelect.options[courseSelect.selectedIndex].text;
            const selectedAssignmentText = assignmentSelect.options[assignmentSelect.selectedIndex].text;
            
            studentsInterface.innerHTML = `
                <div class="students-header">
                    <div class="students-title">
                        <h2>${selectedAssignmentText}</h2>
                        <span class="students-count">${students.length} студентов</span>
                    </div>
                </div>
                
                <div class="students-container">
                    <div class="students-sidebar">
                        <div class="students-search">
                            <input type="text" id="students-search-input" placeholder="🔍 Поиск по ФИО или группе..." class="students-search-input">
                        </div>
                        <div class="students-filters">
                            <div class="filter-buttons">
                                <button class="filter-btn active" data-filter="all" onclick="filterByStatus('all')">
                                    Все
                                </button>
                                <button class="filter-btn" data-filter="submitted" onclick="filterByStatus('submitted')">
                                    Сдано
                                </button>
                                <button class="filter-btn" data-filter="not-graded" onclick="filterByStatus('not-graded')">
                                    Не оценено
                                </button>
                            </div>
                        </div>
                        <div class="students-list">
                            ${students.map((student, index) => `
                                <div class="student-list-item ${index === 0 ? 'active' : ''}" data-original-index="${index}" 
                                     onclick="selectStudentByOriginalIndex(${index})">
                                    <div class="student-list-info">
                                        <div class="student-list-name">${student.fullname}</div>
                                        <div class="student-list-status">
                                            <span class="status-badge ${student.submitted ? 'submitted' : 'not-submitted'}">
                                                ${student.submitted ? '✅ Сдано' : '❌ Не сдано'}
                                            </span>
                                            ${student.grade ? `<span class="grade-badge">${formatGrade(student.grade)}</span>` : '<span class="grade-badge not-graded">🔴 Не оценено</span>'}
                                            ${student.submission_files && student.submission_files.length > 0 ? `<span class="files-badge">📎 ${student.submission_files.length}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="student-detail">
                        <div class="student-detail-header">
                            <h3 id="selected-student-name">Выберите студента</h3>
                            <div class="student-detail-status" id="selected-student-status"></div>
                        </div>
                        
                        <div class="student-detail-content" id="selected-student-content">
                            <div class="no-student-selected">
                                <div class="no-student-icon">👤</div>
                                <div class="no-student-text">Выберите студента из списка слева для просмотра ответа</div>
                            </div>
                        </div>
                        
                        <div class="student-detail-grading" id="selected-student-grading" style="display: none;">
                            <div class="grading-header">
                                <h4>Оценка</h4>
                            </div>
                            <div class="grading-controls">
                                <input type="number" class="grade-input" id="student-grade-input" 
                                       placeholder="Введите оценку" min="0" max="100">
                                <button class="btn btn-primary" onclick="submitSelectedStudentGrade()">
                                    💾 Сохранить оценку
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            mainArea.appendChild(studentsInterface);
            console.log('✅ Интерфейс студентов добавлен в mainArea');
            
            // Добавляем обработчик поиска
            const searchInput = document.getElementById('students-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    filterStudents(e.target.value);
                });
                console.log('✅ Обработчик поиска добавлен');
            }
            
            // Если есть студенты, выбираем первого
            if (students.length > 0) {
                console.log('👤 Выбираем первого студента...');
                selectStudent(0);
            } else {
                console.log('⚠️ Нет студентов для отображения');
            }
            
            console.log('🎯 showStudentsList завершена');
            
            // Повторно настраиваем обработчики событий после создания интерфейса
            setTimeout(() => {
                setupEventListeners();
                updateGlobalSeparators();
            }, 100);
        }

        function getFileIcon(mimeType) {
            if (mimeType.includes('video')) return '🎥';
            if (mimeType.includes('audio')) return '🎵';
            if (mimeType.includes('image')) return '🖼️';
            if (mimeType.includes('pdf')) return '📄';
            if (mimeType.includes('word') || mimeType.includes('document')) return '📝';
            if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return '📊';
            if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return '📽️';
            return '📎';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getStatusText(status) {
            switch (status) {
                case 'graded': return 'Проверено';
                case 'notgraded': return 'Не проверено';
                default: return 'Неизвестно';
            }
        }



        /**
         * Получает детальную информацию о сдаче задания для конкретного пользователя
         * @param {number} assignmentId - ID задания из core_course_get_contents
         * @param {number} userId - ID пользователя из core_enrol_get_enrolled_users
         * @param {string} url - URL Moodle
         * @param {string} token - токен доступа
         */
        async function getSubmissionStatus(assignmentId, userId, url, token) {
            try {
                // Подробная отладка входных параметров
                console.log("🔍 assignmentId:", assignmentId, typeof assignmentId);
                console.log("🔍 userId:", userId, typeof userId);
                console.log("🔍 url:", url);
                console.log("🔍 token:", token ? "Есть" : "Нет");
                
                // Приводим типы к числу
                const assignId = Number(assignmentId);
                const uId = Number(userId);

                console.log("🔍 assignId после конвертации:", assignId, typeof assignId);
                console.log("🔍 uId после конвертации:", uId, typeof uId);

                if (!assignId || !uId) {
                    console.error("❌ Пустые или неверные параметры:", { assignmentId, userId, assignId, uId });
                    return null;
                }

                // Используем правильный API endpoint и параметры
                const apiUrl = `${url}/webservice/rest/server.php`;
                
                // Используем URLSearchParams для правильного формата
                const formData = new URLSearchParams();
                formData.append('wstoken', token);
                formData.append('wsfunction', 'mod_assign_get_submission_status');
                formData.append('moodlewsrestformat', 'json');
                formData.append('assignid', assignId);
                formData.append('userid', uId);

                console.log("📤 Запрос getSubmissionStatus:", {
                    assignid: assignId,
                    userid: uId
                });

                const res = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: formData
                });

                const data = await res.json();

                if (data.exception) {
                    console.error("❌ Ошибка API getSubmissionStatus:", data.message, data);
                    
                    // Проверяем, является ли ошибка связанной с недействительным токеном
                    if (data.errorcode === 'invalidtoken') {
                        showNotification('warning', 'Токен Moodle устарел. Пожалуйста, обновите токен в настройках.', 10000);
                    }
                    
                    return null;
                }

                console.log("✅ Ответ API getSubmissionStatus:", data);
                return data;

            } catch (err) {
                console.error("❌ Ошибка запроса getSubmissionStatus:", err);
                return null;
            }
        }

        /**
         * Модуль для работы с Moodle API - получение оценок и файлов
         */
        const MoodleDataModule = {
            /**
             * Получает оценки для всех заданий
             * @param {Array} assignmentIds - массив ID заданий
             * @param {string} url - URL Moodle
             * @param {string} token - токен доступа
             * @returns {Promise<Object>} - данные об оценках
             */
            async getGrades(assignmentIds, url, token) {
                console.log('📊 Получение оценок для заданий:', assignmentIds);
                
                try {
                    // Используем URLSearchParams для правильного формата
                    const params = new URLSearchParams({
                        wstoken: token,
                        wsfunction: 'mod_assign_get_grades',
                        moodlewsrestformat: 'json'
                    });
                    
                    // Добавляем assignmentids как массив
                    assignmentIds.forEach((id, index) => {
                        params.append(`assignmentids[${index}]`, id);
                    });
                    
                    const response = await fetch(`${url}/webservice/rest/server.php`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: params
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('✅ Получены данные об оценках:', data);
                    return data;
                    
                } catch (error) {
                    console.error('❌ Ошибка при получении оценок:', error);
                    
                    // Проверяем, является ли ошибка связанной с недействительным токеном
                    if (error && error.errorcode === 'invalidtoken') {
                        showNotification('warning', 'Токен Moodle устарел. Пожалуйста, обновите токен в настройках.', 10000);
                    }
                    
                    throw error;
                }
            },

            /**
             * Получает файлы для всех заданий
             * @param {Array} assignmentIds - массив ID заданий
             * @param {string} url - URL Moodle
             * @param {string} token - токен доступа
             * @returns {Promise<Object>} - данные о файлах
             */
            async getSubmissions(assignmentIds, url, token) {
                console.log('📁 Получение файлов для заданий:', assignmentIds);
                
                try {
                    // Используем URLSearchParams для правильного формата
                    const params = new URLSearchParams({
                        wstoken: token,
                        wsfunction: 'mod_assign_get_submissions',
                        moodlewsrestformat: 'json'
                    });
                    
                    // Добавляем assignmentids как массив
                    assignmentIds.forEach((id, index) => {
                        params.append(`assignmentids[${index}]`, id);
                    });
                    
                    const response = await fetch(`${url}/webservice/rest/server.php`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: params
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('✅ Получены данные о файлах:', data);
                    return data;
                    
                } catch (error) {
                    console.error('❌ Ошибка при получении файлов:', error);
                    
                    // Проверяем, является ли ошибка связанной с недействительным токеном
                    if (error && error.errorcode === 'invalidtoken') {
                        showNotification('warning', 'Токен Moodle устарел. Пожалуйста, обновите токен в настройках.', 10000);
                    }
                    
                    throw error;
                }
            },

            /**
             * Извлекает файлы из ответа mod_assign_get_submissions
             * @param {Object} submissionData - данные о сдаче
             * @param {string} token - токен для доступа к файлам
             * @returns {Array} - массив файлов с нужными полями
             */
            extractFiles(submissionData, token) {
                const files = [];
                
                if (!submissionData || !submissionData.plugins) {
                    return files;
                }
                
                submissionData.plugins.forEach(plugin => {
                    if (plugin.type === 'file' && plugin.fileareas) {
                        plugin.fileareas.forEach(filearea => {
                            if (filearea.files && Array.isArray(filearea.files)) {
                                filearea.files.forEach(file => {
                                    // Добавляем токен к URL для скачивания
                                    const fileUrl = file.fileurl + (file.fileurl.includes('?') ? '&' : '?') + `token=${token}`;
                                    
                                    files.push({
                                        filename: file.filename,
                                        fileurl: fileUrl,
                                        filesize: file.filesize || 0,
                                        timemodified: file.timemodified || 0
                                    });
                                });
                            }
                        });
                    }
                });
                
                return files;
            },

            /**
             * Объединяет данные об оценках и файлах
             * @param {Array} assignmentIds - массив ID заданий
             * @param {Array} users - массив пользователей
             * @param {Object} gradesData - данные об оценках
             * @param {Object} submissionsData - данные о файлах
             * @param {string} token - токен для доступа к файлам
             * @returns {Array} - объединенный массив данных
             */
            mergeGradesAndFiles(assignmentIds, users, gradesData, submissionsData, token) {
                console.log('🔄 Объединение данных об оценках и файлах...');
                
                const results = [];
                
                // Создаем карту пользователей для быстрого поиска
                const usersMap = new Map(users.map(user => [user.id, user]));
                
                assignmentIds.forEach(assignmentId => {
                    // Находим данные об оценках для этого задания
                    const assignmentGrades = gradesData.assignments?.find(a => a.assignmentid == assignmentId);
                    
                    // Находим данные о файлах для этого задания
                    const assignmentSubmissions = submissionsData.assignments?.find(a => a.assignmentid == assignmentId);
                    
                    // Обрабатываем каждого пользователя
                    users.forEach(user => {
                        const result = {
                            userId: user.id,
                            fullName: user.fullname,
                            assignmentId: assignmentId,
                            grade: null,
                            files: []
                        };
                        
                        // Ищем оценку для этого пользователя и задания
                        if (assignmentGrades && assignmentGrades.grades) {
                            const grade = assignmentGrades.grades.find(g => g.userid == user.id);
                            if (grade) {
                                result.grade = grade.grade;
                                console.log(`📊 Найдена оценка для ${user.fullname} (задание ${assignmentId}): ${grade.grade}`);
                            }
                        }
                        
                        // Ищем файлы для этого пользователя и задания
                        if (assignmentSubmissions && assignmentSubmissions.submissions) {
                            const submission = assignmentSubmissions.submissions.find(s => s.userid == user.id);
                            if (submission) {
                                const files = this.extractFiles(submission, token);
                                result.files = files;
                                
                                if (files.length > 0) {
                                    console.log(`📁 Найдено ${files.length} файлов для ${user.fullname} (задание ${assignmentId})`);
                                    files.forEach(file => {
                                        console.log(`   - ${file.filename} (${this.formatFileSize(file.filesize)})`);
                                    });
                                }
                            }
                        }
                        
                        results.push(result);
                    });
                });
                
                console.log(`✅ Объединено ${results.length} записей (${assignmentIds.length} заданий × ${users.length} пользователей)`);
                return results;
            },

            /**
             * Форматирует размер файла в читаемый вид
             * @param {number} bytes - размер в байтах
             * @returns {string} - отформатированный размер
             */
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Б';
                const k = 1024;
                const sizes = ['Б', 'КБ', 'МБ', 'ГБ'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },

            /**
             * Скачивает файл с использованием токена
             * @param {string} fileUrl - URL файла с токеном
             * @param {string} filename - имя файла для сохранения
             */
            async downloadFile(fileUrl, filename) {
                console.log(`📥 Скачивание файла: ${filename}`);
                
                try {
                    const response = await fetch(fileUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    
                    // Создаем ссылку для скачивания
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Очищаем
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    console.log(`✅ Файл ${filename} успешно скачан`);
                    
                } catch (error) {
                    console.error(`❌ Ошибка при скачивании файла ${filename}:`, error);
                    throw error;
                }
            },

            /**
             * Основная функция для получения всех данных
             * @param {Array} assignmentIds - массив ID заданий
             * @param {Array} users - массив пользователей
             * @param {string} url - URL Moodle
             * @param {string} token - токен доступа
             * @returns {Promise<Array>} - объединенный массив данных
             */
            async getAllGradesAndFiles(assignmentIds, users, url, token) {
                console.log('🚀 Начало получения всех данных об оценках и файлах...');
                console.log(`📋 Заданий: ${assignmentIds.length}, Пользователей: ${users.length}`);
                
                try {
                    // Проверяем входные параметры
                    if (!assignmentIds || !Array.isArray(assignmentIds) || assignmentIds.length === 0) {
                        console.log('⚠️ assignmentIds не является валидным массивом:', assignmentIds);
                        return [];
                    }
                    
                    if (!users || !Array.isArray(users) || users.length === 0) {
                        console.log('⚠️ users не является валидным массивом:', users);
                        return [];
                    }
                    
                    // Получаем оценки и файлы параллельно
                    const [gradesData, submissionsData] = await Promise.all([
                        this.getGrades(assignmentIds, url, token),
                        this.getSubmissions(assignmentIds, url, token)
                    ]);
                    
                    // Объединяем данные
                    const mergedData = this.mergeGradesAndFiles(assignmentIds, users, gradesData, submissionsData, token);
                    
                    console.log('🎉 Все данные успешно получены и объединены');
                    return mergedData || [];
                    
                } catch (error) {
                    console.error('❌ Ошибка при получении всех данных:', error);
                    
                    // Проверяем, является ли ошибка связанной с недействительным токеном
                    if (error && error.errorcode === 'invalidtoken') {
                        showNotification('warning', 'Токен Moodle устарел. Пожалуйста, обновите токен в настройках.', 10000);
                    }
                    
                    return [];
                }
            }
        };

        // Функция для получения оценок и файлов (обновленная)
        async function getGradesAndFiles(assignmentId, participants, url, token) {
            console.log(`Получение оценок и файлов для задания ${assignmentId}...`);
            console.log('📋 Входные параметры:', {
                assignmentId: assignmentId,
                participantsType: typeof participants,
                participantsLength: participants ? participants.length : 'undefined',
                hasUrl: !!url,
                hasToken: !!token
            });
            
            try {
                // Проверяем, что participants существует и является массивом
                if (!participants || !Array.isArray(participants)) {
                    console.log('⚠️ participants не является массивом:', participants);
                    console.log('🔄 Возвращаем пустой массив, так как нет данных участников');
                    return [];
                }
                
                // Проверяем, что массив не пустой
                if (participants.length === 0) {
                    console.log('⚠️ Массив participants пустой');
                    return [];
                }
                
                console.log(`✅ Обрабатываем ${participants.length} участников`);
                
                // Используем новый модуль
                const results = await MoodleDataModule.getAllGradesAndFiles([assignmentId], participants, url, token);
                console.log('📊 Результаты от MoodleDataModule:', results);
                
                // Если результаты пустые, создаем базовые данные
                if (!results || results.length === 0) {
                    console.log('⚠️ MoodleDataModule вернул пустые результаты, создаем базовые данные...');
                    return participants.map(participant => ({
                        userId: participant.id,
                        fullName: participant.fullname,
                        assignmentId: assignmentId,
                        grade: null,
                        files: []
                    }));
                }
                
                return results || [];
                
            } catch (error) {
                console.error('Ошибка при получении оценок и файлов:', error);
                return [];
            }
        }

        /**
         * Получает все данные об оценках и файлах для курса
         * @param {Array} assignmentIds - массив ID всех заданий курса
         * @param {Array} users - массив всех пользователей курса
         * @param {string} url - URL Moodle
         * @param {string} token - токен доступа
         * @returns {Promise<Array>} - полный массив данных
         */
        async function getAllCourseData(assignmentIds, users, url, token) {
            console.log('🎓 Получение всех данных курса...');
            console.log(`📚 Заданий: ${assignmentIds.length}, 👥 Студентов: ${users.length}`);
            
            try {
                const allData = await MoodleDataModule.getAllGradesAndFiles(assignmentIds, users, url, token);
                
                // Группируем данные по студентам для удобства
                const groupedByUser = {};
                allData.forEach(item => {
                    if (!groupedByUser[item.userId]) {
                        groupedByUser[item.userId] = {
                            userId: item.userId,
                            fullName: item.fullName,
                            assignments: []
                        };
                    }
                    
                    groupedByUser[item.userId].assignments.push({
                        assignmentId: item.assignmentId,
                        grade: item.grade,
                        files: item.files
                    });
                });
                
                console.log('📊 Данные сгруппированы по пользователям:', Object.keys(groupedByUser).length);
                return {
                    flatData: allData,
                    groupedByUser: Object.values(groupedByUser)
                };
                
            } catch (error) {
                console.error('❌ Ошибка при получении данных курса:', error);
                throw error;
            }
        }

        /**
         * Экспортирует данные в JSON файл
         * @param {Array} data - данные для экспорта
         * @param {string} filename - имя файла
         */
        function exportDataToJSON(data, filename = 'moodle-data.json') {
            console.log('📤 Экспорт данных в JSON...');
            
            try {
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                console.log(`✅ Данные экспортированы в ${filename}`);
                
            } catch (error) {
                console.error('❌ Ошибка при экспорте данных:', error);
                throw error;
            }
        }
        async function selectStudent(index) {
            console.log('👤 selectStudent вызвана с индексом:', index);
            
            if (!moodleConfig.currentAssignment || !moodleConfig.currentAssignment.students) {
                console.log('❌ Нет данных о текущем задании или студентах');
                return;
            }
            
            const students = moodleConfig.currentAssignment.students;
            const student = students[index];
            
            console.log('📋 Данные студента:', {
                studentExists: !!student,
                studentName: student?.fullname,
                studentId: student?.id
            });
            
            if (!student) {
                console.log('❌ Студент не найден');
                return;
            }
            
            // Получаем детальную информацию о студенте
            try {
                const url = document.getElementById('moodle-url').value;
                const token = document.getElementById('moodle-token').value;
                const assignmentId = moodleConfig.currentAssignment.id;
                
                console.log('Получение детальной информации для студента:', student.fullname);
                
                // Получаем детальную информацию о сдаче
                const params = new URLSearchParams({
                    wstoken: token,
                    wsfunction: 'mod_assign_get_submissions',
                    'assignmentids[0]': assignmentId,
                    'userids[0]': student.id,
                    moodlewsrestformat: 'json'
                });
                
                const submissionResponse = await fetch(`${url}/webservice/rest/server.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params
                });
                
                if (submissionResponse.ok) {
                    const submissionData = await submissionResponse.json();
                    console.log('Детальная информация о сдаче:', submissionData);
                    
                    // Проверяем, есть ли ошибка в ответе
                    if (submissionData.exception || submissionData.errorcode) {
                        console.log('API вернул ошибку при получении детальной информации:', submissionData);
                        // Не прерываем выполнение, просто логируем ошибку
                    }
                    
                    if (submissionData.assignments && submissionData.assignments[0] && submissionData.assignments[0].submissions) {
                        const submission = submissionData.assignments[0].submissions[0];
                        if (submission) {
                            // Обновляем информацию о студенте
                            student.submission_text = extractSubmissionText(submission);
                            student.submission_files = extractSubmissionFiles(submission);
                            student.grade = submission.grade || student.grade;
                            student.submitted = submission.status === 'submitted';
                            
                            // Загружаем комментарии, если есть
                            if (submission.feedback && submission.feedback.plugins) {
                                const commentsPlugin = submission.feedback.plugins.find(p => p.type === 'comments');
                                if (commentsPlugin && commentsPlugin.editorfields) {
                                    student.comment = commentsPlugin.editorfields.text || '';
                                }
                            }
                            
                            console.log('Обновленная информация о студенте:', {
                                name: student.fullname,
                                submitted: student.submitted,
                                grade: student.grade,
                                hasText: !!student.submission_text,
                                filesCount: student.submission_files ? student.submission_files.length : 0
                            });
                        }
                    }
                }
            } catch (error) {
                console.log('Ошибка получения детальной информации:', error);
            }
            
            // Обновляем активный элемент в списке
            document.querySelectorAll('.student-list-item').forEach((item) => {
                const originalIdx = parseInt(item.getAttribute('data-original-index') || '-1', 10);
                item.classList.toggle('active', originalIdx === index);
            });
            
            // Обновляем заголовок
            document.getElementById('selected-student-name').textContent = student.fullname;
            
            // Обновляем статус
            const statusElement = document.getElementById('selected-student-status');
            statusElement.innerHTML = `
                <span class="status-badge ${student.submitted ? 'submitted' : 'not-submitted'}">
                    ${student.submitted ? '✅ Сдано' : '❌ Не сдано'}
                </span>
                ${student.grade ? `<span class="grade-badge">${formatGrade(student.grade)}</span>` : '<span class="grade-badge not-graded">🔴 Не оценено</span>'}
                ${student.submission_files && student.submission_files.length > 0 ? `<span class="files-badge">📎 ${student.submission_files.length} файлов</span>` : ''}
            `;
            
            // Обновляем контент
            const contentElement = document.getElementById('selected-student-content');
            
            if (!student.submitted) {
                contentElement.innerHTML = `
                    <div class="no-submission-content">
                        <div class="no-submission-icon">📝</div>
                        <div class="no-submission-text">Студент не сдал работу</div>
                    </div>
                `;
                document.getElementById('selected-student-grading').style.display = 'none';
                return;
            }
            
            let contentHTML = '';
            
            // Текстовый ответ
            if (student.submission_text) {
                contentHTML += `
                    <div class="submission-section">
                        <h4>📝 Текстовый ответ</h4>
                        <div class="submission-text-content">
                            ${student.submission_text}
                        </div>
                    </div>
                `;
            }
            
            // Файлы
            if (student.submission_files && student.submission_files.length > 0) {
                contentHTML += `
                    <div class="submission-section">
                        <div class="submission-files-header">
                            <h4>Файлы ответа (${student.submission_files.length})</h4>
                            ${student.submission_files.length > 1 ? `
                                <button class="btn btn-secondary download-all-files-btn" onclick="downloadAllStudentFiles('${student.fullname}', ${JSON.stringify(student.submission_files).replace(/"/g, '&quot;')})" title="Скачать все файлы студента">
                                    📥 Скачать все (${student.submission_files.length})
                                </button>
                            ` : ''}
                        </div>
                        <div class="submission-files-content">
                            ${student.submission_files.map(file => `
                                <div class="file-preview-item">
                                    <div class="file-preview-content">
                                        ${renderFilePreview(file)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                // Запускаем предзагрузку видео ПОСЛЕ отображения интерфейса
                setTimeout(() => {
                    preloadVideoFiles(student.submission_files);
                }, 1000); // Задержка 1 секунда
            } else if (student.hasFiles) {
                contentHTML += `
                    <div class="submission-section">
                        <div class="submission-files-content">
                            <div class="loading-files">⏳ Загрузка файлов...</div>
                        </div>
                    </div>
                `;
            }
            
            if (!student.submission_text && (!student.submission_files || student.submission_files.length === 0)) {
                contentHTML = `
                    <div class="no-submission-content">
                        <div class="no-submission-icon">📝</div>
                        <div class="no-submission-text">Нет ответа</div>
                    </div>
                `;
            }
            
                                      // Добавляем форму оценки в конце
             if (student.submission_files && student.submission_files.length > 0) {
                 contentHTML += `
                     <div class="grading-form">
                         <div class="grading-input-group grade-group">
                             <label for="student-grade-input">Оценка:</label>
                             <input type="text" id="student-grade-input" class="grade-input" 
                                    value="${student.grade || ''}" 
                                    placeholder="Введите оценку">
                         </div>
                         <div class="grading-input-group comment-group">
                             <label for="student-comment-input">Комментарий:</label>
                             <input type="text" id="student-comment-input" class="comment-input" 
                                    placeholder="Краткий комментарий к работе" value="${student.comment || ''}">
                         </div>
                         <div class="grading-button-group">
                             <button class="btn btn-primary" onclick="submitSelectedStudentGrade()">
                                 💾 Сохранить оценку
                             </button>
                         </div>
                    </div>
                `;
            }
            
            contentElement.innerHTML = contentHTML;
            
            // Скрываем старую область оценки
            const gradingElement = document.getElementById('selected-student-grading');
            if (gradingElement) {
                gradingElement.style.display = 'none';
            }
            
            // Сохраняем индекс выбранного студента
            moodleConfig.selectedStudentIndex = index;
        }

        function renderFilePreview(file) {
            // Определяем тип файла по расширению
            const fileName = file.filename || file.name || '';
            let fileUrl = file.fileurl || file.url || '';
            const fileExtension = fileName.split('.').pop().toLowerCase();
            
            // Добавляем токен к URL для доступа к файлам
            const token = document.getElementById('moodle-token')?.value;
            if (token && fileUrl && !fileUrl.includes('token=')) {
                const separator = fileUrl.includes('?') ? '&' : '?';
                fileUrl += `${separator}token=${token}`;
            }
            
            console.log('🔗 URL файла для предпросмотра:', fileUrl);
            
            // Определяем тип файла по расширению
            let fileType = 'unknown';
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExtension)) {
                fileType = 'image';
            } else if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm'].includes(fileExtension)) {
                fileType = 'video';
            } else if (['mp3', 'wav', 'ogg', 'aac'].includes(fileExtension)) {
                fileType = 'audio';
            } else if (fileExtension === 'pdf') {
                fileType = 'pdf';
            } else if (['doc', 'docx'].includes(fileExtension)) {
                fileType = 'word';
            }
            
            if (fileType === 'video') {
                return `
                    <div class="file-preview-large">
                        <video controls preload="auto" class="file-preview-large-video" 
                               onerror="console.error('❌ Ошибка загрузки видео:', '${fileName}', this.error)">
                        <source src="${fileUrl}" type="video/${fileExtension}">
                            <source src="${fileUrl}" type="video/mp4">
                            <source src="${fileUrl}" type="video/webm">
                            <source src="${fileUrl}" type="video/quicktime">
                        Ваш браузер не поддерживает видео.
                    </video>
                        <div class="file-info">
                            <h4>${fileName}</h4>
                            <div class="file-details">
                                <div class="file-details-info">
                                    <span>Тип: Видео</span>
                                    <span>Контейнер: ${fileExtension.toUpperCase()}</span>
                                </div>
                                <span class="download-link" onclick="downloadVideoFile('${fileUrl}', '${fileName}')" title="Скачать видео">Скачать</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (fileType === 'audio') {
                return `
                    <div class="file-preview-large">
                        <audio controls class="file-preview-large-audio">
                        <source src="${fileUrl}" type="audio/${fileExtension}">
                        Ваш браузер не поддерживает аудио.
                    </audio>
                        <div class="file-info">
                            <h4>${fileName}</h4>
                            <div class="file-details">
                                <div class="file-details-info">
                                    <span>Тип: Аудио</span>
                                    <span>Контейнер: ${fileExtension.toUpperCase()}</span>
                                </div>
                                <span class="download-link" onclick="downloadFile('${fileUrl}', '${fileName}')" title="Скачать аудио">Скачать</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (fileType === 'image') {
                // Для изображений показываем предпросмотр
                return `
                    <div class="file-preview-large">
                        <div class="image-gallery" onclick="openImageGallery('${fileUrl}', '${fileName}', this)">
                            <div class="image-gallery-container">
                                <img src="${fileUrl}" alt="${fileName}" class="image-gallery-image">
                            </div>
                        </div>
                        <div class="file-info">
                            <h4>${fileName}</h4>
                            <div class="file-details">
                                <div class="file-details-info">
                                    <span>Тип: Изображение</span>
                                    <span>Контейнер: ${fileExtension.toUpperCase()}</span>
                                </div>
                                <span class="download-link" onclick="downloadImageFile('${fileUrl}', '${fileName}')" title="Скачать изображение">Скачать</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (fileType === 'pdf') {
                // Для PDF файлов показываем простой плейсхолдер
                return `
                    <div class="file-preview-large">
                        <div class="file-preview-simple">
                            <div class="file-preview-file-icon">📄</div>
                            <div class="file-preview-file-name">${fileName}</div>
                        </div>
                        <div class="file-info">
                            <h4>${fileName}</h4>
                            <div class="file-details">
                                <div class="file-details-info">
                                    <span>Тип: PDF документ</span>
                                    <span>Контейнер: ${fileExtension.toUpperCase()}</span>
                                </div>
                                <span class="download-link" onclick="downloadFile('${fileUrl}', '${fileName}')" title="Скачать PDF">Скачать</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (fileType === 'word') {
                // Для Word файлов показываем простой плейсхолдер
                return `
                    <div class="file-preview-large">
                        <div class="file-preview-simple">
                            <div class="file-preview-file-icon">📝</div>
                            <div class="file-preview-file-name">${fileName}</div>
                        </div>
                        <div class="file-info">
                            <h4>${fileName}</h4>
                            <div class="file-details">
                                <div class="file-details-info">
                                    <span>Тип: Word документ</span>
                                    <span>Контейнер: ${fileExtension.toUpperCase()}</span>
                                </div>
                                <span class="download-link" onclick="downloadFile('${fileUrl}', '${fileName}')" title="Скачать Word">Скачать</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Для всех остальных файлов показываем кнопку скачать
                return `
                                            <div class="file-preview-large">
                            <div class="file-preview-large-download">
                                <div class="file-preview-file-icon">📄</div>
                                <div class="file-preview-file-name">${fileName}</div>
                            </div>
                        <div class="file-info">
                            <h4>${fileName}</h4>
                            <div class="file-details">
                                <div class="file-details-info">
                                    <span>Тип: Файл</span>
                                    <span>Контейнер: ${fileExtension.toUpperCase()}</span>
                                </div>
                                <span class="download-link" onclick="downloadFile('${fileUrl}', '${fileName}')" title="Скачать файл">Скачать</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function openFilePreview(url, name) {
            const fileExtension = name.split('.').pop().toLowerCase();
            
            // Определяем тип файла
            let fileType = 'unknown';
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExtension)) {
                fileType = 'image';
            } else if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm'].includes(fileExtension)) {
                fileType = 'video';
            } else if (['mp3', 'wav', 'ogg', 'aac'].includes(fileExtension)) {
                fileType = 'audio';
            } else if (fileExtension === 'pdf') {
                fileType = 'pdf';
            } else if (['doc', 'docx'].includes(fileExtension)) {
                fileType = 'word';
            }
            
            const modal = document.createElement('div');
            modal.className = 'file-preview-modal';
            
            let modalContent = '';
            
            if (fileType === 'image') {
                modalContent = `<img src="${url}" alt="${name}" class="file-preview-modal-image" style="max-width: 100%; max-height: 70vh;">`;
            } else if (fileType === 'video') {
                modalContent = `
                    <video controls preload="auto" class="file-preview-modal-video" style="max-width: 100%; max-height: 70vh;">
                        <source src="${url}" type="video/${fileExtension}">
                        Ваш браузер не поддерживает видео.
                    </video>
                `;
            } else if (fileType === 'audio') {
                modalContent = `
                    <audio controls class="file-preview-modal-audio" style="width: 100%;">
                        <source src="${url}" type="audio/${fileExtension}">
                        Ваш браузер не поддерживает аудио.
                    </audio>
                `;
            } else if (fileType === 'pdf') {
                modalContent = `<iframe src="${url}" class="file-preview-modal-pdf" style="width: 100%; height: 70vh; border: none;"></iframe>`;
            } else if (fileType === 'word') {
                // Для Word файлов показываем кнопку предпросмотра
                modalContent = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">📝</div>
                        <div style="font-size: 18px; margin-bottom: 16px;">${name}</div>
                        <div style="display: flex; gap: 12px; justify-content: center; margin-bottom: 16px;">
                            <button class="btn btn-primary" onclick="previewWordDocument('${url}', '${name}')">
                                👁️ Предпросмотр
                            </button>
                            <a href="${url}" download="${name}" class="btn btn-secondary">
                                📥 Скачать
                            </a>
                        </div>
                    </div>
                `;
            } else {
                modalContent = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">📄</div>
                        <div style="font-size: 18px; margin-bottom: 16px;">${name}</div>
                        <a href="${url}" download="${name}" class="btn btn-primary">
                            📥 Скачать файл
                        </a>
                    </div>
                `;
            }
            
            // Получаем информацию о текущем студенте
            const currentStudent = moodleConfig.currentAssignment?.students?.[moodleConfig.selectedStudentIndex];
            const studentName = currentStudent ? currentStudent.fullname : 'Неизвестный студент';
            const currentGrade = currentStudent ? (currentStudent.grade || '') : '';
            

            
            modal.innerHTML = `
                <div class="file-preview-modal-content">
                    <div class="file-preview-modal-header">
                        <h3>${name}</h3>
                        <div class="file-preview-student-info">Студент: ${studentName}</div>
                        ${fileType === 'video' ? `<span class="download-link" onclick="downloadVideoFile('${url}', '${name}')" title="Скачать видео">Скачать</span>` : ''}
                        <button class="btn-icon" onclick="this.closest('.file-preview-modal').remove()">✕</button>
                    </div>
                    <div class="file-preview-modal-body">
                        ${modalContent}
                    </div>
                    <div class="file-preview-modal-footer">
                        <div class="file-preview-grading-form">
                            <div class="grading-input-group">
                                <label for="modal-grade-input">Оценка:</label>
                                <input type="number" id="modal-grade-input" class="grade-input" 
                                       min="0" max="100" step="0.01" value="${currentGrade}" 
                                       placeholder="Введите оценку">
                            </div>
                            <button class="btn btn-primary" onclick="saveGradeFromModal()">
                                💾 Сохранить оценку
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }









        function downloadVideoFile(videoUrl, fileName) {
            console.log(`📥 Скачивание видео: ${fileName}`);
            
            // Показываем секцию прогресса
            const progressSection = document.getElementById('download-progress-section');
            progressSection.style.display = 'block';
            
            // Создаем элемент прогресса
            const progressId = `download-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const progressContainer = document.getElementById('download-progress-container');
            
            const progressItem = document.createElement('div');
            progressItem.className = 'download-progress-item';
            progressItem.id = progressId;
            progressItem.innerHTML = `
                <div class="download-progress-filename">${fileName}</div>
                <div class="download-progress-bar">
                    <div class="download-progress-fill" id="${progressId}-fill"></div>
                </div>
                <div class="download-progress-status" id="${progressId}-status">Подготовка...</div>
            `;
            
            progressContainer.appendChild(progressItem);
            
            // Имитируем прогресс скачивания
            let progress = 0;
            const progressFill = document.getElementById(`${progressId}-fill`);
            const progressStatus = document.getElementById(`${progressId}-status`);
            
            const updateProgress = () => {
                progress += Math.random() * 15 + 5; // 5-20% за раз
                if (progress > 100) progress = 100;
                
                progressFill.style.width = `${progress}%`;
                
                if (progress < 30) {
                    progressStatus.textContent = 'Подготовка...';
                } else if (progress < 60) {
                    progressStatus.textContent = 'Скачивание...';
                } else if (progress < 90) {
                    progressStatus.textContent = 'Завершение...';
                } else if (progress < 100) {
                    progressStatus.textContent = 'Сохранение...';
                } else {
                    progressStatus.textContent = 'Завершено';
                    progressStatus.style.color = 'var(--success-color)';
                    
                    // Удаляем через 2 секунды
                    setTimeout(() => {
                        removeDownloadProgress(progressId);
                    }, 2000);
                }
            };
            
            // Обновляем прогресс каждые 200мс
            const progressInterval = setInterval(updateProgress, 200);
            
            // Создаем ссылку для скачивания
            const a = document.createElement('a');
            a.href = videoUrl;
            a.download = fileName;
            a.style.display = 'none';
            
            // Добавляем в DOM и кликаем
            document.body.appendChild(a);
            a.click();
            
            // Удаляем ссылку
            document.body.removeChild(a);
            
            console.log(`✅ Видео ${fileName} отправлено на скачивание`);
            
            // Показываем уведомление
            showNotification(`Видео ${fileName} отправлено на скачивание`, 'success');
        }

        function removeDownloadProgress(progressId) {
            const progressItem = document.getElementById(progressId);
            if (progressItem) {
                progressItem.remove();
                
                // Скрываем секцию, если нет активных скачиваний
                const progressContainer = document.getElementById('download-progress-container');
                if (progressContainer.children.length === 0) {
                    document.getElementById('download-progress-section').style.display = 'none';
                }
            }
        }

        function openImageGallery(imageUrl, imageName, element) {
            // Создаем простое модальное окно для просмотра изображения
            const modal = document.createElement('div');
            modal.className = 'file-preview-modal image-gallery-modal';
            modal.id = 'image-gallery-modal';

            modal.innerHTML = `
                <div class="file-preview-modal-content">
                    <div class="file-preview-modal-header">
                        <h3>${imageName}</h3>
                        <button class="btn-icon" onclick="closeImageGallery()">✕</button>
                    </div>
                    <div class="file-preview-modal-body">
                        <div class="image-gallery-fullscreen">
                            <div class="image-gallery-container">
                                <img src="${imageUrl}" alt="${imageName}" class="image-gallery-image">
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }



        function closeImageGallery() {
            const modal = document.getElementById('image-gallery-modal');
            if (modal) {
                modal.remove();
            }
        }

        function downloadImageFile(imageUrl, fileName) {
            console.log(`📥 Скачивание изображения: ${fileName}`);
            
            try {
                // Создаем ссылку для скачивания
                const a = document.createElement('a');
                a.href = imageUrl;
                a.download = fileName;
                a.style.display = 'none';
                
                // Добавляем в DOM и кликаем
                document.body.appendChild(a);
                a.click();
                
                // Удаляем ссылку
                document.body.removeChild(a);
                
                console.log(`✅ Изображение ${fileName} отправлено на скачивание`);
                
                // Показываем уведомление
                showNotification(`Изображение ${fileName} отправлено на скачивание`, 'success');
                
            } catch (error) {
                console.error(`❌ Ошибка при скачивании изображения ${fileName}:`, error);
                showNotification(`Ошибка при скачивании изображения ${fileName}`, 'error');
            }
        }

        function downloadFile(fileUrl, fileName) {
            console.log(`📥 Скачивание файла: ${fileName}`);
            
            try {
                // Создаем ссылку для скачивания
                const a = document.createElement('a');
                a.href = fileUrl;
                a.download = fileName;
                a.style.display = 'none';
                
                // Добавляем в DOM и кликаем
                document.body.appendChild(a);
                a.click();
                
                // Удаляем ссылку
                document.body.removeChild(a);
                
                console.log(`✅ Файл ${fileName} отправлен на скачивание`);
                
                // Показываем уведомление
                showNotification(`Файл ${fileName} отправлен на скачивание`, 'success');
                
            } catch (error) {
                console.error(`❌ Ошибка при скачивании файла ${fileName}:`, error);
                showNotification(`Ошибка при скачивании файла ${fileName}`, 'error');
            }
        }



        async function previewWordDocument(fileUrl, fileName) {
            console.log(`👁️ Предпросмотр Word документа: ${fileName}`);
            
            try {
                // Показываем уведомление о загрузке
                showNotification(`Загружаем предпросмотр документа ${fileName}...`, 'info');
                
                // Получаем файл
                const token = document.getElementById('moodle-token')?.value;
                let url = fileUrl;
                if (token && !url.includes('token=')) {
                    const separator = url.includes('?') ? '&' : '?';
                    url += `${separator}token=${token}`;
                }
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                
                // Конвертируем Word в HTML
                const mammoth = require('mammoth');
                const result = await mammoth.convertToHtml({ arrayBuffer });
                
                if (result.messages.length > 0) {
                    console.log('⚠️ Предупреждения при конвертации:', result.messages);
                }
                
                // Находим текущее модальное окно и заменяем содержимое
                const modal = document.querySelector('.file-preview-modal');
                const modalBody = modal?.querySelector('.file-preview-modal-body');
                
                if (modal && modalBody) {
                    modalBody.innerHTML = `
                        <div class="word-preview-content">
                            ${result.value}
                        </div>
                    `;
                    
                    console.log(`✅ Предпросмотр Word документа ${fileName} загружен`);
                    showNotification(`Предпросмотр документа ${fileName} загружен`, 'success');
                    
                } else {
                    throw new Error('Модальное окно не найдено');
                }
                
            } catch (error) {
                console.error(`❌ Ошибка при предпросмотре Word документа ${fileName}:`, error);
                showNotification(`Ошибка при предпросмотре документа ${fileName}. Попробуйте скачать файл.`, 'error');
                
                // Fallback: открываем в новой вкладке
                try {
                    window.open(fileUrl, '_blank');
                    showNotification(`Документ ${fileName} открыт в новой вкладке`, 'info');
                } catch (fallbackError) {
                    console.error('Ошибка при открытии в новой вкладке:', fallbackError);
                }
            }
        }



        function preloadVideoFiles(files) {
            console.log('🎬 Начинаем фоновую загрузку видео файлов...');
            
            // Загружаем только первые 2 видео файла для экономии ресурсов
            const videoFiles = files.filter(file => {
                const fileName = file.filename || file.name || '';
                const fileExtension = fileName.split('.').pop().toLowerCase();
                return ['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm'].includes(fileExtension);
            }).slice(0, 2); // Только первые 2 видео
            
            videoFiles.forEach((file, index) => {
                const fileName = file.filename || file.name || '';
                console.log(`📹 Фоновая загрузка видео ${index + 1}: ${fileName}`);
                
                // Добавляем токен к URL
                let fileUrl = file.fileurl || file.url || '';
                const token = document.getElementById('moodle-token')?.value;
                if (token && fileUrl && !fileUrl.includes('token=')) {
                    const separator = fileUrl.includes('?') ? '&' : '?';
                    fileUrl += `${separator}token=${token}`;
                }
                
                // Создаем скрытый video элемент для предварительной загрузки
                const preloadVideo = document.createElement('video');
                preloadVideo.style.display = 'none';
                preloadVideo.preload = 'metadata'; // Только метаданные для экономии
                preloadVideo.muted = true;
                
                // Устанавливаем источник
                preloadVideo.src = fileUrl;
                
                // Добавляем обработчики событий
                preloadVideo.addEventListener('loadedmetadata', () => {
                    console.log(`✅ Метаданные загружены: ${fileName}`);
                    // Удаляем элемент после загрузки метаданных
                    setTimeout(() => {
                        if (preloadVideo.parentNode) {
                            preloadVideo.parentNode.removeChild(preloadVideo);
                        }
                    }, 500);
                });
                
                preloadVideo.addEventListener('error', (e) => {
                    console.error(`❌ Ошибка загрузки метаданных: ${fileName}`, e);
                    if (preloadVideo.parentNode) {
                        preloadVideo.parentNode.removeChild(preloadVideo);
                    }
                });
                
                // Добавляем элемент в DOM для начала загрузки
                document.body.appendChild(preloadVideo);
            });
        }
        function saveGradeFromModal() {
            if (!moodleConfig.currentAssignment || !moodleConfig.currentAssignment.students) {
                console.log('❌ Нет данных о текущем задании или студентах');
                return;
            }
            
            const gradeInput = document.getElementById('modal-grade-input');
            const grade = gradeInput.value;
            const studentIndex = moodleConfig.selectedStudentIndex;
            
            if (studentIndex !== undefined && grade !== '') {
                const student = moodleConfig.currentAssignment.students[studentIndex];
                console.log(`💾 Сохраняем оценку ${grade} для студента ${student.fullname}`);
                submitStudentGrade(student.id, grade);
                
                // Закрываем модальное окно
                const modal = document.querySelector('.file-preview-modal');
                if (modal) {
                    modal.remove();
                }
            } else {
                console.log('❌ Нет оценки для сохранения');
                showNotification('Введите оценку', 'warning');
            }
        }

        function submitSelectedStudentGrade() {
            if (!moodleConfig.currentAssignment || !moodleConfig.currentAssignment.students) {
                return;
            }
            
            const gradeInput = document.getElementById('student-grade-input');
            const commentInput = document.getElementById('student-comment-input');
            const grade = gradeInput.value;
            const comment = commentInput.value;
            const studentIndex = moodleConfig.selectedStudentIndex;
            
            if (studentIndex !== undefined && grade !== '') {
                // Проверяем, есть ли комментарий
                if (!comment || comment.trim() === '') {
                    showNotification('Введите комментарий', 'error');
                    return;
                }
                
                const student = moodleConfig.currentAssignment.students[studentIndex];
                submitStudentGrade(student.id, grade, comment);
            } else if (grade === '') {
                showNotification('Пожалуйста, введите оценку', 'warning');
            }
        }

        function createTestData() {
            console.log('🧪 Создание тестовых данных...');
            
            // Создаем тестовое задание
            const testAssignment = {
                id: 'test-assignment-1',
                name: 'Тестовое задание - Практика монтажа'
            };
            
            console.log('📝 Тестовое задание:', testAssignment);
            
            // Создаем тестовых студентов
            const testStudents = [
                {
                    id: 1,
                    fullname: 'Анна Баева',
                    email: 'anna.baeva@test.com',
                    submitted: true,
                    requiresgrading: false,
                    grade: 5.00,
                    submission_text: 'Выполнила практическое задание по монтажу. Использовала Adobe Premiere Pro для создания видеоролика длительностью 2 минуты. Работа включает в себя нарезку кадров, добавление переходов и базовую цветокоррекцию.',
                    submission_files: [
                        {
                            name: 'DR11_Baeva_CLIP.drp',
                            url: '#',
                            size: 2048576,
                            type: 'application/octet-stream'
                        }
                    ]
                },
                {
                    id: 2,
                    fullname: 'Павел Платонов',
                    email: 'pavel.platonov@test.com',
                    submitted: true,
                    requiresgrading: true,
                    grade: null,
                    submission_text: 'Создал монтажный проект в DaVinci Resolve. Основные элементы: нарезка видео, добавление титров, работа со звуком. Проект сохранен в формате .drp.',
                    submission_files: [
                        {
                            name: 'Platonov_Project.drp',
                            url: '#',
                            size: 1536000,
                            type: 'application/octet-stream'
                        },
                        {
                            name: 'Platonov_Video.mp4',
                            url: '#',
                            size: 52428800,
                            type: 'video/mp4'
                        }
                    ]
                },
                {
                    id: 3,
                    fullname: 'Екатерина Белостоцкая',
                    email: 'ekaterina.belostotskaya@test.com',
                    submitted: true,
                    requiresgrading: false,
                    grade: 4.50,
                    submission_text: 'Практическая работа выполнена в соответствии с требованиями. Использовала различные техники монтажа: параллельный монтаж, монтаж по движению, ритмический монтаж.',
                    submission_files: [
                        {
                            name: 'Belostotskaya_Final.drp',
                            url: '#',
                            size: 3072000,
                            type: 'application/octet-stream'
                        }
                    ]
                },
                {
                    id: 4,
                    fullname: 'Алексей Орлов',
                    email: 'alexey.orlov@test.com',
                    submitted: false,
                    requiresgrading: false,
                    grade: null,
                    submission_text: '',
                    submission_files: []
                },
                {
                    id: 5,
                    fullname: 'Анастасия Монина',
                    email: 'anastasia.monina@test.com',
                    submitted: true,
                    requiresgrading: true,
                    grade: null,
                    submission_text: 'Выполнила задание по монтажу. Работа включает в себя создание трейлера для короткометражного фильма с использованием динамичных переходов и эффектов.',
                    submission_files: [
                        {
                            name: 'Monina_Trailer.drp',
                            url: '#',
                            size: 4096000,
                            type: 'application/octet-stream'
                        },
                        {
                            name: 'Monina_Trailer.mp4',
                            url: '#',
                            size: 104857600,
                            type: 'video/mp4'
                        }
                    ]
                }
            ];
            
            // Сохраняем тестовые данные
            moodleConfig.currentAssignment = {
                id: testAssignment.id,
                name: testAssignment.name,
                students: testStudents
            };
            saveData();
            
            // Обновляем информацию о задании
            document.getElementById('assignment-name').textContent = testAssignment.name;
            document.getElementById('assignment-students').textContent = testStudents.length;
            
            const gradedCount = testStudents.filter(s => s.grade !== null).length;
            document.getElementById('assignment-graded').textContent = `${gradedCount}/${testStudents.length}`;
            
            document.getElementById('assignment-info').style.display = 'block';
            
            // Показываем список студентов
            console.log('🎯 Вызываем showStudentsList с тестовыми данными...');
            showStudentsList(testStudents);
            
            updateMoodleStatus('connected', `Тестовые данные: ${testStudents.length} студентов`);
            
            console.log('✅ Тестовые данные созданы:', testStudents);
        }

        async function updateStudentGrade(studentId, grade) {
            // Сохраняем оценку локально
            if (moodleConfig.currentAssignment && moodleConfig.currentAssignment.students) {
                const student = moodleConfig.currentAssignment.students.find(s => s.id === studentId);
                if (student) {
                    student.grade = grade;
                    saveData();
                }
            }
        }

        /**
         * Функция для сохранения оценки и комментария в Moodle
         * @param {number} assignmentId - ID задания
         * @param {number} userId - ID пользователя
         * @param {number} gradeValue - Оценка
         * @param {string} commentText - Комментарий
         */
        async function submitStudentGradeAndComment(assignmentId, userId, gradeValue, commentText) {
            console.log('🚀 submitStudentGradeAndComment вызвана с параметрами:', {
                assignmentId,
                userId,
                gradeValue,
                commentText
            });

            // Получаем актуальные значения URL и токена
            const url = document.getElementById('moodle-url')?.value;
            const token = document.getElementById('moodle-token')?.value;

            if (!url || !token) {
                console.error('❌ URL или токен Moodle не настроены');
                throw new Error('URL или токен Moodle не настроены');
            }

            if (!assignmentId || !userId || gradeValue === null || gradeValue === undefined) {
                console.error('❌ Неверные параметры:', { assignmentId, userId, gradeValue });
                throw new Error('Неверные параметры для сохранения оценки');
            }

            try {
                console.log('📤 Подготовка данных для отправки в Moodle...');
                
                // Создаем параметры запроса
                const params = new URLSearchParams({
                    wstoken: token,
                    moodlewsrestformat: "json",
                    wsfunction: "mod_assign_save_grade",
                    assignmentid: assignmentId,
                    userid: userId,
                    grade: gradeValue,
                    attemptnumber: "-1", // -1 = последняя попытка
                    addattempt: "0",
                    workflowstate: "graded", // Изменено с "released" на "graded"
                    applytoall: "0"
                });

                // Добавляем комментарий, если он есть
                if (commentText && commentText.trim()) {
                    console.log('📝 Добавляем комментарий к запросу');
                    params.append('plugindata[assignfeedbackcomments_editor][text]', commentText.trim());
                    params.append('plugindata[assignfeedbackcomments_editor][format]', '1'); // 1 = HTML формат
                }

                console.log('📤 Отправка запроса в Moodle...');
                console.log('🔗 URL:', `${url}/webservice/rest/server.php`);
                console.log('📋 Параметры:', Object.fromEntries(params));

                // Отправляем запрос
                const response = await fetch(`${url}/webservice/rest/server.php?${params.toString()}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                console.log('📥 Получен ответ от Moodle');
                console.log('📊 Статус ответа:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Парсим ответ
                const responseText = await response.text();
                console.log('📄 Сырой ответ:', responseText);

                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('📥 Парсированный ответ:', data);
                } catch (parseError) {
                    console.error('❌ Ошибка парсинга JSON:', parseError);
                    throw new Error('Неверный формат ответа от Moodle');
                }

                // Проверяем результат
                if (data === null) {
                    console.log('✅ Оценка и комментарий успешно сохранены! (ответ: null)');
                    return { success: true, message: 'Оценка и комментарий успешно сохранены' };
                }

                if (data && data.exception) {
                    console.error('❌ Ошибка API Moodle:', data);
                    throw new Error(data.message || 'Ошибка API Moodle');
                }

                if (data && data.errorcode) {
                    console.error('❌ Ошибка Moodle:', data);
                    throw new Error(data.message || 'Ошибка Moodle');
                }

                console.log('✅ Оценка и комментарий успешно сохранены!');
                return { success: true, message: 'Оценка и комментарий успешно сохранены' };

            } catch (error) {
                console.error('❌ Ошибка в submitStudentGradeAndComment:', error);
                throw error;
            }
        }

        async function submitStudentGrade(studentId, grade = null, comment = '') {
            const student = moodleConfig.currentAssignment?.students?.find(s => s.id === studentId);
            if (!student) {
                showNotification('Студент не найден', 'error');
                return;
            }
            
            // Если оценка передана как параметр, используем её, иначе берем из студента
            const finalGrade = grade !== null ? grade : student.grade;
            
            if (!finalGrade) {
                showNotification('Введите оценку', 'warning');
                return;
            }
            
            try {
                console.log('🎯 Вызов submitStudentGradeAndComment для студента:', student.fullname);
                
                // Используем новую функцию
                const result = await submitStudentGradeAndComment(
                    moodleConfig.currentAssignment.id,
                    studentId,
                    finalGrade,
                    comment || ''
                );
                
                console.log('✅ Результат сохранения:', result);
                
                // Показываем менее заметное уведомление
                showNotification(`Оценка ${finalGrade} сохранена для ${student.fullname}`, 'success');
                
                // Обновляем данные в локальных данных
                    student.grade = finalGrade;
                student.comment = comment;
                    saveData();
                    
                    // Обновляем отображение в интерфейсе
                    if (moodleConfig.selectedStudentIndex !== undefined) {
                        selectStudent(moodleConfig.selectedStudentIndex);
                    }
                
            } catch (error) {
                console.error('❌ Ошибка сохранения оценки:', error);
                showNotification(`Ошибка: ${error.message}`, 'error');
            }
        }

        function exportGrades() {
            if (!moodleConfig.currentAssignment || !moodleConfig.currentAssignment.students) {
                showNotification('Сначала загрузите ответы на задание', 'warning');
                return;
            }
            
            const students = moodleConfig.currentAssignment.students;
            const grades = students.map(student => ({
                student: student.fullname,
                email: student.email,
                grade: student.grade || 'Не оценено',
                submitted: student.submitted ? 'Сдано' : 'Не сдано',
                requiresgrading: student.requiresgrading ? 'Требует проверки' : 'Проверено'
            }));
            
            const csv = [
                'Студент,Email,Оценка,Статус сдачи,Статус проверки',
                ...grades.map(g => `"${g.student}","${g.email}",${g.grade},${g.submitted},${g.requiresgrading}`)
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `grades_${moodleConfig.currentAssignment.name.replace(/[^a-zA-Z0-9]/g, '_')}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification(`Экспортировано ${students.length} записей`, 'success');
        }

        /**
         * Функция поиска студентов по ФИО
         */
        function filterStudents(searchTerm) {
            console.log('🔍 Поиск студентов:', searchTerm);
            
            if (!moodleConfig.currentAssignment || !moodleConfig.currentAssignment.students) {
                return;
            }
            
            const students = moodleConfig.currentAssignment.students;
            let filteredStudents = students.filter(student => 
                student.fullname.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (student.department && student.department.toLowerCase().includes(searchTerm.toLowerCase()))
            );
            
            // Применяем активный фильтр по статусу
            const activeFilter = document.querySelector('.filter-btn.active');
            if (activeFilter && activeFilter.dataset.filter !== 'all') {
                const status = activeFilter.dataset.filter;
                switch (status) {
                    case 'not-submitted':
                        filteredStudents = filteredStudents.filter(student => !student.submitted);
                        break;
                    case 'not-graded':
                        filteredStudents = filteredStudents.filter(student => !student.grade);
                        break;
                }
            }
            
            console.log(`📊 Найдено ${filteredStudents.length} из ${students.length} студентов`);
            
            // Обновляем отображение списка студентов
            const studentsList = document.querySelector('.students-list');
            if (studentsList) {
                studentsList.innerHTML = filteredStudents.map((student, index) => `
                    <div class="student-list-item" data-original-index="${students.indexOf(student)}" onclick="selectStudentByOriginalIndex(${students.indexOf(student)})">
                        <div class="student-list-info">
                            <div class="student-list-name">${student.fullname}</div>
                            <div class="student-list-status">
                                <span class="status-badge ${student.submitted ? 'submitted' : 'not-submitted'}">
                                    ${student.submitted ? '✅ Сдано' : '❌ Не сдано'}
                                </span>
                                ${student.grade ? `<span class="grade-badge">${formatGrade(student.grade)}</span>` : '<span class="grade-badge not-graded">🔴 Не оценено</span>'}
                                ${student.submission_files && student.submission_files.length > 0 ? `<span class="files-badge">📎 ${student.submission_files.length}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        /**
         * Функция фильтрации студентов по статусу
         */
        function filterByStatus(status) {
            console.log('🔍 Фильтрация по статусу:', status);
            
            // Обновляем активную кнопку фильтра
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${status}"]`).classList.add('active');
            
            if (!moodleConfig.currentAssignment || !moodleConfig.currentAssignment.students) {
                return;
            }
            
            const students = moodleConfig.currentAssignment.students;
            let filteredStudents = students;
            
            // Применяем фильтр по статусу
            switch (status) {
                case 'submitted':
                    filteredStudents = students.filter(student => student.submitted);
                    break;
                case 'not-graded':
                    filteredStudents = students.filter(student => !student.grade);
                    break;
                case 'all':
                default:
                    filteredStudents = students;
                    break;
            }
            
            // Применяем текущий поисковый запрос
            const searchInput = document.getElementById('students-search-input');
            if (searchInput && searchInput.value.trim()) {
                const searchTerm = searchInput.value.trim().toLowerCase();
                filteredStudents = filteredStudents.filter(student => 
                    student.fullname.toLowerCase().includes(searchTerm) ||
                    (student.department && student.department.toLowerCase().includes(searchTerm))
                );
            }
            
            console.log(`📊 Отфильтровано ${filteredStudents.length} из ${students.length} студентов`);
            
            // Обновляем отображение списка студентов
            const studentsList = document.querySelector('.students-list');
            if (studentsList) {
                studentsList.innerHTML = filteredStudents.map((student, index) => `
                    <div class="student-list-item" data-original-index="${students.indexOf(student)}" onclick="selectStudentByOriginalIndex(${students.indexOf(student)})">
                        <div class="student-list-info">
                            <div class="student-list-name">${student.fullname}</div>
                            <div class="student-list-status">
                                <span class="status-badge ${student.submitted ? 'submitted' : 'not-submitted'}">
                                    ${student.submitted ? '✅ Сдано' : '❌ Не сдано'}
                                </span>
                                ${student.grade ? `<span class="grade-badge">${formatGrade(student.grade)}</span>` : '<span class="grade-badge not-graded">🔴 Не оценено</span>'}
                                ${student.submission_files && student.submission_files.length > 0 ? `<span class="files-badge">📎 ${student.submission_files.length}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        /**
         * Функция выбора студента по оригинальному индексу
         */
        function selectStudentByOriginalIndex(originalIndex) {
            console.log('👤 Выбор студента по оригинальному индексу:', originalIndex);
            selectStudent(originalIndex);
            
            // Обновляем активный элемент в списке
            document.querySelectorAll('.student-list-item').forEach((item) => {
                const originalIdx = parseInt(item.getAttribute('data-original-index') || '-1', 10);
                item.classList.toggle('active', originalIdx === originalIndex);
            });
        }

        // Добавляем обработчик поиска при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('students-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    filterStudents(e.target.value);
                });
            }
        });

        /**
         * Функция форматирования даты в человекочитаемый вид
         */
        function formatDate(unix) {
            if (!unix || unix <= 0) return "—";
            return new Date(unix * 1000).toLocaleString('ru-RU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        /**
         * Функция для правильного склонения слова "балл"
         */
        function formatGrade(grade) {
            const num = Math.round(grade);
            const lastDigit = num % 10;
            const lastTwoDigits = num % 100;
            
            if (lastTwoDigits >= 11 && lastTwoDigits <= 19) {
                return `${num} баллов`;
            } else if (lastDigit === 1) {
                return `${num} балл`;
            } else if (lastDigit >= 2 && lastDigit <= 4) {
                return `${num} балла`;
            } else {
                return `${num} баллов`;
            }
        }

        /**
         * Функция для показа менее заметных уведомлений
         */
        function showNotification(message, type = 'info') {
            // Создаем элемент уведомления
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Добавляем в DOM
            document.body.appendChild(notification);
            
            // Показываем уведомление
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Автоматически скрываем через 3 секунды
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }



        /**
         * Функция показа модального окна подтверждения отмены
         */
        function showCancelConfirmation(onConfirm) {
            // Создаем модальное окно
            const modal = document.createElement('div');
            modal.className = 'cancel-confirmation-modal';
            modal.innerHTML = `
                <div class="cancel-confirmation-content">
                    <h3 class="cancel-confirmation-title">Отменить скачивание?</h3>
                    <p class="cancel-confirmation-text">Вы уверены, что хотите отменить текущее скачивание? Уже скачанные файлы останутся в выбранной папке.</p>
                    <div class="cancel-confirmation-buttons">
                        <button class="cancel-confirmation-btn" onclick="this.closest('.cancel-confirmation-modal').remove()">Продолжить</button>
                        <button class="cancel-confirmation-btn cancel" onclick="confirmCancel(this)">Отменить</button>
                    </div>
                </div>
            `;
            
            // Сохраняем callback в data-атрибуте
            modal.dataset.onConfirm = 'pending';
            
            // Добавляем в DOM
            document.body.appendChild(modal);
            
            // Показываем модальное окно
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 100);
            
            // Сохраняем callback в глобальной переменной
            window.pendingCancelCallback = onConfirm;
        }
        
        /**
         * Функция подтверждения отмены
         */
        function confirmCancel(button) {
            // Удаляем модальное окно
            const modal = button.closest('.cancel-confirmation-modal');
            if (modal) {
                modal.remove();
            }
            
            // Вызываем сохраненный callback
            if (window.pendingCancelCallback && typeof window.pendingCancelCallback === 'function') {
                window.pendingCancelCallback();
                window.pendingCancelCallback = null;
            }
        }

        /**
         * Функция загрузки настроек задания
         */
        async function loadAssignmentSettings() {
            console.log('🔧 Загрузка настроек задания...');
            
            if (!moodleConfig.currentAssignment || !moodleConfig.currentAssignment.id) {
                console.log('❌ Нет активного задания');
                return;
            }
            
            const assignmentId = moodleConfig.currentAssignment.id;
            const url = document.getElementById('moodle-url').value;
            const token = document.getElementById('moodle-token').value;
            
            console.log('📋 Параметры загрузки настроек:', {
                assignmentId: assignmentId,
                url: url,
                hasToken: !!token
            });
            
            try {
                // Используем mod_assign_get_assignments для получения данных задания
                const response = await fetch(`${url}/webservice/rest/server.php?wstoken=${token}&wsfunction=mod_assign_get_assignments&assignmentids[]=${assignmentId}&moodlewsrestformat=json`);
                
                console.log('📡 Ответ API mod_assign_get_assignments:', response.status, response.statusText);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('📋 Данные задания:', data);
                    
                    if (data.exception) {
                        console.log('❌ API вернул ошибку:', data);
                        
                        // Проверяем, является ли ошибка связанной с недействительным токеном
                        if (data.errorcode === 'invalidtoken') {
                            showNotification('warning', 'Токен Moodle устарел. Пожалуйста, обновите токен в настройках.', 10000);
                        }
                        
                        showAssignmentBlocks();
                        return;
                    }
                    
                    // Ищем наше задание в ответе
                    let assignment = null;
                    if (data.courses && data.courses.length > 0) {
                        for (const course of data.courses) {
                            if (course.assignments && course.assignments.length > 0) {
                                assignment = course.assignments.find(assign => assign.id == assignmentId);
                                if (assignment) break;
                            }
                        }
                    }
                    
                    if (assignment) {
                        console.log('📋 Найдено задание:', assignment);
                        
                        // Заполняем блок дат из данных задания
                        const datesElement = document.getElementById('assignment-dates');
                        if (datesElement) {
                            const allowFrom = assignment.allowsubmissionsfromdate || null;
                            const dueDate = assignment.duedate || null;
                            const cutoffDate = assignment.cutoffdate || null;
                            
                            document.getElementById('assignment-allow-from').textContent = formatDate(allowFrom);
                            document.getElementById('assignment-due-date').textContent = formatDate(dueDate);
                            document.getElementById('assignment-cutoff-date').textContent = formatDate(cutoffDate);
                            datesElement.style.display = 'block';
                            console.log('✅ Блок дат заполнен из API mod_assign_get_assignments');
                        }
                    } else {
                        console.log('❌ Задание не найдено в ответе API');
                        
                        // Fallback: используем данные из уже загруженного задания
                        console.log('🔍 Пробуем использовать данные из moodleConfig.currentAssignment:', moodleConfig.currentAssignment);
                        
                        if (moodleConfig.currentAssignment) {
                            const datesElement = document.getElementById('assignment-dates');
                            if (datesElement) {
                                const allowFrom = moodleConfig.currentAssignment.allowsubmissionsfromdate || null;
                                const dueDate = moodleConfig.currentAssignment.duedate || null;
                                const cutoffDate = moodleConfig.currentAssignment.cutoffdate || null;
                                
                                document.getElementById('assignment-allow-from').textContent = formatDate(allowFrom);
                                document.getElementById('assignment-due-date').textContent = formatDate(dueDate);
                                document.getElementById('assignment-cutoff-date').textContent = formatDate(cutoffDate);
                                datesElement.style.display = 'block';
                                console.log('✅ Блок дат заполнен из moodleConfig.currentAssignment');
                            }
                        } else {
                            showAssignmentBlocks();
                        }
                    }
                } else {
                    console.log('❌ HTTP ошибка загрузки задания:', response.status, response.statusText);
                    showAssignmentBlocks();
                }
            } catch (error) {
                console.error('❌ Ошибка загрузки настроек:', error);
                showAssignmentBlocks();
            }
        }

        /**
         * Функция показа блоков информации о задании
         */
        function showAssignmentBlocks() {
            // Скрываем блок дат
            const datesElement = document.getElementById('assignment-dates');
            if (datesElement) {
                datesElement.style.display = 'none';
                console.log('✅ Блок дат скрыт');
            }
        }

        // ===== СИСТЕМА ШАБЛОНОВ КОММЕНТАРИЕВ =====
        
        // Глобальные переменные для шаблонов
        let commentTemplates = [
            'Отличная работа! Задание выполнено качественно и в срок.',
            'Хорошая работа, но есть небольшие недочеты.',
            'Работа требует доработки. Обратите внимание на детали.',
            'Задание выполнено не полностью. Необходима переработка.',
            'Отсутствует сдача работы в срок.',
            'Работа не соответствует требованиям задания.'
        ];
        // Инициализация системы шаблонов
        document.addEventListener('DOMContentLoaded', function() {
            // Загружаем шаблоны из localStorage
            const savedTemplates = localStorage.getItem('commentTemplates');
            if (savedTemplates) {
                commentTemplates = JSON.parse(savedTemplates);
            }
            
            // Добавляем обработчики горячих клавиш
            document.addEventListener('keydown', handleTemplateHotkeys);
            
            // Добавляем обработчики для кнопок управления окном
            const closeBtn = document.getElementById('window-close');
            const minimizeBtn = document.getElementById('window-minimize');
            const maximizeBtn = document.getElementById('window-maximize');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    if (window.electronAPI) {
                        window.electronAPI.closeWindow();
                    }
                });
            }
            
            if (minimizeBtn) {
                minimizeBtn.addEventListener('click', () => {
                    if (window.electronAPI) {
                        window.electronAPI.minimizeWindow();
                    }
                });
            }
            
            if (maximizeBtn) {
                maximizeBtn.addEventListener('click', () => {
                    if (window.electronAPI) {
                        window.electronAPI.maximizeWindow();
                    }
                });
            }
            
            // Добавляем обработчики для динамически создаваемых полей
            setupDynamicEventListeners();
            

        });
        
        // Обработчик IPC для открытия модального окна шаблонов из меню
        if (window.electronAPI) {
            window.electronAPI.onOpenTemplatesModal(() => {
                openTemplatesModal();
            });
            
            window.electronAPI.onOpenHotkeysModal(() => {
                openHotkeysModal();
            });
        }
        
                // Функция открытия модального окна шаблонов
        function openTemplatesModal() {
            const modal = document.createElement('div');
            modal.className = 'templates-modal';
            modal.innerHTML = `
                <div class="templates-content">
                    <div class="templates-header">
                        <h3>Шаблоны комментариев</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="templates-body">
                        <div class="templates-description">
                            <p>Настройте шаблоны комментариев для быстрого использования.</p>
                        </div>
                        <div class="templates-list">
                            ${commentTemplates.map((template, index) => {
                                const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                                const keyName = isMac ? '⌘' : 'Ctrl';
                                return `
                                    <div class="template-item">
                                        <div class="template-header">
                                            <label>Комментарий ${index + 1}:</label>
                                        </div>
                                        <div class="template-input-container">
                                            <div class="template-hotkey-icon">
                                                <span class="cmd-symbol">${keyName}</span>
                                                <span class="cmd-number">${index + 1}</span>
                                            </div>
                                            <input type="text" class="template-input" data-index="${index}" 
                                                   placeholder="Введите шаблон комментария..." value="${template}">
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="templates-actions">
                            <button class="btn btn-primary">Сохранить</button>
                            <button class="btn btn-secondary">Отмена</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Обработчики уже настроены через глобальное делегирование событий
            console.log('📝 Модальное окно шаблонов создано');
        }
        
        // Функция закрытия модального окна шаблонов
        function closeTemplatesModal() {
            const modal = document.querySelector('.templates-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Функция открытия модального окна горячих клавиш
        function openHotkeysModal() {
            const modal = document.createElement('div');
            modal.className = 'hotkeys-modal';
            modal.innerHTML = `
                <div class="hotkeys-content">
                    <div class="hotkeys-header">
                        <h3>Горячие клавиши</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="hotkeys-body">
                        <div class="hotkeys-section">
                            <h4>🧭 Навигация по студентам</h4>
                            <div class="hotkey-item">
                                <span class="hotkey-key">A</span>
                                <span class="hotkey-description">Переход к предыдущему студенту</span>
                            </div>
                            <div class="hotkey-item">
                                <span class="hotkey-key">D</span>
                                <span class="hotkey-description">Переход к следующему студенту</span>
                            </div>
                        </div>
                        
                        <div class="hotkeys-section">
                            <h4>📝 Шаблоны комментариев</h4>
                            <div class="hotkey-item">
                                <span class="hotkey-key">⌘ + 1</span>
                                <span class="hotkey-description">Применить шаблон комментария 1</span>
                            </div>
                            <div class="hotkey-item">
                                <span class="hotkey-key">⌘ + 2</span>
                                <span class="hotkey-description">Применить шаблон комментария 2</span>
                            </div>
                            <div class="hotkey-item">
                                <span class="hotkey-key">⌘ + 3</span>
                                <span class="hotkey-description">Применить шаблон комментария 3</span>
                            </div>
                            <div class="hotkey-item">
                                <span class="hotkey-key">⌘ + 4</span>
                                <span class="hotkey-description">Применить шаблон комментария 4</span>
                            </div>
                            <div class="hotkey-item">
                                <span class="hotkey-key">⌘ + 5</span>
                                <span class="hotkey-description">Применить шаблон комментария 5</span>
                            </div>
                            <div class="hotkey-item">
                                <span class="hotkey-key">⌘ + 6</span>
                                <span class="hotkey-description">Применить шаблон комментария 6</span>
                            </div>
                        </div>
                        
                        <div class="hotkeys-section">
                            <h4>⚙️ Меню приложения</h4>
                            <div class="hotkey-item">
                                <span class="hotkey-key">⌘ + T</span>
                                <span class="hotkey-description">Открыть шаблоны комментариев</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('⌨️ Модальное окно горячих клавиш создано');
        }
        
        // Функция закрытия модального окна горячих клавиш
        function closeHotkeysModal() {
            const modal = document.querySelector('.hotkeys-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Функция сохранения шаблонов
        function saveTemplates() {
            localStorage.setItem('commentTemplates', JSON.stringify(commentTemplates));
            closeTemplatesModal();
            
            // Показываем уведомление
            showNotification('Шаблоны комментариев сохранены!', 'success');
        }
        
        // Функция обработки горячих клавиш
        function handleTemplateHotkeys(event) {
            // Проверяем, что фокус не в поле ввода
            const activeElement = document.activeElement;
            if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                return;
            }
            
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const modifierKey = isMac ? event.metaKey : event.ctrlKey;
            
            // Обработка шаблонов комментариев (Cmd/Ctrl + 1-6)
            if (modifierKey && !event.shiftKey && !event.altKey) {
                const key = event.key;
                if (key >= '1' && key <= '6') {
                    event.preventDefault();
                    const templateIndex = parseInt(key) - 1;
                    applyTemplate(templateIndex);
                }
            }
            
            // Обработка навигации по студентам (A и D)
            if (!modifierKey && !event.shiftKey && !event.altKey) {
                if (event.key === 'a' || event.key === 'A') {
                    event.preventDefault();
                    navigateToPreviousStudent();
                } else if (event.key === 'd' || event.key === 'D') {
                    event.preventDefault();
                    navigateToNextStudent();
                }
            }
        }
        
        // Функция перехода к предыдущему студенту
        function navigateToPreviousStudent() {
            if (!moodleConfig.currentAssignment || !moodleConfig.currentAssignment.students) {
                showNotification('Нет доступных студентов', 'warning');
                return;
            }
            
            const students = moodleConfig.currentAssignment.students;
            const currentIndex = moodleConfig.selectedStudentIndex || 0;
            const newIndex = currentIndex > 0 ? currentIndex - 1 : students.length - 1;
            
            selectStudent(newIndex);
            showNotification(`Переход к студенту: ${students[newIndex].fullname}`, 'info');
        }
        
        // Функция перехода к следующему студенту
        function navigateToNextStudent() {
            if (!moodleConfig.currentAssignment || !moodleConfig.currentAssignment.students) {
                showNotification('Нет доступных студентов', 'warning');
                return;
            }
            
            const students = moodleConfig.currentAssignment.students;
            const currentIndex = moodleConfig.selectedStudentIndex || 0;
            const newIndex = currentIndex < students.length - 1 ? currentIndex + 1 : 0;
            
            selectStudent(newIndex);
            showNotification(`Переход к студенту: ${students[newIndex].fullname}`, 'info');
        }
        
        // Функция применения шаблона
        function applyTemplate(templateIndex) {
            // Получаем актуальные шаблоны из localStorage
            const savedTemplates = localStorage.getItem('comment-templates');
            let templates = commentTemplates; // fallback на дефолтные
            
            if (savedTemplates) {
                try {
                    const parsedTemplates = JSON.parse(savedTemplates);
                    // Преобразуем объект в массив
                    templates = [];
                    for (let i = 1; i <= 6; i++) {
                        templates.push(parsedTemplates[`template${i}`] || commentTemplates[i - 1]);
                    }
                } catch (e) {
                    console.error('Ошибка парсинга шаблонов:', e);
                    templates = commentTemplates;
                }
            }
            
            if (templateIndex >= 0 && templateIndex < templates.length) {
                const template = templates[templateIndex];
                const commentInput = document.getElementById('student-comment-input');
                
                if (commentInput) {
                    commentInput.value = template;
                    commentInput.focus();
                    
                    // Показываем уведомление
                    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                    const keyName = isMac ? '⌘' : 'Ctrl';
                    showNotification(`Применен шаблон ${templateIndex + 1} (${keyName}${templateIndex + 1})`, 'info');
                } else {
                    showNotification('Откройте работу студента для применения шаблона', 'warning');
                }
            }
        }
        


        // Функция настройки обработчиков для динамически создаваемых элементов
        function setupDynamicEventListeners() {
            console.log('🔧 Настройка динамических обработчиков событий...');
            
            // Используем делегирование событий для динамически создаваемых элементов
            document.addEventListener('click', function(event) {
                console.log('🔧 Событие клика зарегистрировано!');
                console.log('🔧 Target:', event.target);
                console.log('🔧 Target ID:', event.target.id);
                console.log('🔧 Target Class:', event.target.className);
                console.log('🔧 Target Text:', event.target.textContent);
                console.log('🔧 Event Type:', event.type);
                console.log('🔧 Event Button:', event.button);
                console.log('🔧 Event Buttons:', event.buttons);
                console.log('🔧 Клик по элементу:', event.target.id, event.target.className, event.target.textContent);
                
                // Предотвращаем всплытие события, если это кнопка
                if (event.target.tagName === 'BUTTON') {
                    event.stopPropagation();
                }
                console.log('🔧 Событие клика зарегистрировано!');
                console.log('🔧 Target:', event.target);
                console.log('🔧 Target ID:', event.target.id);
                console.log('🔧 Target Class:', event.target.className);
                console.log('🔧 Target Text:', event.target.textContent);
                console.log('🔧 Event Type:', event.type);
                console.log('🔧 Event Button:', event.button);
                console.log('🔧 Event Buttons:', event.buttons);
                console.log('🔧 Клик по элементу:', event.target.id, event.target.className, event.target.textContent);
                
                // Обработчик для кнопки закрытия приложения
                if (event.target.id === 'app-close-btn' || 
                    event.target.closest('#app-close-btn')) {
                    console.log('🔧 Клик по кнопке закрытия приложения!');
                    window.electronAPI.closeWindow();
                }
                
                // Обработчик для кнопки закрытия настроек
                if (event.target.id === 'settings-close-btn' || 
                    event.target.textContent === '✕' ||
                    event.target.closest('#settings-close-btn')) {
                    console.log('🔧 Клик по кнопке закрытия настроек!');
                    toggleSettingsSidebar();
                }
                
                // Обработчик для кнопки настроек в сайдбаре
                if (event.target.id === 'sidebar-toggle-btn' || 
                    event.target.closest('#sidebar-toggle-btn') ||
                    (event.target.textContent === '⚙️' && event.target.closest('.sidebar-settings-btn'))) {
                    console.log('🔧 Клик по кнопке настроек!');
                    console.log('🔧 event.target.id:', event.target.id);
                    console.log('🔧 event.target.textContent:', event.target.textContent);
                    console.log('🔧 event.target.closest:', event.target.closest('#sidebar-toggle-btn'));
                    toggleSettingsSidebar();
                }
                
                // Обработчик для кнопки "Сохранить оценку"
                if (event.target.tagName === 'BUTTON' && 
                    event.target.classList.contains('btn') && 
                    event.target.classList.contains('btn-primary') &&
                    (event.target.textContent.includes('Сохранить оценку') || 
                     event.target.textContent.includes('💾 Сохранить')) &&
                    !event.target.closest('.templates-modal') &&
                    !event.target.closest('.hotkeys-modal')) {
                    console.log('💾 Клик по кнопке сохранения оценки!');
                    submitSelectedStudentGrade();
                }
                
                // Обработчики для кнопок в шаблонах комментариев
                if (event.target.textContent === 'Сохранить' && event.target.closest('.templates-modal')) {
                    console.log('💾 Сохранение шаблонов комментариев...');
                    saveTemplates();
                }
                
                if (event.target.textContent === 'Отмена' && event.target.closest('.templates-modal')) {
                    console.log('❌ Отмена изменений в шаблонах...');
                    closeTemplatesModal();
                }
                
                // Обработчик для кнопки закрытия модального окна шаблонов
                if (event.target.textContent === '×' && event.target.closest('.templates-modal')) {
                    console.log('❌ Закрытие модального окна шаблонов...');
                    closeTemplatesModal();
                }
                
                // Обработчик для кнопки закрытия модального окна горячих клавиш
                if (event.target.textContent === '×' && event.target.closest('.hotkeys-modal')) {
                    console.log('❌ Закрытие модального окна горячих клавиш...');
                    closeHotkeysModal();
                }
                
                // Общий обработчик для всех кнопок (для отладки)
                if (event.target.tagName === 'BUTTON') {
                    console.log('🔘 Клик по кнопке:', event.target.id, event.target.className, event.target.textContent);
                }
                
                // Отладка для всех кликов
                console.log('🖱️ Клик по элементу:', {
                    tagName: event.target.tagName,
                    id: event.target.id,
                    className: event.target.className,
                    textContent: event.target.textContent,
                    isButton: event.target.tagName === 'BUTTON',
                    hasBtnClass: event.target.classList.contains('btn'),
                    hasPrimaryClass: event.target.classList.contains('btn-primary')
                });
            });

            // Обработчики для полей ввода
            document.addEventListener('input', function(event) {
                console.log('📝 Input событие:', event.target.id, event.target.value, event.target.className);
                
                // Обработчик для поля комментария
                if (event.target.id === 'student-comment-input') {
                    console.log('📝 Изменение комментария:', event.target.value);
                }
                
                // Обработчик для поля оценки
                if (event.target.id === 'student-grade-input') {
                    console.log('📊 Изменение оценки:', event.target.value);
                }
                
                // Обработчики для полей настроек
                if (event.target.id === 'moodle-url') {
                    console.log('🌐 Изменение URL Moodle:', event.target.value);
                    saveMoodleConfig();
                }
                
                if (event.target.id === 'moodle-token') {
                    console.log('🔑 Изменение токена Moodle:', event.target.value);
                    saveMoodleConfig();
                }
                
                // Обработчики для полей шаблонов комментариев
                if (event.target.classList.contains('template-input')) {
                    console.log('📝 Изменение шаблона:', event.target.dataset.index, event.target.value);
                    const index = parseInt(event.target.dataset.index);
                    if (!isNaN(index) && index >= 0 && index < commentTemplates.length) {
                        commentTemplates[index] = event.target.value;
                        console.log('💾 Шаблон обновлен:', commentTemplates[index]);
                    }
                }
            });

            // Обработчики для select элементов
            document.addEventListener('change', function(event) {
                console.log('🔄 Change событие:', event.target.id, event.target.value);
                
                // Обработчик для выбора темы
                if (event.target.id === 'theme-select') {
                    console.log('🎨 Изменение темы:', event.target.value);
                    changeTheme();
                }
                
                // Обработчики для полей Moodle
                if (event.target.id === 'moodle-url' || event.target.id === 'moodle-token') {
                    console.log('🔄 Изменение настроек Moodle');
                    saveMoodleConfig();
                }
            });
            
            // Добавляем обработчики для mousedown и mouseup для отладки
            document.addEventListener('mousedown', function(event) {
                console.log('🖱️ MouseDown событие:', event.target.id, event.target.className, event.button);
            });
            
            document.addEventListener('mouseup', function(event) {
                console.log('🖱️ MouseUp событие:', event.target.id, event.target.className, event.button);
            });
            
            console.log('✅ Динамические обработчики событий настроены');
        }

        /**
         * Функция для скачивания всех ответов студентов
         */
        async function downloadAllSubmissions() {
            console.log('📥 Начинаем скачивание всех ответов...');
            
            if (!moodleConfig.currentAssignment || !moodleConfig.currentAssignment.students) {
                showNotification('Нет данных о студентах для скачивания', 'error');
                return;
            }

            // Получаем текущий список студентов с учетом фильтров
            let students = moodleConfig.currentAssignment.students.filter(student => student.submitted);
            
            // Применяем текущий фильтр по статусу
            const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter;
            if (activeFilter && activeFilter !== 'all') {
                switch (activeFilter) {
                    case 'submitted':
                        students = students.filter(student => student.submitted);
                        break;
                    case 'not-graded':
                        students = students.filter(student => !student.grade);
                        break;
                }
            }
            
            // Применяем текущий поисковый запрос
            const searchInput = document.getElementById('students-search-input');
            if (searchInput && searchInput.value.trim()) {
                const searchTerm = searchInput.value.trim().toLowerCase();
                students = students.filter(student => 
                    student.fullname.toLowerCase().includes(searchTerm) ||
                    (student.department && student.department.toLowerCase().includes(searchTerm))
                );
            }
            
            if (students.length === 0) {
                showNotification('Нет сданных работ для скачивания', 'info');
                return;
            }

            // Сначала выбираем папку для скачивания
            try {
                const result = await window.electronAPI.selectDownloadFolder();
                
                if (!result.success || !result.folderPath) {
                    showNotification('Папка для скачивания не выбрана', 'info');
                    return;
                }
                
                const downloadFolder = result.folderPath;
                showNotification(`Папка выбрана: ${downloadFolder}`, 'success');
                
                // Показываем прогресс
                const totalStudents = moodleConfig.currentAssignment.students.filter(student => student.submitted).length;
                if (students.length === totalStudents) {
                    showNotification(`Начинаем скачивание ${students.length} ответов в выбранную папку...`, 'info');
                } else {
                    showNotification(`Начинаем скачивание ${students.length} отфильтрованных ответов из ${totalStudents} в выбранную папку...`, 'info');
                }
                
                // Подсчитываем общее количество файлов
                let totalFiles = 0;
                for (const student of students) {
                    if (student.submission_files && student.submission_files.length > 0) {
                        totalFiles += student.submission_files.length;
                    }
                }
                
                // Создаем центрированный оверлей прогресса
                const progressContainer = document.createElement('div');
                progressContainer.className = 'download-progress-container';
                progressContainer.innerHTML = `
                    <button class="download-progress-cancel" id="download-cancel-btn" title="Отменить скачивание">✕</button>
                    <div class="download-progress-header">
                        <h4>Скачивание файлов</h4>
                        <span class="download-progress-text">0 / ${totalFiles}</span>
                    </div>
                    <div class="download-progress-bar">
                        <div class="download-progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="download-progress-details">
                        <span class="current-file">Готово к скачиванию...</span>
                    </div>
                `;

                // Добавляем прогресс-бар в main-area (оверлей фиксированный, поэтому над всем)
                const mainArea = document.querySelector('.main-area') || document.body;
                mainArea.appendChild(progressContainer);

                // Добавляем обработчик отмены
                const cancelBtn = progressContainer.querySelector('#download-cancel-btn');
                let isCancelled = false;

                cancelBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    showCancelConfirmation(() => {
                        isCancelled = true;
                        showNotification('Скачивание отменено', 'info');
                        if (progressContainer && progressContainer.parentNode) {
                            progressContainer.parentNode.removeChild(progressContainer);
                        }
                    });
                });
                
                let downloadedCount = 0;
                let errorCount = 0;

                for (const student of students) {
                    // Проверяем, не была ли отменена операция
                    if (isCancelled) {
                        console.log('❌ Скачивание отменено пользователем');
                        break;
                    }
                    
                    if (student.submission_files && student.submission_files.length > 0) {
                        try {
                            console.log(`📥 Скачиваем файлы студента: ${student.fullname}`);
                            
                            for (const file of student.submission_files) {
                                // Проверяем отмену перед каждым файлом
                                if (isCancelled) {
                                    console.log('❌ Скачивание отменено пользователем');
                                    break;
                                }
                                
                                try {
                                    // Обновляем прогресс-бар
                                    const progressFill = progressContainer.querySelector('.download-progress-fill');
                                    const progressText = progressContainer.querySelector('.download-progress-text');
                                    const currentFile = progressContainer.querySelector('.current-file');
                                    
                                    if (progressFill && progressText && currentFile) {
                                        const progress = ((downloadedCount + errorCount) / totalFiles) * 100;
                                        progressFill.style.width = `${progress}%`;
                                        progressText.textContent = `${downloadedCount + errorCount} / ${totalFiles}`;
                                        currentFile.textContent = `Скачиваем: ${student.fullname} - ${file.filename || file.name}`;
                                    }
                                    
                                    const token = document.getElementById('moodle-token')?.value;
                                    await downloadFileToFolder(file.fileurl || file.url, file.filename || file.name, student.fullname, downloadFolder, token);
                                    downloadedCount++;
                                    
                                    // Небольшая задержка между скачиваниями
                                    await new Promise(resolve => setTimeout(resolve, 500));
                                    
                                } catch (error) {
                                    console.error(`❌ Ошибка при скачивании файла ${file.filename}:`, error);
                                    errorCount++;
                                }
                            }
                            
                            // Задержка между студентами
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            
                        } catch (error) {
                            console.error(`❌ Ошибка при скачивании файлов студента ${student.fullname}:`, error);
                            errorCount++;
                        }
                    }
                }

                // Удаляем оверлей только если не была отмена
                if (!isCancelled && progressContainer && progressContainer.parentNode) {
                    progressContainer.parentNode.removeChild(progressContainer);
                }
                
                if (isCancelled) {
                    showNotification(`⏹️ Скачивание отменено. Скачано файлов: ${downloadedCount}`, 'info');
                } else if (errorCount === 0) {
                    showNotification(`✅ Все ${downloadedCount} файлов успешно скачаны в папку!`, 'success');
                } else {
                    showNotification(`⚠️ Скачано ${downloadedCount} файлов, ошибок: ${errorCount}`, 'warning');
                }
                
            } catch (error) {
                console.error('Ошибка при выборе папки:', error);
                showNotification('Ошибка при выборе папки для скачивания', 'error');
            }
        }

        /**
         * Функция для скачивания всех файлов конкретного студента
         */
        async function downloadAllStudentFiles(studentName, files) {
            console.log(`📥 Скачиваем все файлы студента: ${studentName}`);
            
            if (!files || files.length === 0) {
                showNotification('Нет файлов для скачивания', 'error');
                return;
            }

            // Сначала выбираем папку для скачивания
            try {
                const result = await window.electronAPI.selectDownloadFolder();
                
                if (!result.success || !result.folderPath) {
                    showNotification('Папка для скачивания не выбрана', 'info');
                    return;
                }
                
                const downloadFolder = result.folderPath;
                showNotification(`Папка выбрана: ${downloadFolder}`, 'success');
                
                // Создаем прогресс-бар для скачивания файлов студента
                const progressContainer = document.createElement('div');
                progressContainer.className = 'download-progress-container';
                progressContainer.innerHTML = `
                    <button class="download-progress-cancel" id="download-cancel-btn" title="Отменить скачивание">✕</button>
                    <div class="download-progress-header">
                        <h4>Скачивание файлов студента</h4>
                        <span class="download-progress-text">0 / ${files.length}</span>
                    </div>
                    <div class="download-progress-bar">
                        <div class="download-progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="download-progress-details">
                        <span class="current-file">Готово к скачиванию...</span>
                    </div>
                `;
                
                // Добавляем прогресс-бар в main-area
                const mainArea = document.querySelector('.main-area');
                if (mainArea) {
                    mainArea.appendChild(progressContainer);
                }
                
                // Добавляем обработчик отмены
                const cancelBtn = progressContainer.querySelector('#download-cancel-btn');
                let isCancelled = false;
                
                cancelBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    showCancelConfirmation(() => {
                        isCancelled = true;
                        showNotification('Скачивание отменено', 'info');
                        
                        // Удаляем прогресс-бар
                        if (progressContainer && progressContainer.parentNode) {
                            progressContainer.parentNode.removeChild(progressContainer);
                        }
                    });
                });
                
                showNotification(`Начинаем скачивание ${files.length} файлов студента ${studentName} в выбранную папку...`, 'info');
                
                let downloadedCount = 0;
                let errorCount = 0;

                for (const file of files) {
                    // Проверяем отмену перед каждым файлом
                    if (isCancelled) {
                        console.log('❌ Скачивание отменено пользователем');
                        break;
                    }
                    
                    try {
                        const token = document.getElementById('moodle-token')?.value;
                        await downloadFileToFolder(file.fileurl || file.url, file.filename || file.name, studentName, downloadFolder, token);
                        downloadedCount++;
                        
                        // Обновляем прогресс-бар
                        const progressFill = progressContainer.querySelector('.download-progress-fill');
                        const progressText = progressContainer.querySelector('.download-progress-text');
                        const currentFile = progressContainer.querySelector('.current-file');
                        
                        if (progressFill && progressText && currentFile) {
                            const progress = (downloadedCount / files.length) * 100;
                            progressFill.style.width = `${progress}%`;
                            progressText.textContent = `${downloadedCount} / ${files.length}`;
                            currentFile.textContent = `Скачиваем: ${file.filename || file.name}`;
                        }
                        
                        // Небольшая задержка между скачиваниями
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        console.error(`❌ Ошибка при скачивании файла ${file.filename}:`, error);
                        errorCount++;
                    }
                }

                // Удаляем прогресс-бар только если не была отмена
                if (!isCancelled && progressContainer && progressContainer.parentNode) {
                    progressContainer.parentNode.removeChild(progressContainer);
                }
                
                if (isCancelled) {
                    showNotification(`⏹️ Скачивание отменено. Скачано файлов: ${downloadedCount}`, 'info');
                } else if (errorCount === 0) {
                    showNotification(`✅ Все ${downloadedCount} файлов студента ${studentName} успешно скачаны в папку!`, 'success');
                } else {
                    showNotification(`⚠️ Скачано ${downloadedCount} файлов, ошибок: ${errorCount}`, 'warning');
                }
                
            } catch (error) {
                console.error('Ошибка при выборе папки:', error);
                showNotification('Ошибка при выборе папки для скачивания', 'error');
            }
        }
        /**
         * Функция для скачивания файла с задержкой и обработкой ошибок
         */
        async function downloadFileWithDelay(fileUrl, fileName, studentName) {
            return new Promise((resolve, reject) => {
                try {
                    console.log(`📥 Скачивание файла: ${fileName} (студент: ${studentName})`);
                    
                    // Создаем ссылку для скачивания
                    const a = document.createElement('a');
                    a.href = fileUrl;
                    a.download = `${studentName}_${fileName}`;
                    a.style.display = 'none';
                    
                    // Добавляем в DOM и кликаем
                    document.body.appendChild(a);
                    a.click();
                    
                    // Удаляем ссылку
                    document.body.removeChild(a);
                    
                    console.log(`✅ Файл ${fileName} отправлен на скачивание`);
                    resolve();
                    
                } catch (error) {
                    console.error(`❌ Ошибка при скачивании файла ${fileName}:`, error);
                    reject(error);
                }
            });
        }

        /**
         * Функция для скачивания файла в указанную папку
         */
        async function downloadFileToFolder(fileUrl, fileName, studentName, downloadFolder) {
            try {
                console.log(`📥 Скачивание файла: ${fileName} (студент: ${studentName}) в папку: ${downloadFolder}`);
                
                // Используем Electron API для прямого скачивания в папку
                const result = await window.electronAPI.downloadFileToFolder(fileUrl, fileName, studentName, downloadFolder);
                
                if (result.success) {
                    console.log(`✅ Файл ${fileName} успешно скачан в папку: ${result.filePath}`);
                    return result;
                } else {
                    throw new Error(result.error || 'Неизвестная ошибка скачивания');
                }
                
            } catch (error) {
                console.error(`❌ Ошибка при скачивании файла ${fileName}:`, error);
                throw error;
            }
        }

    </script>
</body>
</html> 